<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½—é©¬3å¤©æ—…è¡Œä½“éªŒè§„åˆ’å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: white;
            overflow: hidden;
            height: 100vh;
        }
        
        #container {
            display: flex;
            width: 100vw;
            height: 100vh;
        }
        
        /* å·¦ä¾§èŠå¤©é¢æ¿ */
        #chatSidebar {
            width: 420px;
            height: 100vh;
            background: rgba(20, 25, 45, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
        }
        
        #chatHeader {
            padding: 25px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }
        
        .profile-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .profile-info {
            flex: 1;
        }
        
        .profile-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .profile-details {
            font-size: 12px;
            opacity: 0.9;
        }
        
        /* è¡Œç¨‹ç¼–ç åŒºåŸŸ */
        .itinerary-section {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .itinerary-title {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #4ecdc4;
        }
        
        .itinerary-code {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #00ff88;
            border: 1px solid rgba(0, 255, 136, 0.3);
            margin-bottom: 10px;
        }
        
        .itinerary-items {
            max-height: 150px;
            overflow-y: auto;
        }
        
        .itinerary-item {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 5px;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .remove-item {
            background: rgba(255, 71, 87, 0.7);
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            cursor: pointer;
        }
        
        #chatMessages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            scroll-behavior: smooth;
        }
        
        #chatInputArea {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* å³ä¾§æ§åˆ¶é¢æ¿ */
        #controlSidebar {
            width: 380px;
            height: 100vh;
            background: rgba(20, 25, 45, 0.95);
            backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            padding: 25px;
            overflow-y: auto;
        }
        
        /* ä¸­é—´åœ°å›¾åŒºåŸŸ */
        #mapArea {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        .map-info {
            position: absolute;
            top: 70px;
            left: 20px;
            background: rgba(20, 25, 45, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            z-index: 150;
            min-width: 200px;
        }
        
        .map-info h4 {
            color: #4ecdc4;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .map-info p {
            font-size: 12px;
            margin-bottom: 4px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        #map3D {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: opacity 0.8s ease;
            background: radial-gradient(circle at center, #2c3e50 0%, #1a252f 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #map2D {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #2d5a3d 0%, #1a3d2e 50%, #0f2419 100%);
            opacity: 0;
            transition: opacity 0.8s ease;
            overflow: hidden;
        }
        
        /* 3å¤©è·¯çº¿æ˜¾ç¤º */
        .day-route {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .day-route.active {
            opacity: 1;
        }
        
        .route-line {
            position: absolute;
            height: 3px;
            background: linear-gradient(90deg, transparent, #00ff88, transparent);
            border-radius: 2px;
            animation: routeFlow 3s infinite;
            z-index: 70;
        }
        
        @keyframes routeFlow {
            0% { box-shadow: 0 0 5px rgba(0, 255, 136, 0.3); }
            50% { box-shadow: 0 0 15px rgba(0, 255, 136, 0.8); }
            100% { box-shadow: 0 0 5px rgba(0, 255, 136, 0.3); }
        }
        
        .day-marker {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            z-index: 85;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .day1-marker { background: #ff6b6b; }
        .day2-marker { background: #4ecdc4; }
        .day3-marker { background: #45b7d1; }
        
        .day-marker:hover {
            transform: scale(1.2);
            box-shadow: 0 0 20px rgba(255,255,255,0.5);
        }
        
        /* åœ°å›¾æ§åˆ¶é¢æ¿ */
        .map-day-controls {
            position: absolute;
            top: 80px;
            right: 20px;
            background: rgba(20, 25, 45, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            z-index: 150;
        }
        
        .day-control-btn {
            display: block;
            width: 100%;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 8px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .day-control-btn:last-child {
            margin-bottom: 0;
        }
        
        .day-control-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
        }
        
        .day-control-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .map-placeholder {
            text-align: center;
            color: rgba(255,255,255,0.6);
            font-size: 18px;
        }
        
        /* æ¶ˆæ¯æ ·å¼ */
        .message {
            margin: 15px 0;
            padding: 15px 20px;
            border-radius: 20px;
            max-width: 90%;
            animation: messageSlide 0.4s ease-out;
            line-height: 1.6;
        }
        
        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .ai-message {
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin-right: auto;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .user-message {
            background: linear-gradient(135deg, #43cea2, #185a9d);
            margin-left: auto;
            text-align: right;
            box-shadow: 0 8px 25px rgba(67, 206, 162, 0.3);
        }
        
        /* Ask Uniloco ç‰¹æ®Šæ¶ˆæ¯æ ·å¼ */
        .uniloco-message {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            margin-right: auto;
            box-shadow: 0 8px 25px rgba(155, 89, 182, 0.3);
            border-left: 4px solid #e74c3c;
        }
        
        .uniloco-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .uniloco-logo {
            width: 24px;
            height: 24px;
            background: #e74c3c;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            font-size: 12px;
        }
        
        /* æ§åˆ¶é¢æ¿æ ·å¼ */
        .control-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .section-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #4ecdc4;
        }
        
        .category-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .category-btn {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 15px 10px;
            border-radius: 12px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
        }
        
        .category-btn:hover {
            background: linear-gradient(135deg, #667eea, #764ba2);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .category-btn.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }
        
        #chatInput {
            width: 100%;
            padding: 15px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(255,255,255,0.1);
            color: white;
            outline: none;
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        #chatInput::placeholder {
            color: rgba(255,255,255,0.6);
        }
        
        #chatInput:focus {
            border: 1px solid #667eea;
            background: rgba(255,255,255,0.15);
            box-shadow: 0 0 25px rgba(102, 126, 234, 0.3);
        }
        
        /* åœ°å›¾æ ‡è®° */
        .user-location-2d {
            position: absolute;
            width: 16px;
            height: 16px;
            background: #ff4757;
            border: 3px solid white;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            animation: pulse 2s infinite;
            box-shadow: 0 0 15px rgba(255, 71, 87, 0.6);
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 71, 87, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
        }
        
        .activity-marker-2d {
            position: absolute;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            z-index: 80;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            opacity: 0.7;
        }
        
        .activity-marker-2d:hover {
            transform: scale(1.3);
            z-index: 90;
            box-shadow: 0 6px 20px rgba(255,255,255,0.4);
        }
        
        .activity-marker-2d.highlighted {
            opacity: 1;
            transform: scale(1.2);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.8);
            z-index: 85;
        }
        
        .activity-marker-2d.in-itinerary {
            border-color: #00ff88;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.8);
            opacity: 1;
        }
        
        /* æœç´¢ç»“æœ - åˆ†ç±»å‹æ˜¾ç¤º */
        .result-category {
            margin-bottom: 20px;
        }
        
        .result-category-title {
            font-size: 14px;
            font-weight: bold;
            color: #4ecdc4;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .result-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .result-card:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }
        
        .result-card.script-experience {
            border-left: 4px solid #9b59b6;
        }
        
        .result-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .result-emoji {
            font-size: 18px;
            margin-right: 10px;
        }
        
        .result-title {
            font-weight: bold;
            font-size: 14px;
            flex: 1;
        }
        
        .result-details {
            font-size: 12px;
            color: rgba(255,255,255,0.8);
            line-height: 1.4;
            margin-bottom: 8px;
        }
        
        .result-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .action-btn {
            background: linear-gradient(135deg, #43cea2, #185a9d);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(67, 206, 162, 0.4);
        }
        
        .action-btn.website-btn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }
        
        .action-btn.add-btn {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: black;
            font-weight: bold;
        }
        
        .action-btn.ask-uniloco {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .result-tags {
            display: flex;
            gap: 5px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .result-tag {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }
        
        /* åœ°å›¾åˆ‡æ¢æŒ‰é’® */
        .map-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(20, 25, 45, 0.95);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            z-index: 200;
        }
        
        .map-toggle:hover {
            background: linear-gradient(135deg, #667eea, #764ba2);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        /* æ—¶é—´é€‰æ‹©æ ·å¼ */
        .time-selection-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .day-selector, .time-slot-selector {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 12px 15px;
            border-radius: 12px;
            font-size: 13px;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .day-selector:focus, .time-slot-selector:focus {
            border: 1px solid #667eea;
            background: rgba(255,255,255,0.15);
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
        }
        
        .day-selector option, .time-slot-selector option {
            background: #1a1a2e;
            color: white;
        }
        
        .confirm-time-btn {
            width: 100%;
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            border: none;
            color: black;
            padding: 15px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .confirm-time-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4);
        }
        
        .confirm-time-btn:disabled {
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.5);
            cursor: not-allowed;
        }
        
        .itinerary-timeline {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .timeline-day {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .timeline-day:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .day-header {
            font-weight: bold;
            color: #4ecdc4;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .time-slot {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            font-size: 12px;
        }
        
        .time-slot .time {
            color: #feca57;
            font-weight: bold;
            min-width: 70px;
        }
        
        .time-slot .activity {
            color: rgba(255, 255, 255, 0.9);
        }
    </style>
</head>
<body>
    <div id="container">
        <!-- å·¦ä¾§èŠå¤©é¢æ¿ -->
        <div id="chatSidebar">
            <div id="chatHeader">
                <h2>ğŸ¤– Unilocoæ—…è¡Œè§„åˆ’å¸ˆ</h2>
                <div class="user-profile">
                    <div class="profile-avatar">ğŸ§³</div>
                    <div class="profile-info">
                        <div class="profile-name">ç‹¬è¡Œæ—…äºº</div>
                        <div class="profile-details">ğŸ“ Rome | ğŸ—“ï¸ 1-3Day | ğŸœ Street Food | ğŸ‘¤ Single | ğŸ­ Cultural</div>
                    </div>
                </div>
            </div>
            
            <!-- è¡Œç¨‹ç¼–ç åŒºåŸŸ -->
            <div class="itinerary-section">
                <div class="itinerary-title">ğŸ—“ï¸ æˆ‘çš„è¡Œç¨‹å®‰æ’</div>
                <div class="itinerary-code" id="itineraryCode">IT-ROME-2025-001</div>
                <div class="itinerary-items" id="itineraryItems">
                    <div style="text-align: center; color: rgba(255,255,255,0.5); font-size: 12px; padding: 20px;">
                        æš‚æ— å®‰æ’é¡¹ç›®<br>
                        <small>é€‰æ‹©æœåŠ¡å¹¶ç‚¹å‡»"åŠ å…¥è¡Œç¨‹"</small>
                    </div>
                </div>
            </div>
            
            <div id="chatMessages">
                <div class="message ai-message">
                    ğŸ¯ æ¬¢è¿æ¥åˆ°ç½—é©¬ï¼æˆ‘æ˜¯ä½ çš„ä¸“å±AIæ—…è¡Œè§„åˆ’å¸ˆã€‚
                    <br><br>
                    æˆ‘çœ‹åˆ°ä½ æ˜¯ç‹¬è‡ªæ—…è¡Œ1-3å¤©ï¼Œå–œæ¬¢è¡—å¤´ç¾é£Ÿå’Œæ–‡åŒ–ä½“éªŒã€‚ä½œä¸ºå•äººæ—…è¡Œè€…åº”è¯¥æ›´å–œæ¬¢é«˜è´¨é‡çš„ä¸ªäººä½“éªŒã€‚
                    <br><br>
                    å³ä¾§æœ‰å››ç§ä½“éªŒç±»å‹ä¾›ä½ é€‰æ‹©ï¼Œå‘Šè¯‰æˆ‘ä½ æƒ³å°è¯•ä»€ä¹ˆå§ï¼
                    <br><br>
                    ğŸ’¡ <em>é€‰æ‹©ä½“éªŒåå¯ç›´æ¥åŠ å…¥ä½ çš„è¡Œç¨‹å®‰æ’</em>
                </div>
            </div>
            
            <div id="chatInputArea">
                <input type="text" id="chatInput" placeholder="å‘Šè¯‰æˆ‘ä½ æƒ³è¦ä»€ä¹ˆä½“éªŒ...">
            </div>
        </div>
        
        <!-- ä¸­é—´åœ°å›¾åŒºåŸŸ -->
        <div id="mapArea">
            <button class="map-toggle" id="mapToggleBtn">ğŸŒ åˆ‡æ¢2Dåœ°å›¾</button>
            
            <!-- åœ°å›¾ä¿¡æ¯é¢æ¿ -->
            <div class="map-info">
                <h4>ğŸ“ ç½—é©¬å†å²ä¸­å¿ƒåŒº</h4>
                <p>ğŸ—ºï¸ æ€»é¢ç§¯: çº¦3.2å…¬é‡ŒÂ²</p>
                <p>â±ï¸ æ­¥è¡Œç©¿è¶Š: 45-60åˆ†é’Ÿ</p>
                <p>ğŸš‡ åœ°é“è¦†ç›–: Açº¿ã€Bçº¿</p>
                <p>ğŸ“Œ å·²æ ‡è®°: <span id="markerCount">9</span> ä¸ªæ¨èåœ°ç‚¹</p>
            </div>
            
            <div id="map3D">
                <div class="map-placeholder">
                    ğŸŒ 3Dç½—é©¬åŸå¸‚è§†å›¾<br>
                    <small>æµ®åŠ¨çš„å…‰ç‚¹ä»£è¡¨å„ç§ä½“éªŒæœåŠ¡</small>
                </div>
            </div>
            
            <div id="map2D">
                <div class="user-location-2d" title="ä½ çš„ä½ç½® - ç½—é©¬å¸‚ä¸­å¿ƒ"></div>
                
                <!-- ç¬¬1å¤©è·¯çº¿ -->
                <div class="day-route active" id="day1Route">
                    <!-- æ–—å…½åœºåˆ°å¤ç½—é©¬é—å€ -->
                    <div class="route-line" style="left: 70%; top: 50%; width: 15%; transform: rotate(45deg);"></div>
                    <!-- å¤ç½—é©¬é—å€åˆ°ä¸‡ç¥æ®¿ -->
                    <div class="route-line" style="left: 55%; top: 40%; width: 20%; transform: rotate(-30deg);"></div>
                    <!-- ä¸‡ç¥æ®¿åˆ°SPA -->
                    <div class="route-line" style="left: 45%; top: 35%; width: 12%; transform: rotate(-45deg);"></div>
                    
                    <div class="day-marker day1-marker" style="left: 70%; top: 50%;" title="æ–—å…½åœº">ğŸ›ï¸</div>
                    <div class="day-marker day1-marker" style="left: 80%; top: 45%;" title="å¤ç½—é©¬é—å€">ğŸº</div>
                    <div class="day-marker day1-marker" style="left: 55%; top: 40%;" title="ä¸‡ç¥æ®¿é¤å…">ğŸ½ï¸</div>
                    <div class="day-marker day1-marker" style="left: 55%; top: 42%;" title="ä¸‡ç¥æ®¿">â›ª</div>
                    <div class="day-marker day1-marker" style="left: 45%; top: 35%;" title="SPAä¸­å¿ƒ">ğŸ’†â€â™€ï¸</div>
                </div>
                
                <!-- ç¬¬2å¤©è·¯çº¿ -->
                <div class="day-route" id="day2Route">
                    <!-- TrastevereåŒºåŸŸè¿çº¿ -->
                    <div class="route-line" style="left: 30%; top: 55%; width: 18%; transform: rotate(20deg);"></div>
                    <!-- åˆ°å¤ç½—é©¬å¹¿åœº -->
                    <div class="route-line" style="left: 45%; top: 50%; width: 15%; transform: rotate(-20deg);"></div>
                    <!-- åˆ°å°ä¼¯æ²³ -->
                    <div class="route-line" style="left: 35%; top: 60%; width: 20%; transform: rotate(70deg);"></div>
                    
                    <div class="day-marker day2-marker" style="left: 30%; top: 55%;" title="çƒ¹é¥ªè¯¾ç¨‹">ğŸ</div>
                    <div class="day-marker day2-marker" style="left: 25%; top: 60%;" title="Trastevereåˆé¤">ğŸ•</div>
                    <div class="day-marker day2-marker" style="left: 50%; top: 45%;" title="å‡¯æ’’è°ƒæŸ¥">ğŸ”</div>
                    <div class="day-marker day2-marker" style="left: 40%; top: 65%;" title="å°ä¼¯æ²³">ğŸŒ…</div>
                    <div class="day-marker day2-marker" style="left: 60%; top: 25%;" title="ç§å¨æ™šé¤">ğŸ‘¨â€ğŸ³</div>
                </div>
                
                <!-- ç¬¬3å¤©è·¯çº¿ -->
                <div class="day-route" id="day3Route">
                    <!-- æ¢µè’‚å†ˆåŒºåŸŸ -->
                    <div class="route-line" style="left: 15%; top: 25%; width: 12%; transform: rotate(90deg);"></div>
                    <!-- åˆ°å¯†å®¤åŒºåŸŸ -->
                    <div class="route-line" style="left: 25%; top: 30%; width: 35%; transform: rotate(45deg);"></div>
                    <!-- åˆ°è®¸æ„¿æ± å’Œè¥¿ç­ç‰™é˜¶ -->
                    <div class="route-line" style="left: 60%; top: 35%; width: 15%; transform: rotate(30deg);"></div>
                    
                    <div class="day-marker day3-marker" style="left: 15%; top: 25%;" title="æ¢µè’‚å†ˆåšç‰©é¦†">ğŸ¨</div>
                    <div class="day-marker day3-marker" style="left: 15%; top: 30%;" title="åœ£å½¼å¾—å¤§æ•™å ‚">â›ª</div>
                    <div class="day-marker day3-marker" style="left: 75%; top: 60%;" title="å¯†å®¤é€ƒè„±">ğŸ—ï¸</div>
                    <div class="day-marker day3-marker" style="left: 65%; top: 35%;" title="è®¸æ„¿æ± ">â›²</div>
                    <div class="day-marker day3-marker" style="left: 70%; top: 30%;" title="è¥¿ç­ç‰™é˜¶">ğŸ“¸</div>
                </div>
            </div>
            
            <!-- åœ°å›¾å¤©æ•°æ§åˆ¶ -->
            <div class="map-day-controls" id="mapDayControls" style="display: none;">
                <button class="day-control-btn active" onclick="showDayRoute(1)">ç¬¬1å¤©è·¯çº¿</button>
                <button class="day-control-btn" onclick="showDayRoute(2)">ç¬¬2å¤©è·¯çº¿</button>
                <button class="day-control-btn" onclick="showDayRoute(3)">ç¬¬3å¤©è·¯çº¿</button>
                <button class="day-control-btn" onclick="showDayRoute(0)">æ˜¾ç¤ºå…¨éƒ¨</button>
            </div>
        </div>
        
        <!-- å³ä¾§æ§åˆ¶é¢æ¿ -->
        <div id="controlSidebar">
            <div class="control-section">
                <div class="section-title">ğŸ¯ ä½“éªŒç±»å‹é€‰æ‹©</div>
                <div class="category-grid">
                    <button class="category-btn" data-category="activity">
                        ğŸª æ´»åŠ¨ä½“éªŒ<br><small>è¿åŠ¨ã€æˆ·å¤–ã€æ–‡åŒ–</small>
                    </button>
                    <button class="category-btn" data-category="script">
                        ğŸ­ å‰§æœ¬ä½“éªŒ<br><small>å¯†å®¤ã€è§’è‰²æ‰®æ¼”</small>
                    </button>
                    <button class="category-btn" data-category="service">
                        ğŸ’¼ æœåŠ¡ä½“éªŒ<br><small>SPAã€ç§å¨ã€æ‘„å½±</small>
                    </button>
                    <button class="category-btn" data-category="itinerary">
                        ğŸ—ºï¸ AIè¡Œç¨‹<br><small>å®Œæ•´è§„åˆ’æ–¹æ¡ˆ</small>
                    </button>
                </div>
            </div>
            
            <div class="control-section" id="timeSelection" style="display: none;">
                <div class="section-title">ğŸ“… é€‰æ‹©ä½“éªŒå¤©æ•°</div>
                <div class="time-selection-grid">
                    <select id="daySelector" class="day-selector">
                        <option value="1">ç¬¬1å¤©</option>
                        <option value="2">ç¬¬2å¤©</option>
                        <option value="3">ç¬¬3å¤©</option>
                    </select>
                    <select id="timeSlotSelector" class="time-slot-selector">
                        <option value="">è¯·é€‰æ‹©æ—¶é—´æ®µ</option>
                        <option value="morning">ğŸŒ… ä¸Šåˆ (9:00-12:00)</option>
                        <option value="afternoon">â˜€ï¸ ä¸‹åˆ (14:00-17:00)</option>
                        <option value="evening">ğŸŒ† å‚æ™š (18:00-21:00)</option>
                    </select>
                </div>
                <button id="confirmTimeBtn" class="confirm-time-btn" style="display: none;">ç¡®è®¤å¤©æ•°å®‰æ’</button>
            </div>
            
            <div class="control-section" id="searchResults" style="display: none;">
                <div class="section-title">ğŸ” æœç´¢ç»“æœ</div>
                <div id="resultsContainer"></div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        var currentMapView = '3D';
        var selectedCategory = null;
        var isTyping = false;
        var currentStep = 'category';
        var itineraryItems = [];
        var selectedDay = null;
        var selectedTimeSlot = null;
        var pendingExperience = null;
        var currentDayView = 1;
        var aiItineraryGenerated = false;
        var suggestedItinerary = null;
        
        // å®Œæ•´æ•°æ® - åŒ…å«ä¸åŒç±»å‹çš„æœåŠ¡
        var allData = {
            // æœåŠ¡ä½“éªŒ
            service: [
                {
                    id: 'spa1',
                    name: 'ç½—é©¬å¤å…¸SPAä¸­å¿ƒ',
                    type: 'service',
                    emoji: 'ğŸ’†â€â™€ï¸',
                    description: 'æ­£å®—ç½—é©¬å¼æ¸©æ³‰æµ´ï¼Œç§å¯†åŒ…é—´ï¼Œå¤å…¸éŸ³ä¹ä¼´å¥',
                    location: 'Via dei Cappuccini, 9',
                    price: 120,
                    duration: '90åˆ†é’Ÿ',
                    rating: 4.9,
                    tags: ['ç§å¯†', 'æ”¾æ¾', 'å¤å…¸'],
                    x: 45, y: 35,
                    color: '#ff7675',
                    unilocoInfo: {
                        highlights: ['å¤ç½—é©¬é£æ ¼è£…æ½¢', 'ç§äººæŒ‰æ‘©å¸ˆ', 'è‰è¯ç²¾æ²¹', 'çƒ­çŸ³ç–—æ³•'],
                        bestTime: 'ä¸‹åˆ2-4ç‚¹äººæµè¾ƒå°‘',
                        tips: 'æå‰é¢„çº¦å¯äº«å—9æŠ˜ä¼˜æƒ ',
                        nearby: ['ä¸‡ç¥æ®¿(æ­¥è¡Œ5åˆ†é’Ÿ)', 'çº³æ²ƒçº³å¹¿åœº(æ­¥è¡Œ8åˆ†é’Ÿ)']
                    }
                },
                {
                    id: 'chef1',
                    name: 'é©¬é‡Œå¥¥ç§å¨å·¥ä½œå®¤',
                    type: 'service',
                    emoji: 'ğŸ‘¨â€ğŸ³',
                    description: 'å­¦ä¹ åˆ¶ä½œæ­£å®—æ„å¤§åˆ©é¢ï¼Œä¸€å¯¹ä¸€æ•™å­¦',
                    location: 'Via del Corso, 123',
                    price: 85,
                    duration: '120åˆ†é’Ÿ',
                    rating: 4.8,
                    tags: ['ä¸€å¯¹ä¸€', 'æ•™å­¦', 'ç¾é£Ÿ'],
                    x: 60, y: 25,
                    color: '#fdcb6e',
                    unilocoInfo: {
                        highlights: ['ç±³å…¶æ—ä¸»å¨äº²æˆ', 'æ„å¼å®¶åº­ç§˜æ–¹', 'å¯å¸¦èµ°é£Ÿè°±', 'å°ç­æˆè¯¾'],
                        bestTime: 'ä¸Šåˆ10-12ç‚¹ä½“éªŒæœ€ä½³',
                        tips: 'ç©¿ç€å›´è£™å’Œèˆ’é€‚é‹å­',
                        nearby: ['è¥¿ç­ç‰™é˜¶(æ­¥è¡Œ3åˆ†é’Ÿ)', 'ç‰¹è±ç»´å–·æ³‰(æ­¥è¡Œ7åˆ†é’Ÿ)']
                    }
                }
            ],
            
            // å‰§æœ¬ä½“éªŒ
            script: [
                {
                    id: 'escape1',
                    name: 'å¤ç½—é©¬å¯†å®¤é€ƒè„±',
                    type: 'script',
                    emoji: 'ğŸ—ï¸',
                    description: 'è§’æ–—å£«ä¸»é¢˜æ²‰æµ¸å¼å¯†å®¤ï¼Œè¿˜åŸå¤ç½—é©¬ç«æŠ€åœº',
                    location: 'Via del Teatro, 12',
                    price: 45,
                    duration: '90åˆ†é’Ÿ',
                    rating: 4.4,
                    tags: ['è§’æ–—å£«', 'å†å²', 'è§£è°œ'],
                    x: 75, y: 60,
                    color: '#6c5ce7',
                    website: 'https://rome-escape.com',
                    unilocoInfo: {
                        highlights: ['æ²‰æµ¸å¼è§’æ–—å£«ä½“éªŒ', 'ä¸“ä¸šæ¼”å‘˜äº’åŠ¨', 'å¤šé‡ç»“å±€è®¾è®¡', 'å›¢é˜Ÿåˆä½œæŒ‘æˆ˜'],
                        bestTime: 'å‚æ™šæ—¶æ®µæ°›å›´æœ€ä½³',
                        tips: 'å»ºè®®2-4äººç»„é˜Ÿï¼Œç©¿ç€èˆ’é€‚è¿åŠ¨è£…',
                        nearby: ['æ–—å…½åœº(æ­¥è¡Œ10åˆ†é’Ÿ)', 'å¤ç½—é©¬é—å€(æ­¥è¡Œ12åˆ†é’Ÿ)']
                    }
                },
                {
                    id: 'mystery1',
                    name: 'å‡¯æ’’è°‹æ€æ¡ˆè°ƒæŸ¥',
                    type: 'script',
                    emoji: 'ğŸ”',
                    description: 'æ‰®æ¼”å¤ç½—é©¬ä¾¦æ¢ï¼Œè°ƒæŸ¥å‡¯æ’’é‡åˆºçœŸç›¸',
                    location: 'Forum Romanum',
                    price: 55,
                    duration: '120åˆ†é’Ÿ',
                    rating: 4.6,
                    tags: ['è§’è‰²æ‰®æ¼”', 'æ¨ç†', 'å†å²'],
                    x: 50, y: 45,
                    color: '#a29bfe',
                    website: 'https://rome-escape.com',
                    unilocoInfo: {
                        highlights: ['å®åœ°å¤ç½—é©¬é—å€æ¢ç´¢', 'å†å²å­¦å®¶å¯¼æ¸¸', 'å¤šæ¡è°ƒæŸ¥çº¿ç´¢', 'äº’åŠ¨æ¨ç†ç¯èŠ‚'],
                        bestTime: 'ä¸Šåˆ9-11ç‚¹å…‰çº¿æœ€ä½³',
                        tips: 'å»ºè®®äº†è§£ä¸€äº›å¤ç½—é©¬å†å²èƒŒæ™¯',
                        nearby: ['å¤ç½—é©¬å¹¿åœº(ç°åœº)', 'å¸•æ‹‰è’‚å°¼å±±(æ­¥è¡Œ5åˆ†é’Ÿ)']
                    }
                }
            ],
            
            // æ´»åŠ¨ä½“éªŒ
            activity: [
                {
                    id: 'cooking1',
                    name: 'æ„å¤§åˆ©çƒ¹é¥ªè¯¾',
                    type: 'activity',
                    emoji: 'ğŸ',
                    description: 'å­¦ä¹ åˆ¶ä½œä¼ ç»Ÿç½—é©¬èœè‚´ï¼ŒåŒ…å«å¸‚åœºé‡‡è´­ä½“éªŒ',
                    location: 'TrastevereåŒº',
                    price: 75,
                    duration: '180åˆ†é’Ÿ',
                    rating: 4.8,
                    tags: ['æ–‡åŒ–', 'ç¾é£Ÿ', 'ä½“éªŒ'],
                    x: 30, y: 55,
                    color: '#ffeaa7',
                    unilocoInfo: {
                        highlights: ['å½“åœ°å¸‚åœºé‡‡è´­', 'ä¼ ç»Ÿå®¶åº­é£Ÿè°±', 'å“å°è‡ªåˆ¶ç¾é£Ÿ', 'ç»“è¯†å½“åœ°äºº'],
                        bestTime: 'ä¸Šåˆ9ç‚¹å¼€å§‹ï¼Œå«åˆé¤',
                        tips: 'ç©ºè…¹å‚åŠ ï¼Œä¼šæœ‰ä¸°ç››åˆé¤',
                        nearby: ['åœ£ç›ä¸½æ•™å ‚(æ­¥è¡Œ2åˆ†é’Ÿ)', 'å°ä¼¯æ²³(æ­¥è¡Œ8åˆ†é’Ÿ)']
                    }
                },
                {
                    id: 'opera1',
                    name: 'ç½—é©¬æ­Œå‰§é™¢ç»å…¸æ¼”å‡º',
                    type: 'activity',
                    emoji: 'ğŸ­',
                    description: 'åœ¨å†å²æ‚ ä¹…çš„ç½—é©¬æ­Œå‰§é™¢æ¬£èµæ„å¤§åˆ©ç»å…¸æ­Œå‰§æˆ–èŠ­è•¾èˆå‰§',
                    location: 'Teatro dell\'Opera di Roma',
                    price: 85,
                    duration: '150åˆ†é’Ÿ',
                    rating: 4.9,
                    tags: ['æ­Œå‰§', 'èˆå‰§', 'æ–‡åŒ–', 'è‰ºæœ¯'],
                    x: 65, y: 35,
                    color: '#a29bfe',
                    phone: '+39 06 481 601',
                    details: 'æ„å¤§åˆ©é¡¶çº§æ­Œå‰§é™¢ï¼Œå¨å°”ç¬¬ã€æ™®å¥‘å°¼ç»å…¸å‰§ç›®ï¼Œä¸–ç•Œçº§æ­Œå”±å®¶æ¼”å‡º',
                    website: 'https://operaroma.it',
                    unilocoInfo: {
                        highlights: ['19ä¸–çºªå†å²å‰§é™¢', 'ä¸–ç•Œçº§æ­Œå”±å®¶', 'æ„å¤§åˆ©ç»å…¸å‰§ç›®', 'åä¸½æœè£…é“å…·'],
                        bestTime: 'æ™šä¸Š8ç‚¹æ¼”å‡ºï¼Œæå‰30åˆ†é’Ÿå…¥åœº',
                        tips: 'å»ºè®®æ­£è£…å‡ºå¸­ï¼Œå¯ç§Ÿç”¨æ­Œå‰§æœ›è¿œé•œ',
                        nearby: ['å…±å’Œå›½å¹¿åœº(æ­¥è¡Œ5åˆ†é’Ÿ)', 'æˆ´å…‹é‡Œå…ˆæµ´åœº(æ­¥è¡Œ8åˆ†é’Ÿ)']
                    }
                },
                {
                    id: 'ballet1',
                    name: 'æ„å¤§åˆ©å›½å®¶èŠ­è•¾èˆå›¢æ¼”å‡º',
                    type: 'activity',
                    emoji: 'ğŸ©°',
                    description: 'è§‚èµæ„å¤§åˆ©å›½å®¶èŠ­è•¾èˆå›¢çš„ç»å…¸ä¸ç°ä»£èŠ­è•¾èˆå‰§',
                    location: 'Teatro Costanzi',
                    price: 65,
                    duration: '120åˆ†é’Ÿ',
                    rating: 4.7,
                    tags: ['èŠ­è•¾', 'èˆè¹ˆ', 'è‰ºæœ¯', 'è¡¨æ¼”'],
                    x: 70, y: 40,
                    color: '#fd79a8',
                    phone: '+39 06 481 601',
                    details: 'ã€Šå¤©é¹…æ¹–ã€‹ã€Šèƒ¡æ¡ƒå¤¹å­ã€‹ç­‰ç»å…¸å‰§ç›®ï¼Œé¡¶çº§èˆè€…ç²¾å½©æ¼”ç»',
                    website: 'https://operaroma.it/balletto',
                    unilocoInfo: {
                        highlights: ['å›½é™…çŸ¥åèˆå›¢', 'ç»å…¸èŠ­è•¾å‰§ç›®', 'ç°ä»£ç¼–èˆä½œå“', 'ç²¾ç¾èˆå°è®¾è®¡'],
                        bestTime: 'å‘¨æœ«æ¼”å‡ºåœºæ¬¡è¾ƒå¤šï¼Œå»ºè®®æå‰é¢„è®¢',
                        tips: 'å‰§é™¢å†…æœ‰ä¸­æ–‡èŠ‚ç›®å•ï¼Œæ¼”å‡ºä¸­é€”æœ‰ä¼‘æ¯',
                        nearby: ['ç‰¹ç±³å°¼è½¦ç«™(æ­¥è¡Œ10åˆ†é’Ÿ)', 'åœ£æ¯å¤§æ•™å ‚(æ­¥è¡Œ12åˆ†é’Ÿ)']
                    }
                }
            ],
            
            // é¤é¥®æ¨è
            dining: [
                {
                    id: 'restaurant1',
                    name: 'Da Armando al Pantheon',
                    type: 'dining',
                    emoji: 'ğŸ½ï¸',
                    description: 'ç™¾å¹´å®¶æ—é¤å…ï¼Œä¼ ç»Ÿç½—é©¬èœï¼Œä¸‡ç¥æ®¿æ—',
                    location: 'Via degli Orfani, 114',
                    price: 45,
                    duration: '90åˆ†é’Ÿ',
                    rating: 4.7,
                    tags: ['ä¼ ç»Ÿ', 'å®¶æ—', 'å†å²'],
                    x: 55, y: 40,
                    color: '#ff6b9d',
                    unilocoInfo: {
                        highlights: ['1961å¹´å¼€ä¸šè‡³ä»Š', 'ä¼ ç»Ÿç½—é©¬èœè‚´', 'æœ¬åœ°äººèšé›†åœ°', 'ä¸‡ç¥æ®¿æœ€ä½³è§‚æ™¯'],
                        bestTime: 'åˆé¤12:30-14:00ï¼Œæ™šé¤19:30-21:30',
                        tips: 'å¼ºçƒˆå»ºè®®é¢„çº¦ï¼Œå°è¯•Cacio e Pepe',
                        nearby: ['ä¸‡ç¥æ®¿(æ­¥è¡Œ1åˆ†é’Ÿ)', 'çº³æ²ƒçº³å¹¿åœº(æ­¥è¡Œ5åˆ†é’Ÿ)']
                    }
                }
            ],
            
            // æ™¯ç‚¹é—¨ç¥¨
            attractions: [
                {
                    id: 'colosseum1',
                    name: 'æ–—å…½åœºå¿«é€Ÿé€šé“ç¥¨',
                    type: 'attraction',
                    emoji: 'ğŸ›ï¸',
                    description: 'å…æ’é˜Ÿé—¨ç¥¨ï¼Œå«è¯­éŸ³å¯¼è§ˆï¼Œåœ°ä¸‹å±‚å‚è§‚',
                    location: 'Piazza del Colosseo',
                    price: 35,
                    duration: '120åˆ†é’Ÿ',
                    rating: 4.9,
                    tags: ['å…æ’é˜Ÿ', 'å¯¼è§ˆ', 'å†å²'],
                    x: 70, y: 50,
                    color: '#74b9ff',
                    booking: 'https://coopculture.it',
                    unilocoInfo: {
                        highlights: ['è·³è¿‡é•¿é˜Ÿç›´æ¥å…¥åœº', 'åœ°ä¸‹å±‚å’Œç«æŠ€åœºå±‚', 'å¤šè¯­è¨€éŸ³é¢‘å¯¼è§ˆ', 'å¤ç½—é©¬é—å€è”ç¥¨'],
                        bestTime: 'æ—©ä¸Š8:30å¼€é—¨æ—¶äººæœ€å°‘',
                        tips: 'å»ºè®®è´­ä¹°åŒ…å«å¤ç½—é©¬é—å€çš„è”ç¥¨',
                        nearby: ['å¤ç½—é©¬é—å€(æ­¥è¡Œ3åˆ†é’Ÿ)', 'å›å£«å¦ä¸å‡¯æ—‹é—¨(æ­¥è¡Œ2åˆ†é’Ÿ)']
                    }
                }
            ]
        };
        
        // åˆå§‹åŒ–
        function init() {
            console.log('å¼€å§‹åˆå§‹åŒ–...');
            createMap();
            bindEvents();
            showWelcome();
        }
        
        // åˆ›å»ºåœ°å›¾æ ‡è®°
        function createMap() {
            var map = document.getElementById('map2D');
            var markerCount = 0;
            
            // éå†æ‰€æœ‰ç±»å‹çš„æ•°æ®
            for (var category in allData) {
                var items = allData[category];
                for (var i = 0; i < items.length; i++) {
                    var item = items[i];
                    var marker = document.createElement('div');
                    marker.className = 'activity-marker-2d';
                    marker.style.backgroundColor = item.color;
                    marker.style.left = item.x + '%';
                    marker.style.top = item.y + '%';
                    marker.innerHTML = item.emoji;
                    marker.title = item.name;
                    marker.setAttribute('data-id', item.id);
                    marker.setAttribute('data-category', category);
                    map.appendChild(marker);
                    markerCount++;
                }
            }
            
            // æ›´æ–°æ ‡è®°æ•°é‡
            document.getElementById('markerCount').textContent = markerCount;
        }
        
        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // ç±»åˆ«æŒ‰é’®
            var btns = document.querySelectorAll('.category-btn');
            for (var i = 0; i < btns.length; i++) {
                btns[i].onclick = function() {
                    selectCategory(this.getAttribute('data-category'));
                };
            }
            
            // åœ°å›¾åˆ‡æ¢æŒ‰é’®
            document.getElementById('mapToggleBtn').onclick = function() {
                toggleMap();
            };
            
            // èŠå¤©è¾“å…¥æ¡†
            var chatInput = document.getElementById('chatInput');
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // æ—¶é—´é€‰æ‹©ç›¸å…³äº‹ä»¶
            document.getElementById('daySelector').addEventListener('change', updateTimeSelection);
            document.getElementById('timeSlotSelector').addEventListener('change', updateTimeSelection);
            document.getElementById('confirmTimeBtn').addEventListener('click', confirmTimeSelection);
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('activity-marker-2d')) {
                    var itemId = e.target.getAttribute('data-id');
                    var category = e.target.getAttribute('data-category');
                    showItemDetails(itemId, category);
                }
            });
        }
        
        // Ask Uniloco åŠŸèƒ½
        function askUniloco(itemId) {
            // æŸ¥æ‰¾ç‰©å“
            var item = findItemById(itemId);
            if (!item || !item.unilocoInfo) {
                addUnilocoMessage('æŠ±æ­‰ï¼Œæš‚æ—¶æ²¡æœ‰å…³äºè¿™ä¸ªé¡¹ç›®çš„è¯¦ç»†ä¿¡æ¯ã€‚');
                return;
            }
            
            var info = item.unilocoInfo;
            var response = `
                <div class="uniloco-header">
                    <div class="uniloco-logo">U</div>
                    Uniloco ä¸“ä¸šç‚¹è¯„ - ${item.name}
                </div>
                
                <strong>ğŸŒŸ äº®ç‚¹ç‰¹è‰²ï¼š</strong><br>
                ${info.highlights.map(h => 'â€¢ ' + h).join('<br>')}<br><br>
                
                <strong>â° æœ€ä½³æ—¶é—´ï¼š</strong><br>
                ${info.bestTime}<br><br>
                
                <strong>ğŸ’¡ ä¸“ä¸šå»ºè®®ï¼š</strong><br>
                ${info.tips}<br><br>
                
                <strong>ğŸ“ å‘¨è¾¹æ™¯ç‚¹ï¼š</strong><br>
                ${info.nearby.map(n => 'â€¢ ' + n).join('<br>')}<br><br>
                
                <small style="opacity: 0.8;">ğŸ’ Unilocoè®¤è¯ - åŸºäºæœ¬åœ°ä¸“å®¶å’ŒçœŸå®ç”¨æˆ·ä½“éªŒ</small>
            `;
            
            addUnilocoMessage(response);
        }
        
        // æ·»åŠ  Uniloco æ¶ˆæ¯
        function addUnilocoMessage(message) {
            var messagesContainer = document.getElementById('chatMessages');
            var messageDiv = document.createElement('div');
            messageDiv.className = 'message uniloco-message';
            messageDiv.innerHTML = message;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // é€‰æ‹©ç±»åˆ«
        function selectCategory(category) {
            selectedCategory = category;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            var btns = document.querySelectorAll('.category-btn');
            for (var i = 0; i < btns.length; i++) {
                btns[i].classList.remove('selected');
            }
            document.querySelector('[data-category="' + category + '"]').classList.add('selected');
            
            // å¤„ç†ä¸åŒç±»å‹çš„é€‰æ‹©
            if (category === 'itinerary') {
                generateAIItinerary();
            } else {
                // æ˜¾ç¤ºæ—¶é—´é€‰æ‹©é¢æ¿
                showTimeSelection(category);
            }
            
            // é«˜äº®åœ°å›¾ä¸Šå¯¹åº”çš„æ ‡è®°
            highlightMapMarkers(category);
            
            // æ·»åŠ AIæ¶ˆæ¯
            addAIMessage(getCategoryResponse(category));
        }
        
        // æ˜¾ç¤ºæ—¶é—´é€‰æ‹©
        function showTimeSelection(category) {
            var timeSection = document.getElementById('timeSelection');
            var resultsSection = document.getElementById('searchResults');
            
            timeSection.style.display = 'block';
            resultsSection.style.display = 'none';
            
            // é‡ç½®é€‰æ‹©
            document.getElementById('daySelector').value = '1';
            document.getElementById('timeSlotSelector').value = '';
            document.getElementById('confirmTimeBtn').style.display = 'none';
            
            selectedDay = null;
            selectedTimeSlot = null;
        }
        
        // è·å–ç±»åˆ«å›åº”
        function getCategoryResponse(category) {
            var responses = {
                'activity': 'ğŸª æ´»åŠ¨ä½“éªŒï¼å¾ˆå¥½çš„é€‰æ‹©ã€‚ç½—é©¬æœ‰ä¸°å¯Œçš„æ–‡åŒ–æ´»åŠ¨ï¼Œè¯·é€‰æ‹©æƒ³è¦å‚åŠ æ´»åŠ¨çš„å…·ä½“å¤©æ•°ï¼Ÿ',
                'script': 'ğŸ­ å‰§æœ¬ä½“éªŒï¼å¤ªæ£’äº†ï¼Œæ²‰æµ¸å¼çš„å†å²ä½“éªŒä¼šå¾ˆç²¾å½©ã€‚è¯·é€‰æ‹©æƒ³è¦ä½“éªŒå‰§æœ¬çš„å¤©æ•°ï¼Ÿ',
                'service': 'ğŸ’¼ æœåŠ¡ä½“éªŒï¼äº«å—é«˜å“è´¨çš„ä¸ªäººæœåŠ¡ä¼šè®©æ—…è¡Œæ›´ç‰¹åˆ«ã€‚è¯·é€‰æ‹©æƒ³è¦äº«å—æœåŠ¡çš„å¤©æ•°ï¼Ÿ',
                'itinerary': 'ğŸ—ºï¸ è®©æˆ‘ä¸ºä½ åˆ¶å®šä¸€ä¸ªå®Œæ•´çš„3å¤©ç½—é©¬è¡Œç¨‹ï¼æˆ‘ä¼šæ ¹æ®ä½ çš„Iäººç‰¹è´¨ï¼Œå®‰æ’ä¸€äº›æ·±åº¦è€Œä¸æ‹¥æŒ¤çš„ä½“éªŒ...'
            };
            return responses[category];
        }
        
        // æ˜¾ç¤ºç±»åˆ«ç»“æœ
        function showCategoryResults(category) {
            var resultsSection = document.getElementById('searchResults');
            var container = document.getElementById('resultsContainer');
            
            resultsSection.style.display = 'block';
            container.innerHTML = '';
            
            if (allData[category]) {
                var categoryData = allData[category];
                for (var i = 0; i < categoryData.length; i++) {
                    var item = categoryData[i];
                    container.appendChild(createResultCard(item));
                }
            }
        }
        
        // åˆ›å»ºç»“æœå¡ç‰‡
        function createResultCard(item) {
            var card = document.createElement('div');
            card.className = 'result-card';
            if (item.type === 'script') {
                card.classList.add('script-experience');
            }
            
            var tagsHtml = '';
            if (item.tags) {
                for (var i = 0; i < item.tags.length; i++) {
                    tagsHtml += '<span class="result-tag">' + item.tags[i] + '</span>';
                }
            }
            
            var actionsHtml = '';
            if (item.website) {
                actionsHtml += '<button class="action-btn website-btn" onclick="window.open(\'' + item.website + '\', \'_blank\')">å®˜ç½‘</button>';
            }
            if (item.booking) {
                actionsHtml += '<button class="action-btn website-btn" onclick="window.open(\'' + item.booking + '\', \'_blank\')">é¢„è®¢</button>';
            }
            
            // æ·»åŠ  Ask Uniloco æŒ‰é’®
            if (item.unilocoInfo) {
                actionsHtml += '<button class="action-btn ask-uniloco" onclick="askUniloco(\'' + item.id + '\')">Ask Uniloco</button>';
            }
            
            // æ·»åŠ  Detail æŒ‰é’®
            actionsHtml += '<button class="action-btn" onclick="showDetailPage(\'' + item.id + '\')" style="background: linear-gradient(135deg, #f39c12, #e67e22);">Detail</button>';
            
            actionsHtml += '<button class="action-btn add-btn" onclick="selectExperienceTime(\'' + item.id + '\')">é€‰æ‹©æ—¶é—´</button>';
            
            card.innerHTML = `
                <div class="result-header">
                    <span class="result-emoji">${item.emoji}</span>
                    <span class="result-title">${item.name}</span>
                </div>
                <div class="result-details">
                    ${item.description}<br>
                    ğŸ“ ${item.location} | ğŸ’° â‚¬${item.price} | â° ${item.duration} | â­ ${item.rating}
                </div>
                <div class="result-tags">${tagsHtml}</div>
                <div class="result-actions">${actionsHtml}</div>
            `;
            
            return card;
        }
        
        // ç”ŸæˆAIè¡Œç¨‹
        function generateAIItinerary() {
            var resultsSection = document.getElementById('searchResults');
            var container = document.getElementById('resultsContainer');
            
            resultsSection.style.display = 'block';
            container.innerHTML = '';
            
            // æ˜¾ç¤ºåœ°å›¾æ§åˆ¶é¢æ¿
            document.getElementById('mapDayControls').style.display = 'block';
            
            // åˆ›å»ºAIè¡Œç¨‹å»ºè®®
            suggestedItinerary = [
                {
                    day: 1,
                    title: 'ç¬¬ä¸€å¤© - å¤å…¸ç½—é©¬',
                    startLocation: 'Colosseoåœ°é“ç«™',
                    endLocation: 'Via dei Cappuccini SPAä¸­å¿ƒ',
                    totalDuration: 'çº¦8å°æ—¶',
                    walkingDistance: '2.5å…¬é‡Œ',
                    activities: [
                        { 
                            time: '09:00-11:15', 
                            activity: 'æ–—å…½åœºå¿«é€Ÿé€šé“å‚è§‚', 
                            emoji: 'ğŸ›ï¸', 
                            id: 'colosseum1', 
                            selected: true, 
                            location: 'Piazza del Colosseo, 1', 
                            duration: '2å°æ—¶15åˆ†é’Ÿ',
                            phone: '+39 06 3996 7700',
                            details: 'å…æ’é˜Ÿé—¨ç¥¨ï¼Œå«ä¸­æ–‡è¯­éŸ³å¯¼è§ˆï¼Œåœ°ä¸‹å±‚å’Œç«æŠ€åœºå±‚å‚è§‚',
                            price: 'â‚¬35',
                            website: 'https://coopculture.it'
                        },
                        { 
                            time: '11:30-12:45', 
                            activity: 'å¤ç½—é©¬é—å€æ¼«æ­¥', 
                            emoji: 'ğŸš¶â€â™‚ï¸', 
                            id: 'forum_walk', 
                            selected: true, 
                            location: 'Via della Salaria Vecchia, 5/6', 
                            duration: '1å°æ—¶15åˆ†é’Ÿ',
                            phone: '+39 06 3996 7700',
                            details: 'å¸å›½å¹¿åœºæ ¸å¿ƒåŒºåŸŸï¼Œå‡¯æ’’ç¥åº™ã€ç»´æ–¯å¡”ç¥åº™ç­‰é‡è¦é—å€',
                            price: 'åŒ…å«åœ¨æ–—å…½åœºè”ç¥¨ä¸­',
                            website: 'https://coopculture.it'
                        },
                        { 
                            time: '13:00-14:30', 
                            activity: 'Da Armando al Pantheon åˆé¤', 
                            emoji: 'ğŸ½ï¸', 
                            id: 'restaurant1', 
                            selected: true, 
                            location: 'Via degli Orfani, 114', 
                            duration: '1å°æ—¶30åˆ†é’Ÿ',
                            phone: '+39 06 6880 3034',
                            details: '1961å¹´å¼€ä¸šå®¶æ—é¤å…ï¼Œä¼ ç»Ÿç½—é©¬èœï¼Œä¸‡ç¥æ®¿æœ€ä½³è§‚æ™¯ä½ç½®',
                            price: 'â‚¬45-60',
                            website: 'https://armandoalpantheon.it'
                        },
                        { 
                            time: '15:00-15:45', 
                            activity: 'ä¸‡ç¥æ®¿æ·±åº¦å‚è§‚', 
                            emoji: 'â›ª', 
                            id: 'pantheon', 
                            selected: true, 
                            location: 'Piazza della Rotonda', 
                            duration: '45åˆ†é’Ÿ',
                            phone: '+39 06 6830 0230',
                            details: 'ä¿å­˜æœ€å®Œå¥½çš„å¤ç½—é©¬å»ºç­‘ï¼Œå®Œç¾ç©¹é¡¶è®¾è®¡ï¼Œæ‹‰æ–å°”å¢“',
                            price: 'å…è´¹',
                            website: 'https://pantheonroma.com'
                        },
                        { 
                            time: '17:00-18:30', 
                            activity: 'ç½—é©¬å¤å…¸SPAæ”¾æ¾', 
                            emoji: 'ğŸ’†â€â™€ï¸', 
                            id: 'spa1', 
                            selected: true, 
                            location: 'Via dei Cappuccini, 9', 
                            duration: '1å°æ—¶30åˆ†é’Ÿ',
                            phone: '+39 06 4201 5555',
                            details: 'å¤ç½—é©¬é£æ ¼æ¸©æ³‰æµ´ï¼Œç§äººæŒ‰æ‘©å¸ˆï¼Œè‰è¯ç²¾æ²¹æŠ¤ç†',
                            price: 'â‚¬120',
                            website: 'https://hotelderussiespĞ°.com'
                        }
                    ]
                },
                {
                    day: 2,
                    title: 'ç¬¬äºŒå¤© - æ–‡åŒ–ä½“éªŒ',
                    startLocation: 'TrastevereåŒºå¸‚åœº',
                    endLocation: 'Via del Corsoç§å¨å·¥ä½œå®¤',
                    totalDuration: 'çº¦9.5å°æ—¶',
                    walkingDistance: '3.8å…¬é‡Œ',
                    activities: [
                        { 
                            time: '10:00-13:00', 
                            activity: 'æ„å¤§åˆ©çƒ¹é¥ªè¯¾ç¨‹', 
                            emoji: 'ğŸ', 
                            id: 'cooking1', 
                            selected: true, 
                            location: 'TrastevereåŒºä¼ ç»Ÿå¸‚åœº', 
                            duration: '3å°æ—¶(å«å¸‚åœºé‡‡è´­)',
                            phone: '+39 06 5833 3971',
                            details: 'å½“åœ°å¸‚åœºé‡‡è´­æ–°é²œé£Ÿæï¼Œå­¦ä¹ ä¼ ç»Ÿå®¶åº­é£Ÿè°±ï¼Œåˆ¶ä½œæ‰‹å·¥æ„å¤§åˆ©é¢',
                            price: 'â‚¬75',
                            website: 'https://cookingclassesrome.com'
                        },
                        { 
                            time: '13:00-14:00', 
                            activity: 'TrastevereåŒºåˆé¤', 
                            emoji: 'ğŸ•', 
                            id: 'trastevere_lunch', 
                            selected: true, 
                            location: 'Via di San Francesco a Ripa', 
                            duration: '1å°æ—¶',
                            phone: '+39 06 5812 5435',
                            details: 'æ­£å®—è¡—å¤´å°é£Ÿï¼šSupplÃ¬ç‚¸é¥­å›¢ã€Pizza al Taglioã€å½“åœ°å°é…’é¦†',
                            price: 'â‚¬15-25',
                            website: 'https://trasteverestreetfood.it'
                        },
                        { 
                            time: '15:30-17:30', 
                            activity: 'å‡¯æ’’è°‹æ€æ¡ˆè°ƒæŸ¥å‰§æœ¬', 
                            emoji: 'ğŸ”', 
                            id: 'mystery1', 
                            selected: true, 
                            location: 'Forum Romanumå…¥å£', 
                            duration: '2å°æ—¶',
                            phone: '+39 06 6992 4151',
                            details: 'æ²‰æµ¸å¼å†å²å‰§æœ¬ï¼Œä¸“ä¸šæ¼”å‘˜æŒ‡å¯¼ï¼Œå®åœ°å¤ç½—é©¬é—å€æ¢ç´¢',
                            price: 'â‚¬55',
                            website: 'https://rome-mysteries.com'
                        },
                        { 
                            time: '18:00-18:45', 
                            activity: 'å°ä¼¯æ²³ç•”æ•£æ­¥', 
                            emoji: 'ğŸŒ…', 
                            id: 'river_walk', 
                            selected: false, 
                            location: 'Ponte Sant\'Angeloæ¡¥', 
                            duration: '45åˆ†é’Ÿ',
                            phone: 'æ— éœ€é¢„çº¦',
                            details: 'æµªæ¼«æ—¥è½æ—¶åˆ†ï¼Œåœ£å¤©ä½¿æ¡¥åˆ°äººæ°‘å¹¿åœºæ²³å²¸æ­¥é“',
                            price: 'å…è´¹',
                            website: 'https://roma.it/lungotevere'
                        },
                        { 
                            time: '19:30-21:30', 
                            activity: 'ç§å¨æ™šé¤ä½“éªŒ', 
                            emoji: 'ğŸ‘¨â€ğŸ³', 
                            id: 'chef1', 
                            selected: true, 
                            location: 'Via del Corso, 123', 
                            duration: '2å°æ—¶',
                            phone: '+39 06 6919 0572',
                            details: 'ç±³å…¶æ—ä¸»å¨é©¬é‡Œå¥¥ç§äººå·¥ä½œå®¤ï¼Œä¸€å¯¹ä¸€æ„å¼æ–™ç†æ•™å­¦',
                            price: 'â‚¬85',
                            website: 'https://chefmario-rome.com'
                        }
                    ]
                },
                {
                    day: 3,
                    title: 'ç¬¬ä¸‰å¤© - æ·±åº¦æ¢ç´¢',
                    startLocation: 'Ottavianoåœ°é“ç«™',
                    endLocation: 'Spagnaåœ°é“ç«™',
                    totalDuration: 'çº¦9å°æ—¶',
                    walkingDistance: '4.2å…¬é‡Œ',
                    activities: [
                        { 
                            time: '09:30-12:00', 
                            activity: 'æ¢µè’‚å†ˆåšç‰©é¦†', 
                            emoji: 'ğŸ¨', 
                            id: 'vatican_museum', 
                            selected: true, 
                            location: 'Viale Vaticano, 00165', 
                            duration: '2å°æ—¶30åˆ†é’Ÿ',
                            phone: '+39 06 6988 4676',
                            details: 'è¥¿æ–¯å»·æ•™å ‚ç±³å¼€æœ—åŸºç½—å£ç”»ï¼Œæ‹‰æ–å°”ç”»å®¤ï¼Œå¤å¸Œè…Šé›•å¡‘æ”¶è—',
                            price: 'â‚¬17(å…æ’é˜Ÿç¥¨â‚¬27)',
                            website: 'https://vatican.va'
                        },
                        { 
                            time: '12:00-13:30', 
                            activity: 'åœ£å½¼å¾—å¤§æ•™å ‚', 
                            emoji: 'â›ª', 
                            id: 'st_peter', 
                            selected: true, 
                            location: 'Piazza San Pietro', 
                            duration: '1å°æ—¶30åˆ†é’Ÿ',
                            phone: '+39 06 6988 3731',
                            details: 'ç±³å¼€æœ—åŸºç½—ã€Šåœ£æ¯æ€œå­ã€‹ï¼Œè´å°¼å°¼åä¸½è£…é¥°ï¼Œå¯é€‰ç™»é¡¶åœ†é¡¶',
                            price: 'å…è´¹(ç™»é¡¶â‚¬10)',
                            website: 'https://vatican.va'
                        },
                        { 
                            time: '14:30-16:00', 
                            activity: 'å¤ç½—é©¬å¯†å®¤é€ƒè„±', 
                            emoji: 'ğŸ—ï¸', 
                            id: 'escape1', 
                            selected: true, 
                            location: 'Via del Teatro, 12', 
                            duration: '1å°æ—¶30åˆ†é’Ÿ',
                            phone: '+39 06 4542 8899',
                            details: 'è§’æ–—å£«ä¸»é¢˜æ²‰æµ¸å¼å¯†å®¤ï¼Œä¸“ä¸šæ¼”å‘˜äº’åŠ¨ï¼Œå¤šé‡ç»“å±€è®¾è®¡',
                            price: 'â‚¬45',
                            website: 'https://rome-escape.com'
                        },
                        { 
                            time: '17:00-17:30', 
                            activity: 'ç‰¹è±ç»´å–·æ³‰è®¸æ„¿', 
                            emoji: 'â›²', 
                            id: 'trevi', 
                            selected: true, 
                            location: 'Piazza di Trevi', 
                            duration: '30åˆ†é’Ÿ',
                            phone: 'æ— éœ€é¢„çº¦',
                            details: 'ä¸–ç•Œæœ€è‘—åè®¸æ„¿æ± ï¼Œå·´æ´›å…‹è‰ºæœ¯æ°ä½œï¼ŒæŠ•å¸è®¸æ„¿ä¼ ç»Ÿ',
                            price: 'å…è´¹',
                            website: 'https://roma.it/fontana-trevi'
                        },
                        { 
                            time: '18:30-19:00', 
                            activity: 'è¥¿ç­ç‰™é˜¶å‘Šåˆ«', 
                            emoji: 'ğŸ“¸', 
                            id: 'spanish_steps', 
                            selected: false, 
                            location: 'Piazza di Spagna', 
                            duration: '30åˆ†é’Ÿ',
                            phone: 'æ— éœ€é¢„çº¦',
                            details: 'è‘—åç”µå½±å–æ™¯åœ°ï¼Œæ˜¥å­£æœé¹ƒèŠ±ç››å¼€ï¼Œé«˜ç«¯è´­ç‰©åŒºåŸŸ',
                            price: 'å…è´¹',
                            website: 'https://roma.it/scalinata-trinita'
                        }
                    ]
                }
            ];
            
            // æ˜¾ç¤ºè¡Œç¨‹é¢„è§ˆå’Œç¡®è®¤ç•Œé¢
            var previewDiv = document.createElement('div');
            previewDiv.className = 'ai-itinerary-preview';
            previewDiv.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 style="color: #4ecdc4; margin-bottom: 10px;">ğŸ¤– Unilocoæ¨èè¡Œç¨‹</h3>
                    <p style="font-size: 12px; color: rgba(255,255,255,0.7);">
                        ä¸ºä½ å®šåˆ¶çš„3å¤©ç½—é©¬æ·±åº¦ä½“éªŒï¼Œå¯ä»¥è°ƒæ•´å’Œç¡®è®¤
                    </p>
                </div>
                <div id="itineraryPreview"></div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="action-btn" onclick="confirmAIItinerary()" style="background: linear-gradient(135deg, #00ff88, #00cc6a); color: black; margin-right: 10px;">
                        âœ… ç¡®è®¤ä½¿ç”¨æ­¤è¡Œç¨‹
                    </button>
                    <button class="action-btn" onclick="customizeItinerary()" style="background: linear-gradient(135deg, #667eea, #764ba2); margin-right: 10px;">
                        âœï¸ æˆ‘è¦è°ƒæ•´
                    </button>
                    <button class="action-btn" onclick="showItineraryAdjustment()" style="background: linear-gradient(135deg, #ff6b6b, #ee5a52);">
                        ğŸ”„ è¡Œç¨‹è°ƒæ•´
                    </button>
                </div>
            `;
            
            container.appendChild(previewDiv);
            
            // æ¸²æŸ“è¡Œç¨‹é¢„è§ˆ
            renderItineraryPreview();
            
            aiItineraryGenerated = true;
        }
        
        // æ¸²æŸ“è¡Œç¨‹é¢„è§ˆ
        function renderItineraryPreview() {
            var previewContainer = document.getElementById('itineraryPreview');
            if (!previewContainer) return;
            
            previewContainer.innerHTML = '';
            
            for (var i = 0; i < suggestedItinerary.length; i++) {
                var dayData = suggestedItinerary[i];
                var dayDiv = document.createElement('div');
                dayDiv.className = 'itinerary-timeline';
                
                var dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                dayHeader.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 14px; font-weight: bold;">${dayData.title}</span>
                        <button class="day-control-btn" onclick="showDayRoute(${dayData.day})" style="font-size: 10px; padding: 4px 8px;">
                            æŸ¥çœ‹åœ°å›¾
                        </button>
                    </div>
                    ${dayData.startLocation ? `
                        <div style="font-size: 11px; color: rgba(255,255,255,0.8); margin-bottom: 4px;">
                            ğŸš‡ èµ·ç‚¹: ${dayData.startLocation} â†’ ç»ˆç‚¹: ${dayData.endLocation}
                        </div>
                        <div style="font-size: 11px; color: rgba(255,255,255,0.7); margin-bottom: 8px;">
                            â±ï¸ æ€»æ—¶é•¿: ${dayData.totalDuration} | ğŸš¶â€â™‚ï¸ æ­¥è¡Œè·ç¦»: ${dayData.walkingDistance}
                        </div>
                    ` : ''}
                `;
                dayDiv.appendChild(dayHeader);
                
                for (var j = 0; j < dayData.activities.length; j++) {
                    var activity = dayData.activities[j];
                    var activityDiv = document.createElement('div');
                    activityDiv.className = 'time-slot';
                    activityDiv.style.opacity = activity.selected ? '1' : '0.5';
                    activityDiv.innerHTML = `
                        <div class="time" style="color: #feca57; font-weight: bold; min-width: 90px; font-size: 11px;">
                            ${activity.time}
                        </div>
                        <div class="activity" style="color: rgba(255, 255, 255, 0.9); flex: 1;">
                            <div style="margin-bottom: 4px; font-weight: bold;">
                                ${activity.emoji} ${activity.activity}
                                <button onclick="showActivityDetails('${activity.id}')" 
                                        style="margin-left: 8px; background: #667eea; 
                                               border: none; color: white; 
                                               padding: 2px 6px; border-radius: 4px; font-size: 9px; cursor: pointer;">
                                    è¯¦æƒ…
                                </button>
                                <button onclick="toggleActivity(${dayData.day}, ${j})" 
                                        style="margin-left: 5px; background: ${activity.selected ? '#ff4757' : '#00ff88'}; 
                                               border: none; color: ${activity.selected ? 'white' : 'black'}; 
                                               padding: 2px 6px; border-radius: 4px; font-size: 10px; cursor: pointer;">
                                    ${activity.selected ? 'ç§»é™¤' : 'æ·»åŠ '}
                                </button>
                            </div>
                            ${activity.location ? `<div style="font-size: 9px; color: rgba(255,255,255,0.6); margin-bottom: 2px;">ğŸ“ ${activity.location}</div>` : ''}
                            ${activity.duration ? `<div style="font-size: 9px; color: rgba(255,255,255,0.6);">â±ï¸ ${activity.duration}</div>` : ''}
                        </div>
                    `;
                    dayDiv.appendChild(activityDiv);
                }
                
                previewContainer.appendChild(dayDiv);
            }
        }
        
        // æ˜¾ç¤ºè¯¦æƒ…é¡µé¢
        function showDetailPage(itemId) {
            var item = findItemById(itemId);
            if (!item) {
                addAIMessage('æŠ±æ­‰ï¼Œæ²¡æœ‰æ‰¾åˆ°è¯¥é¡¹ç›®çš„è¯¦ç»†ä¿¡æ¯ã€‚');
                return;
            }
            
            // ç›®å‰åªæ˜¯åœ¨èŠå¤©ä¸­æ˜¾ç¤ºï¼Œä¹‹åå¯ä»¥æ”¹ä¸ºè·³è½¬åˆ°å¤–éƒ¨ç½‘é¡µ
            var message = `
                <strong>ğŸ“‹ è¯¦æƒ…é¡µé¢ - ${item.name}</strong><br><br>
                
                <strong>ğŸ“ è¯¦ç»†æè¿°ï¼š</strong><br>
                ${item.description}<br><br>
                
                <strong>ğŸ“ ä½ç½®ï¼š</strong> ${item.location}<br>
                <strong>ğŸ’° ä»·æ ¼ï¼š</strong> â‚¬${item.price}<br>
                <strong>â° æ—¶é•¿ï¼š</strong> ${item.duration}<br>
                <strong>â­ è¯„åˆ†ï¼š</strong> ${item.rating}/5.0<br><br>
                
                ${item.tags ? '<strong>ğŸ·ï¸ æ ‡ç­¾ï¼š</strong> ' + item.tags.join(', ') + '<br><br>' : ''}
                
                <small style="opacity: 0.8;">ğŸ’¡ è¿™é‡Œæœªæ¥ä¼šè·³è½¬åˆ°è¯¦ç»†çš„é¢„è®¢é¡µé¢</small>
            `;
            
            addAIMessage(message);
        }
        
        // æ˜¾ç¤ºæ´»åŠ¨è¯¦æƒ…
        function showActivityDetails(activityId) {
            var activityDetails = {
                'colosseum1': {
                    name: 'æ–—å…½åœºå¿«é€Ÿé€šé“å‚è§‚',
                    description: 'è·³è¿‡é•¿é˜Ÿç›´æ¥å…¥åœºï¼Œæ¢ç´¢è¿™åº§å¤ç½—é©¬æœ€å£®è§‚çš„å»ºç­‘ã€‚åŒ…å«åœ°ä¸‹å±‚å‚è§‚ï¼Œäº†è§£è§’æ–—å£«çš„ç”Ÿæ´»ã€‚',
                    highlights: ['å…æ’é˜Ÿå…¥åœº', 'å«è¯­éŸ³å¯¼è§ˆ', 'åœ°ä¸‹å±‚å‚è§‚', 'ç«æŠ€åœºå±‚ä½“éªŒ'],
                    duration: 'çº¦2å°æ—¶',
                    tips: 'å»ºè®®æ—©ä¸Šå‚è§‚ï¼Œå…‰çº¿æœ€ä½³ä¸”äººæµè¾ƒå°‘'
                },
                'forum_walk': {
                    name: 'å¤ç½—é©¬é—å€æ¼«æ­¥',
                    description: 'åœ¨å¤ç½—é©¬å¸å›½çš„å¿ƒè„åœ°å¸¦æ¼«æ­¥ï¼Œæ¬£èµå‡¯æ’’å¤§å¸ã€å¥¥å¤æ–¯éƒ½ç­‰å†å²äººç‰©æ›¾ç»æ´»åŠ¨çš„åœ°æ–¹ã€‚',
                    highlights: ['å¸å›½å¹¿åœºé—å€', 'å‡¯æ’’ç¥åº™', 'ç»´æ–¯å¡”ç¥åº™', 'æå›¾æ–¯å‡¯æ—‹é—¨'],
                    duration: 'çº¦1.5å°æ—¶',
                    tips: 'ä¸æ–—å…½åœºè”ç¥¨æ›´ä¼˜æƒ ï¼Œå»ºè®®ç©¿èˆ’é€‚æ­¥è¡Œé‹'
                },
                'restaurant1': {
                    name: 'Da Armando al Pantheon åˆé¤',
                    description: 'è¿™å®¶1961å¹´å¼€ä¸šçš„å®¶æ—é¤å…æ˜¯ä¸‡ç¥æ®¿æ—çš„éšè—å®çŸ³ï¼Œæä¾›æœ€æ­£å®—çš„ç½—é©¬ä¼ ç»Ÿèœè‚´ã€‚',
                    highlights: ['å®¶æ—ç§˜åˆ¶é£Ÿè°±', 'æœ¬åœ°äººèšé›†åœ°', 'ä¸‡ç¥æ®¿æœ€ä½³è§‚æ™¯', 'ä¼ ç»Ÿç½—é©¬èœ'],
                    duration: 'çº¦1.5å°æ—¶',
                    tips: 'å¿…å°Cacio e Pepeå’ŒCarbonaraï¼Œå»ºè®®æå‰é¢„è®¢'
                },
                'pantheon': {
                    name: 'ä¸‡ç¥æ®¿æ·±åº¦å‚è§‚',
                    description: 'å‚è§‚è¿™åº§ä¿å­˜æœ€å®Œå¥½çš„å¤ç½—é©¬å»ºç­‘ï¼Œæ¬£èµå…¶å®Œç¾çš„åœ†é¡¶è®¾è®¡å’Œç¥ç§˜çš„å¤©çª—ã€‚',
                    highlights: ['å…è´¹å…¥åœº', 'å®Œç¾ç©¹é¡¶', 'æ‹‰æ–å°”å¢“', 'å»ºç­‘å¥‡è¿¹'],
                    duration: 'çº¦45åˆ†é’Ÿ',
                    tips: 'æ­£åˆæ—¶åˆ†é˜³å…‰ä»å¤©çª—ç›´å°„ä¸‹æ¥ï¼Œæ™¯è±¡æœ€ä¸ºå£®è§‚'
                },
                'spa1': {
                    name: 'ç½—é©¬å¤å…¸SPAæ”¾æ¾',
                    description: 'åœ¨å¤ç½—é©¬é£æ ¼çš„è±ªåSPAä¸­å¿ƒäº«å—ä¼ ç»Ÿæ¸©æ³‰æµ´å’Œä¸“ä¸šæŒ‰æ‘©ï¼Œæ´—å»ä¸€å¤©çš„ç–²åŠ³ã€‚',
                    highlights: ['å¤ç½—é©¬é£æ ¼è£…æ½¢', 'æ¸©æ³‰æµ´ä½“éªŒ', 'èŠ³ç–—æŒ‰æ‘©', 'ç§å¯†ç¯å¢ƒ'],
                    duration: 'çº¦90åˆ†é’Ÿ',
                    tips: 'ä¸‹åˆæ—¶æ®µè¾ƒä¸ºå®‰é™ï¼Œä½“éªŒæ„Ÿæ›´ä½³'
                },
                'cooking1': {
                    name: 'æ„å¤§åˆ©çƒ¹é¥ªè¯¾ç¨‹',
                    description: 'åœ¨TrastevereåŒºçš„æœ¬åœ°å¸‚åœºé‡‡è´­æ–°é²œé£Ÿæï¼Œç„¶åå­¦ä¹ åˆ¶ä½œæ­£å®—çš„æ„å¤§åˆ©é¢å’Œç½—é©¬èœã€‚',
                    highlights: ['å¸‚åœºé‡‡è´­ä½“éªŒ', 'ä¼ ç»Ÿå®¶åº­é£Ÿè°±', 'äº²æ‰‹åˆ¶ä½œ', 'å“å°æˆæœ'],
                    duration: 'çº¦3å°æ—¶',
                    tips: 'åŒ…å«ä¸°ç››åˆé¤ï¼Œå»ºè®®ç©ºè…¹å‚åŠ '
                },
                'trastevere_lunch': {
                    name: 'TrastevereåŒºåˆé¤',
                    description: 'åœ¨ç½—é©¬æœ€å…·æ³¢è¥¿ç±³äºšé£æƒ…çš„TrastevereåŒºäº«ç”¨åœ°é“çš„è¡—å¤´ç¾é£Ÿå’Œå½“åœ°å°é£Ÿã€‚',
                    highlights: ['å½“åœ°è¡—å¤´ç¾é£Ÿ', 'æ³¢è¥¿ç±³äºšæ°›å›´', 'çŸ³æ¿è·¯æ¼«æ­¥', 'æœ¬åœ°å°åº—'],
                    duration: 'çº¦1å°æ—¶',
                    tips: 'SupplÃ¬ï¼ˆç‚¸é¥­å›¢ï¼‰å’ŒPizza al Taglioæ˜¯å¿…å°ç¾é£Ÿ'
                },
                'mystery1': {
                    name: 'å‡¯æ’’è°‹æ€æ¡ˆè°ƒæŸ¥å‰§æœ¬',
                    description: 'åŒ–èº«å¤ç½—é©¬ä¾¦æ¢ï¼Œåœ¨çœŸå®çš„å¤ç½—é©¬é—å€ä¸­è°ƒæŸ¥å‡¯æ’’å¤§å¸é‡åˆºæ¡ˆï¼Œé€šè¿‡äº’åŠ¨æ¨ç†æ­å¼€å†å²è°œå›¢ã€‚',
                    highlights: ['å®åœ°é—å€æ¢ç´¢', 'è§’è‰²æ‰®æ¼”', 'å†å²äº’åŠ¨', 'æ¨ç†è§£è°œ'],
                    duration: 'çº¦2å°æ—¶',
                    tips: 'äº†è§£ä¸€äº›å¤ç½—é©¬å†å²ä¼šè®©ä½“éªŒæ›´æœ‰è¶£'
                },
                'river_walk': {
                    name: 'å°ä¼¯æ²³ç•”æ•£æ­¥',
                    description: 'æ²¿ç€æµç»ç½—é©¬çš„æ¯äº²æ²³æ¼«æ­¥ï¼Œæ¬£èµä¸¤å²¸çš„å†å²å»ºç­‘å’Œæµªæ¼«çš„å¤•é˜³æ™¯è‰²ã€‚',
                    highlights: ['æ²³ç•”é£å…‰', 'å†å²æ¡¥æ¢', 'å¤•é˜³ç¾æ™¯', 'æµªæ¼«æ°›å›´'],
                    duration: 'çº¦45åˆ†é’Ÿ',
                    tips: 'é»„æ˜æ—¶åˆ†æœ€ç¾ï¼Œé€‚åˆæ‹ç…§ç•™å¿µ'
                },
                'chef1': {
                    name: 'ç§å¨æ™šé¤ä½“éªŒ',
                    description: 'åœ¨ä¸“ä¸šä¸»å¨çš„ç§äººå·¥ä½œå®¤äº«ç”¨å®šåˆ¶æ™šé¤ï¼Œå­¦ä¹ æ„å¤§åˆ©çƒ¹é¥ªæŠ€å·§å¹¶å“å°ç²¾è‡´æ–™ç†ã€‚',
                    highlights: ['ç§äººå®šåˆ¶', 'ä¸»å¨æ•™å­¦', 'ç²¾è‡´æ–™ç†', 'ä¸€å¯¹ä¸€æœåŠ¡'],
                    duration: 'çº¦2å°æ—¶',
                    tips: 'å¯ä»¥å­¦åˆ°å›å®¶åä¹Ÿèƒ½å¤åˆ¶çš„ç®€å•æŠ€å·§'
                },
                'vatican_museum': {
                    name: 'æ¢µè’‚å†ˆåšç‰©é¦†',
                    description: 'æ¢ç´¢ä¸–ç•Œä¸Šæœ€é‡è¦çš„è‰ºæœ¯æ”¶è—ä¹‹ä¸€ï¼ŒåŒ…æ‹¬è¥¿æ–¯å»·æ•™å ‚çš„ç±³å¼€æœ—åŸºç½—å£ç”»ã€‚',
                    highlights: ['è¥¿æ–¯å»·æ•™å ‚', 'æ‹‰æ–å°”ç”»å®¤', 'å¤å¸Œè…Šé›•å¡‘', 'å®—æ•™è‰ºæœ¯'],
                    duration: 'çº¦2.5å°æ—¶',
                    tips: 'å»ºè®®è´­ä¹°å…æ’é˜Ÿé—¨ç¥¨ï¼Œå‘¨ä¸‰ä¸Šåˆäººæµæœ€å°‘'
                },
                'st_peter': {
                    name: 'åœ£å½¼å¾—å¤§æ•™å ‚',
                    description: 'å‚è§‚å¤©ä¸»æ•™ä¸–ç•Œçš„ä¸­å¿ƒï¼Œæ¬£èµç±³å¼€æœ—åŸºç½—çš„ã€Šåœ£æ¯æ€œå­ã€‹å’Œè´å°¼å°¼çš„åä¸½è£…é¥°ã€‚',
                    highlights: ['ç±³å¼€æœ—åŸºç½—ä½œå“', 'ç™»é¡¶åœ†é¡¶', 'åœ£å½¼å¾—å¢“', 'å®—æ•™åœ£åœ°'],
                    duration: 'çº¦1.5å°æ—¶',
                    tips: 'ç™»é¡¶éœ€è¦é¢å¤–è´­ç¥¨ï¼Œä¿¯ç°ç½—é©¬å…¨æ™¯å€¼å¾—ä¸€è¯•'
                },
                'escape1': {
                    name: 'å¤ç½—é©¬å¯†å®¤é€ƒè„±',
                    description: 'åœ¨è§’æ–—å£«ä¸»é¢˜çš„æ²‰æµ¸å¼å¯†å®¤ä¸­è§£è°œï¼Œä½“éªŒå¤ç½—é©¬ç«æŠ€åœºçš„ç´§å¼ åˆºæ¿€æ°›å›´ã€‚',
                    highlights: ['è§’æ–—å£«ä¸»é¢˜', 'æ²‰æµ¸å¼ä½“éªŒ', 'å›¢é˜Ÿåˆä½œ', 'å¤šé‡ç»“å±€'],
                    duration: 'çº¦90åˆ†é’Ÿ',
                    tips: 'å»ºè®®2-4äººç»„é˜Ÿï¼Œç©¿ç€èˆ’é€‚çš„è¿åŠ¨è£…'
                },
                'trevi': {
                    name: 'ç‰¹è±ç»´å–·æ³‰è®¸æ„¿',
                    description: 'åœ¨ä¸–ç•Œæœ€è‘—åçš„è®¸æ„¿æ± æŠ•ä¸‹ç¡¬å¸ï¼Œä¼ è¯´è¿™æ ·å°±èƒ½å†æ¬¡å›åˆ°ç½—é©¬ã€‚',
                    highlights: ['å·´æ´›å…‹æ°ä½œ', 'è®¸æ„¿ä¼ ç»Ÿ', 'å¤œæ™¯ç…§æ˜', 'æµªæ¼«æ°›å›´'],
                    duration: 'çº¦30åˆ†é’Ÿ',
                    tips: 'å‚æ™šæ—¶åˆ†ç¯å…‰æ•ˆæœæœ€ä½³ï¼Œè®°å¾—å‡†å¤‡ç¡¬å¸è®¸æ„¿'
                },
                'spanish_steps': {
                    name: 'è¥¿ç­ç‰™é˜¶å‘Šåˆ«',
                    description: 'åœ¨è¿™ä¸ªè‘—åçš„ç”µå½±å–æ™¯åœ°ç»“æŸç½—é©¬ä¹‹æ—…ï¼Œååœ¨é˜¶ä¸Šå›å‘³ä¸‰å¤©çš„ç¾å¥½æ—¶å…‰ã€‚',
                    highlights: ['ç”µå½±å–æ™¯åœ°', 'äººæ–‡æ™¯è§‚', 'è´­ç‰©åŒºåŸŸ', 'å‘Šåˆ«ä»ªå¼'],
                    duration: 'çº¦30åˆ†é’Ÿ',
                    tips: 'æ˜¥å­£æ—¶é˜¶ä¸Šä¼šå¼€æ»¡æœé¹ƒèŠ±ï¼Œæ˜¯æ‹ç…§çš„æœ€ä½³å­£èŠ‚'
                }
            };
            
            var detail = activityDetails[activityId];
            if (detail) {
                var message = `
                    <strong>ğŸ“ ${detail.name}</strong><br><br>
                    ${detail.description}<br><br>
                    <strong>ğŸŒŸ ä½“éªŒäº®ç‚¹ï¼š</strong><br>
                    ${detail.highlights.map(h => 'â€¢ ' + h).join('<br>')}<br><br>
                    <strong>â° å»ºè®®æ—¶é•¿ï¼š</strong> ${detail.duration}<br><br>
                    <strong>ğŸ’¡ è´´å¿ƒæç¤ºï¼š</strong> ${detail.tips}
                `;
                addAIMessage(message);
            } else {
                addAIMessage('æŠ±æ­‰ï¼Œæš‚æ—¶æ²¡æœ‰è¿™ä¸ªæ´»åŠ¨çš„è¯¦ç»†ä¿¡æ¯ã€‚');
            }
        }
        
        // åˆ‡æ¢æ´»åŠ¨é€‰æ‹©çŠ¶æ€
        function toggleActivity(day, activityIndex) {
            for (var i = 0; i < suggestedItinerary.length; i++) {
                if (suggestedItinerary[i].day === day) {
                    var activity = suggestedItinerary[i].activities[activityIndex];
                    activity.selected = !activity.selected;
                    break;
                }
            }
            renderItineraryPreview();
        }
        
        // ç¡®è®¤AIè¡Œç¨‹
        function confirmAIItinerary() {
            // æ¸…ç©ºå½“å‰è¡Œç¨‹
            itineraryItems = [];
            
            // æ·»åŠ é€‰ä¸­çš„æ´»åŠ¨åˆ°è¡Œç¨‹
            for (var i = 0; i < suggestedItinerary.length; i++) {
                var dayData = suggestedItinerary[i];
                for (var j = 0; j < dayData.activities.length; j++) {
                    var activity = dayData.activities[j];
                    if (activity.selected) {
                        // æŸ¥æ‰¾å¯¹åº”çš„æ•°æ®é¡¹
                        var item = findItemById(activity.id);
                        if (item) {
                            var itemWithTime = Object.assign({}, item);
                            itemWithTime.scheduledDay = dayData.day;
                            itemWithTime.scheduledTime = activity.time;
                            itineraryItems.push(itemWithTime);
                        } else {
                            // åˆ›å»ºè™šæ‹Ÿé¡¹ç›®ï¼ˆå¦‚æ•£æ­¥ç­‰ï¼‰
                            var virtualItem = {
                                id: activity.id,
                                name: activity.activity,
                                emoji: activity.emoji,
                                price: 0,
                                type: 'activity',
                                scheduledDay: dayData.day,
                                scheduledTime: activity.time
                            };
                            itineraryItems.push(virtualItem);
                        }
                    }
                }
            }
            
            updateItineraryDisplay();
            addAIMessage('å®Œç¾ï¼å·²ç¡®è®¤ä½ çš„3å¤©ç½—é©¬è¡Œç¨‹ã€‚æ€»è´¹ç”¨ï¼šâ‚¬' + calculateTotalCost() + 'ã€‚ä½ å¯ä»¥åœ¨å·¦ä¾§æŸ¥çœ‹è¯¦ç»†å®‰æ’ï¼Œåœ°å›¾ä¸Šä¹Ÿæ˜¾ç¤ºäº†æ¯å¤©çš„è·¯çº¿ï¼');
        }
        
        // è‡ªå®šä¹‰è¡Œç¨‹
        function customizeItinerary() {
            addAIMessage('å¥½çš„ï¼ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è°ƒæ•´è¡Œç¨‹ï¼š<br><br>1ï¸âƒ£ ç‚¹å‡»æ´»åŠ¨æ—çš„"ç§»é™¤"/"æ·»åŠ "æŒ‰é’®<br>2ï¸âƒ£ ä»ä½“éªŒç±»å‹ä¸­é€‰æ‹©å…¶ä»–é¡¹ç›®<br>3ï¸âƒ£ è°ƒæ•´å®Œæˆåç‚¹å‡»"ç¡®è®¤ä½¿ç”¨æ­¤è¡Œç¨‹"<br><br>æœ‰ä»€ä¹ˆç‰¹åˆ«æƒ³è¦è°ƒæ•´çš„å—ï¼Ÿ');
        }
        
        // æ˜¾ç¤ºè¡Œç¨‹è°ƒæ•´ç•Œé¢
        function showItineraryAdjustment() {
            addAIMessage('ğŸ¤” çœ‹èµ·æ¥ä½ æƒ³è°ƒæ•´ä¸€ä¸‹è¡Œç¨‹ï¼è®©æˆ‘æ¥å¸®ä½ åˆ†æä¸€ä¸‹ã€‚<br><br>ä½ è§‰å¾—å“ªä¸€å¤©çš„å®‰æ’éœ€è¦è°ƒæ•´å‘¢ï¼Ÿ');
            
            // æ˜¾ç¤ºå¤©æ•°é€‰æ‹©æŒ‰é’®
            setTimeout(function() {
                var adjustmentButtons = `
                    <div style="margin: 15px 0; text-align: center;">
                        <button class="action-btn" onclick="adjustDay(1)" style="margin: 5px; background: linear-gradient(135deg, #ff6b6b, #ee5a52);">
                            ç¬¬1å¤©è°ƒæ•´
                        </button>
                        <button class="action-btn" onclick="adjustDay(2)" style="margin: 5px; background: linear-gradient(135deg, #4ecdc4, #44a08d);">
                            ç¬¬2å¤©è°ƒæ•´
                        </button>
                        <button class="action-btn" onclick="adjustDay(3)" style="margin: 5px; background: linear-gradient(135deg, #45b7d1, #3498db);">
                            ç¬¬3å¤©è°ƒæ•´
                        </button>
                    </div>
                `;
                
                var messagesContainer = document.getElementById('chatMessages');
                var messageDiv = document.createElement('div');
                messageDiv.className = 'message ai-message';
                messageDiv.innerHTML = adjustmentButtons;
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 500);
        }
        
        // è°ƒæ•´ç‰¹å®šå¤©æ•°çš„è¡Œç¨‹
        function adjustDay(day) {
            var dayTitles = {
                1: 'ç¬¬ä¸€å¤© - å¤å…¸ç½—é©¬',
                2: 'ç¬¬äºŒå¤© - æ–‡åŒ–ä½“éªŒ', 
                3: 'ç¬¬ä¸‰å¤© - æ·±åº¦æ¢ç´¢'
            };
            
            addAIMessage(`ä½ é€‰æ‹©è°ƒæ•´${dayTitles[day]}çš„è¡Œç¨‹ã€‚è®©æˆ‘çœ‹çœ‹è¿™ä¸€å¤©çš„å®‰æ’...<br><br>ğŸ¤” æ˜¯ä¸æ˜¯è§‰å¾—è¿™ä¸ªè¡Œç¨‹å¤ªç´¯äº†ï¼Ÿæ—¶é—´å®‰æ’å¤ªç´§å‡‘ï¼Ÿ`);
            
            setTimeout(function() {
                var responseButtons = `
                    <div style="margin: 15px 0; text-align: center;">
                        <button class="action-btn" onclick="respondToTiredness(${day}, 'yes')" style="margin: 5px; background: linear-gradient(135deg, #ff9ff3, #f368e0);">
                            æ˜¯çš„ï¼Œå¤ªç´¯äº†
                        </button>
                        <button class="action-btn" onclick="respondToTiredness(${day}, 'no')" style="margin: 5px; background: linear-gradient(135deg, #74b9ff, #0984e3);">
                            ä¸ä¼šï¼Œè¿˜å¥½
                        </button>
                        <button class="action-btn" onclick="respondToTiredness(${day}, 'change')" style="margin: 5px; background: linear-gradient(135deg, #fdcb6e, #e17055);">
                            æƒ³æ¢å…¶ä»–ä½“éªŒ
                        </button>
                    </div>
                `;
                
                var messagesContainer = document.getElementById('chatMessages');
                var messageDiv = document.createElement('div');
                messageDiv.className = 'message ai-message';
                messageDiv.innerHTML = responseButtons;
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 1000);
        }
        
        // å›åº”ç–²åŠ³ç¨‹åº¦
        function respondToTiredness(day, response) {
            if (response === 'yes') {
                addAIMessage('ğŸ˜Š å“ˆå“ˆå“ˆï¼Œæˆ‘å°±çŸ¥é“ï¼åˆ«æ‹…å¿ƒï¼Œæˆ‘ç»™ä½ å®‰æ’ä¸€ä¸ªä¸é‚£ä¹ˆç´¯çš„è¡Œç¨‹ã€‚è®©æˆ‘é‡æ–°ä¸ºä½ è§„åˆ’...');
                setTimeout(function() {
                    showRelaxedOptions(day);
                }, 1000);
            } else if (response === 'no') {
                addAIMessage('ğŸ’ª çœ‹èµ·æ¥ä½ ä½“åŠ›å¾ˆå¥½ï¼é‚£æˆ‘ä»¬å¯ä»¥åœ¨ç°æœ‰åŸºç¡€ä¸Šæ·»åŠ ä¸€äº›æ›´æœ‰è¶£çš„ä½“éªŒã€‚ä½ æƒ³è¦ä»€ä¹ˆç±»å‹çš„ï¼Ÿ');
                setTimeout(function() {
                    showEnhancementOptions(day);
                }, 1000);
            } else if (response === 'change') {
                addAIMessage('ğŸ¯ æ˜ç™½äº†ï¼è®©æˆ‘ä»¬é‡æ–°é€‰æ‹©è¿™ä¸€å¤©çš„ä½“éªŒç±»å‹ã€‚ä½ æ›´å–œæ¬¢å“ªç§é£æ ¼çš„ä¸€å¤©ï¼Ÿ');
                setTimeout(function() {
                    showStyleOptions(day);
                }, 1000);
            }
        }
        
        // æ˜¾ç¤ºè½»æ¾é€‰é¡¹
        function showRelaxedOptions(day) {
            var message = `
                ğŸŒ¿ å¥½çš„ï¼Œè®©æˆ‘ä¸ºä½ å®‰æ’ä¸€ä¸ªæ›´è½»æ¾çš„ç¬¬${day}å¤©ï¼<br><br>
                æˆ‘æƒ³äº†è§£ä¸€ä¸‹ä½ çš„åå¥½ï¼š<br><br>
                ğŸ“ ä½ æƒ³åœ¨ç½—é©¬çš„å“ªä¸ªåŒºåŸŸå¼€å§‹æ¸¸è§ˆï¼Ÿ<br>
                ğŸ¯ ä½ å¸Œæœ›æ´»åŠ¨åŠå¾„æ§åˆ¶åœ¨å¤šå°‘èŒƒå›´å†…ï¼Ÿ
            `;
            
            addAIMessage(message);
            
            setTimeout(function() {
                var locationButtons = `
                    <div style="margin: 15px 0;">
                        <div style="margin-bottom: 10px; font-weight: bold; color: #4ecdc4;">é€‰æ‹©èµ·å§‹åŒºåŸŸï¼š</div>
                        <button class="action-btn" onclick="selectStartLocation(${day}, 'centro')" style="margin: 3px; font-size: 11px; background: linear-gradient(135deg, #a29bfe, #6c5ce7);">
                            å†å²ä¸­å¿ƒåŒº
                        </button>
                        <button class="action-btn" onclick="selectStartLocation(${day}, 'trastevere')" style="margin: 3px; font-size: 11px; background: linear-gradient(135deg, #fd79a8, #e84393);">
                            TrastevereåŒº
                        </button>
                        <button class="action-btn" onclick="selectStartLocation(${day}, 'vatican')" style="margin: 3px; font-size: 11px; background: linear-gradient(135deg, #fdcb6e, #e17055);">
                            æ¢µè’‚å†ˆåŒºåŸŸ
                        </button>
                        <button class="action-btn" onclick="selectStartLocation(${day}, 'villa')" style="margin: 3px; font-size: 11px; background: linear-gradient(135deg, #00b894, #00a085);">
                            å…¬å›­åˆ«å¢…åŒº
                        </button>
                    </div>
                    <div style="margin: 15px 0;">
                        <div style="margin-bottom: 10px; font-weight: bold; color: #4ecdc4;">æ´»åŠ¨åŠå¾„ï¼š</div>
                        <button class="action-btn" onclick="selectRadius(${day}, '1km')" style="margin: 3px; font-size: 11px; background: linear-gradient(135deg, #55a3ff, #3742fa);">
                            1å…¬é‡Œå†…
                        </button>
                        <button class="action-btn" onclick="selectRadius(${day}, '2km')" style="margin: 3px; font-size: 11px; background: linear-gradient(135deg, #26de81, #20bf6b);">
                            2å…¬é‡Œå†…
                        </button>
                        <button class="action-btn" onclick="selectRadius(${day}, '3km')" style="margin: 3px; font-size: 11px; background: linear-gradient(135deg, #fed330, #f7b731);">
                            3å…¬é‡Œå†…
                        </button>
                    </div>
                `;
                
                var messagesContainer = document.getElementById('chatMessages');
                var messageDiv = document.createElement('div');
                messageDiv.className = 'message ai-message';
                messageDiv.innerHTML = locationButtons;
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 1000);
        }
        
        // é€‰æ‹©èµ·å§‹ä½ç½®
        function selectStartLocation(day, location) {
            var locationNames = {
                'centro': 'å†å²ä¸­å¿ƒåŒº',
                'trastevere': 'TrastevereåŒº',
                'vatican': 'æ¢µè’‚å†ˆåŒºåŸŸ',
                'villa': 'å…¬å›­åˆ«å¢…åŒº'
            };
            
            addAIMessage(`ğŸ‘ å¾ˆå¥½çš„é€‰æ‹©ï¼ä½ é€‰æ‹©äº†${locationNames[location]}ä½œä¸ºèµ·ç‚¹ã€‚ç°åœ¨è¯·é€‰æ‹©ä½ å¸Œæœ›çš„æ´»åŠ¨åŠå¾„èŒƒå›´ã€‚`);
            
            // å­˜å‚¨é€‰æ‹©çš„ä½ç½®
            window.selectedLocation = location;
            window.selectedDay = day;
        }
        
        // é€‰æ‹©æ´»åŠ¨åŠå¾„
        function selectRadius(day, radius) {
            var location = window.selectedLocation;
            var locationNames = {
                'centro': 'å†å²ä¸­å¿ƒåŒº',
                'trastevere': 'TrastevereåŒº',
                'vatican': 'æ¢µè’‚å†ˆåŒºåŸŸ',
                'villa': 'å…¬å›­åˆ«å¢…åŒº'
            };
            
            // å­˜å‚¨é€‰æ‹©çš„åŠå¾„
            window.selectedRadius = radius;
            
            addAIMessage(`âœ¨ å®Œç¾ï¼åŸºäºä½ é€‰æ‹©çš„${locationNames[location]}å’Œ${radius}çš„æ´»åŠ¨èŒƒå›´ï¼Œè®©æˆ‘ä¸ºä½ æ¨èæœ€åˆé€‚çš„è½»æ¾è¡Œç¨‹...<br><br>ğŸ¯ æ ¹æ®ä½ çš„é€‰æ‹©ï¼Œæˆ‘å»ºè®®ï¼š`);
            
            setTimeout(function() {
                generateRelaxedItinerary(day, location, radius);
            }, 1500);
        }
        
        // ç”Ÿæˆè½»æ¾è¡Œç¨‹
        function generateRelaxedItinerary(day, location, radius) {
            var recommendations = getLocationRecommendations(location, radius);
            
            var message = `
                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin: 10px 0;">
                    <h4 style="color: #4ecdc4; margin-bottom: 10px;">ğŸŒŸ ä¸ºä½ å®šåˆ¶çš„è½»æ¾ç¬¬${day}å¤©</h4>
                    
                    <div style="margin-bottom: 15px;">
                        <strong>ğŸ“ èµ·å§‹ä½ç½®ï¼š</strong> ${recommendations.startPoint}<br>
                        <strong>ğŸ¯ æ´»åŠ¨èŒƒå›´ï¼š</strong> ${radius}<br>
                        <strong>â±ï¸ æ€»æ—¶é•¿ï¼š</strong> ${recommendations.totalTime}<br>
                        <strong>ğŸš¶â€â™‚ï¸ æ­¥è¡Œè·ç¦»ï¼š</strong> ${recommendations.walkingDistance}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #feca57;">æ¨èè·¯çº¿ï¼š</strong><br>
                        ${recommendations.route.map(item => `â€¢ ${item}`).join('<br>')}
                    </div>
                    
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="action-btn" onclick="confirmRelaxedItinerary(${day})" style="background: linear-gradient(135deg, #00ff88, #00cc6a); color: black; margin-right: 10px;">
                            âœ… å°±ç”¨è¿™ä¸ªè½»æ¾è¡Œç¨‹
                        </button>
                        <button class="action-btn" onclick="showItineraryAdjustment()" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                            ğŸ”„ é‡æ–°é€‰æ‹©
                        </button>
                    </div>
                </div>
            `;
            
            addAIMessage(message);
        }
        
        // è·å–ä½ç½®æ¨è
        function getLocationRecommendations(location, radius) {
            var recommendations = {
                'centro': {
                    '1km': {
                        startPoint: 'ä¸‡ç¥æ®¿é™„è¿‘',
                        totalTime: '5-6å°æ—¶',
                        walkingDistance: '1.2å…¬é‡Œ',
                        route: [
                            '09:30 ä¸‡ç¥æ®¿å‚è§‚ (30åˆ†é’Ÿ)',
                            '10:15 çº³æ²ƒçº³å¹¿åœºå’–å•¡ (45åˆ†é’Ÿ)',
                            '11:30 é™„è¿‘å°å··æ¼«æ­¥ (30åˆ†é’Ÿ)',
                            '12:30 ä¼ ç»Ÿé¤å…åˆé¤ (90åˆ†é’Ÿ)',
                            '14:30 åœ£è·¯æ˜“æ•™å ‚ (30åˆ†é’Ÿ)',
                            '15:30 å½“åœ°å·¥è‰ºå“åº— (60åˆ†é’Ÿ)'
                        ]
                    },
                    '2km': {
                        startPoint: 'ä¸‡ç¥æ®¿åˆ°ç‰¹è±ç»´å–·æ³‰åŒºåŸŸ',
                        totalTime: '6-7å°æ—¶',
                        walkingDistance: '2.1å…¬é‡Œ',
                        route: [
                            '09:00 ä¸‡ç¥æ®¿å‚è§‚ (45åˆ†é’Ÿ)',
                            '10:15 æ­¥è¡Œè‡³è®¸æ„¿æ±  (25åˆ†é’Ÿ)',
                            '11:00 ç‰¹è±ç»´å–·æ³‰è®¸æ„¿ (30åˆ†é’Ÿ)',
                            '12:00 é™„è¿‘ç²¾å“åº—è´­ç‰© (60åˆ†é’Ÿ)',
                            '13:30 å±‹é¡¶é¤å…åˆé¤ (90åˆ†é’Ÿ)',
                            '15:30 è¥¿ç­ç‰™é˜¶ä¼‘æ¯ (45åˆ†é’Ÿ)'
                        ]
                    },
                    '3km': {
                        startPoint: 'å†å²ä¸­å¿ƒåŒºå…¨è§ˆ',
                        totalTime: '7-8å°æ—¶',
                        walkingDistance: '2.8å…¬é‡Œ',
                        route: [
                            '09:00 ä¸‡ç¥æ®¿åŒºåŸŸ (60åˆ†é’Ÿ)',
                            '10:30 çº³æ²ƒçº³å¹¿åœº (45åˆ†é’Ÿ)',
                            '11:45 å¡æ‹‰ç“¦ä¹”æ•™å ‚ (30åˆ†é’Ÿ)',
                            '13:00 ç²¾è‡´åˆé¤ (90åˆ†é’Ÿ)',
                            '15:00 ç‰¹è±ç»´å–·æ³‰ (30åˆ†é’Ÿ)',
                            '16:00 è¥¿ç­ç‰™é˜¶è´­ç‰© (60åˆ†é’Ÿ)'
                        ]
                    }
                },
                'trastevere': {
                    '1km': {
                        startPoint: 'åœ£ç›ä¸½æ•™å ‚å¹¿åœº',
                        totalTime: '5-6å°æ—¶',
                        walkingDistance: '1.1å…¬é‡Œ',
                        route: [
                            '10:00 åœ£ç›ä¸½æ•™å ‚å‚è§‚ (30åˆ†é’Ÿ)',
                            '10:45 å½“åœ°å¸‚åœºé€›é€› (45åˆ†é’Ÿ)',
                            '12:00 è¡—å¤´å°é£Ÿå“å° (60åˆ†é’Ÿ)',
                            '13:30 æ²³è¾¹å’–å•¡å… (90åˆ†é’Ÿ)',
                            '15:30 æ‰‹å·¥è‰ºå“åº— (45åˆ†é’Ÿ)',
                            '16:30 æ—¥è½æ²³æ™¯ (30åˆ†é’Ÿ)'
                        ]
                    },
                    '2km': {
                        startPoint: 'Trastevereåˆ°å°ä¼¯æ²³',
                        totalTime: '6-7å°æ—¶',
                        walkingDistance: '1.9å…¬é‡Œ',
                        route: [
                            '09:30 Trastevereè€åŸæ¼«æ­¥ (60åˆ†é’Ÿ)',
                            '11:00 å½“åœ°çƒ˜ç„™åŠ (30åˆ†é’Ÿ)',
                            '12:00 ä¼ ç»Ÿåˆé¤ (90åˆ†é’Ÿ)',
                            '14:00 å°ä¼¯æ²³æ­¥é“ (45åˆ†é’Ÿ)',
                            '15:15 æ²³å¯¹å²¸å¸‚åœº (60åˆ†é’Ÿ)',
                            '16:45 å›ç¨‹å’–å•¡ (30åˆ†é’Ÿ)'
                        ]
                    },
                    '3km': {
                        startPoint: 'Trastevereæ·±åº¦æ¢ç´¢',
                        totalTime: '7-8å°æ—¶',
                        walkingDistance: '2.6å…¬é‡Œ',
                        route: [
                            '09:00 åœ£ç›ä¸½æ•™å ‚ (45åˆ†é’Ÿ)',
                            '10:15 Villa Farnesina (60åˆ†é’Ÿ)',
                            '11:45 å½“åœ°ç¾é£Ÿä¹‹æ—… (90åˆ†é’Ÿ)',
                            '13:45 åˆä¼‘æ—¶å…‰ (60åˆ†é’Ÿ)',
                            '15:15 æ¤ç‰©å›­æ¼«æ­¥ (60åˆ†é’Ÿ)',
                            '16:45 æ²³è¾¹æ—¥è½ (45åˆ†é’Ÿ)'
                        ]
                    }
                },
                'vatican': {
                    '1km': {
                        startPoint: 'åœ£å½¼å¾—å¹¿åœº',
                        totalTime: '4-5å°æ—¶',
                        walkingDistance: '0.8å…¬é‡Œ',
                        route: [
                            '09:30 åœ£å½¼å¾—å¤§æ•™å ‚ (90åˆ†é’Ÿ)',
                            '11:30 æ¢µè’‚å†ˆèŠ±å›­ (60åˆ†é’Ÿ)',
                            '13:00 é™„è¿‘ç²¾è‡´åˆé¤ (90åˆ†é’Ÿ)',
                            '15:00 æ¢µè’‚å†ˆé‚®å±€ (20åˆ†é’Ÿ)',
                            '15:30 çºªå¿µå“è´­ç‰© (45åˆ†é’Ÿ)',
                            '16:30 åœ£å¤©ä½¿åŸå ¡è¿œçœº (30åˆ†é’Ÿ)'
                        ]
                    },
                    '2km': {
                        startPoint: 'æ¢µè’‚å†ˆåˆ°åœ£å¤©ä½¿åŸå ¡',
                        totalTime: '6-7å°æ—¶',
                        walkingDistance: '1.7å…¬é‡Œ',
                        route: [
                            '09:00 æ¢µè’‚å†ˆåšç‰©é¦†ç²¾é€‰ (120åˆ†é’Ÿ)',
                            '11:30 åœ£å½¼å¾—å¤§æ•™å ‚ (60åˆ†é’Ÿ)',
                            '13:00 æ¢µè’‚å†ˆåˆé¤ (90åˆ†é’Ÿ)',
                            '15:00 æ­¥è¡Œè‡³åœ£å¤©ä½¿åŸå ¡ (45åˆ†é’Ÿ)',
                            '16:00 åŸå ¡å‚è§‚ (60åˆ†é’Ÿ)',
                            '17:30 æ²³è¾¹æ•£æ­¥ (30åˆ†é’Ÿ)'
                        ]
                    },
                    '3km': {
                        startPoint: 'æ¢µè’‚å†ˆæ–‡åŒ–ä¹‹æ—…',
                        totalTime: '7-8å°æ—¶',
                        walkingDistance: '2.4å…¬é‡Œ',
                        route: [
                            '09:00 æ¢µè’‚å†ˆåšç‰©é¦† (150åˆ†é’Ÿ)',
                            '12:00 åœ£å½¼å¾—å¤§æ•™å ‚ (75åˆ†é’Ÿ)',
                            '13:30 ç²¾è‡´åˆé¤ (90åˆ†é’Ÿ)',
                            '15:30 åœ£å¤©ä½¿åŸå ¡ (75åˆ†é’Ÿ)',
                            '17:15 äººæ°‘å¹¿åœº (45åˆ†é’Ÿ)',
                            '18:15 æ—¥è½å’–å•¡ (30åˆ†é’Ÿ)'
                        ]
                    }
                },
                'villa': {
                    '1km': {
                        startPoint: 'Villa Borgheseå…¬å›­',
                        totalTime: '4-5å°æ—¶',
                        walkingDistance: '1.0å…¬é‡Œ',
                        route: [
                            '10:00 åšå°”æ ¼èµ›ç¾æœ¯é¦† (90åˆ†é’Ÿ)',
                            '12:00 å…¬å›­æ¹–å¿ƒäº­ (30åˆ†é’Ÿ)',
                            '13:00 å…¬å›­é‡é¤ (60åˆ†é’Ÿ)',
                            '14:30 ç§Ÿå•è½¦æ¸¸å›­ (60åˆ†é’Ÿ)',
                            '15:45 åŠ¨ç‰©å›­ï¼ˆå¯é€‰ï¼‰(45åˆ†é’Ÿ)',
                            '16:45 è§‚æ™¯å°ä¼‘æ¯ (30åˆ†é’Ÿ)'
                        ]
                    },
                    '2km': {
                        startPoint: 'Villa Borgheseåˆ°äººæ°‘å¹¿åœº',
                        totalTime: '6-7å°æ—¶',
                        walkingDistance: '1.8å…¬é‡Œ',
                        route: [
                            '09:30 åšå°”æ ¼èµ›ç¾æœ¯é¦† (120åˆ†é’Ÿ)',
                            '12:00 å…¬å›­æ¼«æ­¥ (45åˆ†é’Ÿ)',
                            '13:15 å…¬å›­é¤å…åˆé¤ (90åˆ†é’Ÿ)',
                            '15:15 æ­¥è¡Œè‡³äººæ°‘å¹¿åœº (30åˆ†é’Ÿ)',
                            '16:00 åŒå­æ•™å ‚å‚è§‚ (30åˆ†é’Ÿ)',
                            '17:00 Via del Corsoè´­ç‰© (60åˆ†é’Ÿ)'
                        ]
                    },
                    '3km': {
                        startPoint: 'ç»¿è‰²ç½—é©¬ä¸€æ—¥æ¸¸',
                        totalTime: '7-8å°æ—¶',
                        walkingDistance: '2.5å…¬é‡Œ',
                        route: [
                            '09:00 Villa Borghese (120åˆ†é’Ÿ)',
                            '11:30 Pincioè§‚æ™¯å° (30åˆ†é’Ÿ)',
                            '12:30 äººæ°‘å¹¿åœºåˆé¤ (90åˆ†é’Ÿ)',
                            '14:30 è¥¿ç­ç‰™é˜¶ (45åˆ†é’Ÿ)',
                            '15:45 Villa Medici (60åˆ†é’Ÿ)',
                            '17:15 æ—¥è½è§‚æ™¯ (45åˆ†é’Ÿ)'
                        ]
                    }
                }
            };
            
            return recommendations[location][radius];
        }
        
        // ç¡®è®¤è½»æ¾è¡Œç¨‹
        function confirmRelaxedItinerary(day) {
            addAIMessage(`ğŸ‰ å¤ªå¥½äº†ï¼å·²ä¸ºä½ ç¡®è®¤è¿™ä¸ªè½»æ¾çš„ç¬¬${day}å¤©è¡Œç¨‹ã€‚ç›¸æ¯”åŸæ¥çš„å®‰æ’ï¼Œè¿™ä¸ªç‰ˆæœ¬ï¼š<br><br>âœ… å‡å°‘äº†50%çš„æ­¥è¡Œè·ç¦»<br>âœ… å¢åŠ äº†æ›´å¤šä¼‘æ¯æ—¶é—´<br>âœ… ä¸“æ³¨äºä¸€ä¸ªåŒºåŸŸçš„æ·±åº¦ä½“éªŒ<br>âœ… é¿å…äº†åŒ†å¿™èµ¶è·¯<br><br>ä½ å¯ä»¥éšæ—¶åœ¨å·¦ä¾§æŸ¥çœ‹æ›´æ–°åçš„è¡Œç¨‹å®‰æ’ï¼`);
            
            // æ›´æ–°å»ºè®®è¡Œç¨‹ä¸­çš„å¯¹åº”å¤©æ•°
            var location = window.selectedLocation;
            var radius = window.selectedRadius || '2km';
            var recommendations = getLocationRecommendations(location, radius);
            
            // æ›´æ–° suggestedItinerary ä¸­å¯¹åº”å¤©æ•°çš„æ•°æ®
            for (var i = 0; i < suggestedItinerary.length; i++) {
                if (suggestedItinerary[i].day === day) {
                    // æ›´æ–°åŸºæœ¬ä¿¡æ¯
                    suggestedItinerary[i].title = `ç¬¬${day}å¤© - è½»æ¾${getLocationName(location)}æ¸¸`;
                    suggestedItinerary[i].startLocation = recommendations.startPoint;
                    suggestedItinerary[i].endLocation = 'åŒåŒºåŸŸç»“æŸ';
                    suggestedItinerary[i].totalDuration = recommendations.totalTime;
                    suggestedItinerary[i].walkingDistance = recommendations.walkingDistance;
                    
                    // æ›´æ–°æ´»åŠ¨åˆ—è¡¨
                    suggestedItinerary[i].activities = [];
                    for (var j = 0; j < recommendations.route.length; j++) {
                        var routeItem = recommendations.route[j];
                        var timeMatch = routeItem.match(/(\d{2}:\d{2})/);
                        var time = timeMatch ? timeMatch[1] : `${9 + j}:00`;
                        var activityName = routeItem.replace(/^\d{2}:\d{2}\s/, '');
                        
                        suggestedItinerary[i].activities.push({
                            time: time + '-' + getEndTime(time, 60),
                            activity: activityName,
                            emoji: getActivityEmoji(activityName),
                            id: 'relaxed_' + day + '_' + j,
                            selected: true,
                            location: getLocationName(location) + 'åŒºåŸŸ',
                            duration: getActivityDuration(activityName)
                        });
                    }
                    break;
                }
            }
            
            // é‡æ–°æ¸²æŸ“AIæ¨èè¡Œç¨‹ç•Œé¢
            renderItineraryPreview();
            
            // æ˜¾ç¤ºæ›´æ–°æç¤º
            setTimeout(function() {
                addAIMessage('âœ¨ AIæ¨èè¡Œç¨‹å·²æ›´æ–°ï¼å³ä¾§é¢æ¿ç°åœ¨æ˜¾ç¤ºä½ çš„æ–°è½»æ¾è¡Œç¨‹å®‰æ’ã€‚');
            }, 1000);
        }
        
        // è·å–ä½ç½®åç§°
        function getLocationName(location) {
            var names = {
                'centro': 'å†å²ä¸­å¿ƒ',
                'trastevere': 'Trastevere',
                'vatican': 'æ¢µè’‚å†ˆ',
                'villa': 'å…¬å›­åˆ«å¢…'
            };
            return names[location] || 'ç½—é©¬';
        }
        
        // è·å–æ´»åŠ¨è¡¨æƒ…ç¬¦å·
        function getActivityEmoji(activity) {
            if (activity.includes('æ•™å ‚') || activity.includes('å¤§æ•™å ‚')) return 'â›ª';
            if (activity.includes('å¹¿åœº')) return 'ğŸ›ï¸';
            if (activity.includes('å’–å•¡') || activity.includes('é¤å…') || activity.includes('åˆé¤')) return 'â˜•';
            if (activity.includes('è´­ç‰©') || activity.includes('å•†åº—')) return 'ğŸ›ï¸';
            if (activity.includes('å…¬å›­') || activity.includes('èŠ±å›­')) return 'ğŸŒ³';
            if (activity.includes('åšç‰©é¦†') || activity.includes('ç¾æœ¯é¦†')) return 'ğŸ¨';
            if (activity.includes('å¸‚åœº')) return 'ğŸª';
            if (activity.includes('æ²³') || activity.includes('æ¡¥')) return 'ğŸŒŠ';
            if (activity.includes('æ—¥è½') || activity.includes('è§‚æ™¯')) return 'ğŸŒ…';
            return 'ğŸ“';
        }
        
        // è·å–æ´»åŠ¨æ—¶é•¿
        function getActivityDuration(activity) {
            if (activity.includes('åˆé¤') || activity.includes('é¤å…')) return '90åˆ†é’Ÿ';
            if (activity.includes('å’–å•¡')) return '45åˆ†é’Ÿ';
            if (activity.includes('è´­ç‰©')) return '60åˆ†é’Ÿ';
            if (activity.includes('å‚è§‚') || activity.includes('æ•™å ‚')) return '45åˆ†é’Ÿ';
            if (activity.includes('æ¼«æ­¥') || activity.includes('æ•£æ­¥')) return '30åˆ†é’Ÿ';
            if (activity.includes('åšç‰©é¦†')) return '90åˆ†é’Ÿ';
            return '60åˆ†é’Ÿ';
        }
        
        // è®¡ç®—ç»“æŸæ—¶é—´
        function getEndTime(startTime, durationMinutes) {
            var parts = startTime.split(':');
            var hours = parseInt(parts[0]);
            var minutes = parseInt(parts[1]);
            
            minutes += durationMinutes;
            while (minutes >= 60) {
                hours += 1;
                minutes -= 60;
            }
            
            return String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
        }
        
        // æ˜¾ç¤ºå¢å¼ºé€‰é¡¹
        function showEnhancementOptions(day) {
            addAIMessage(`ğŸ’ª æ—¢ç„¶ä½ ä½“åŠ›å……æ²›ï¼Œè®©æˆ‘ä¸ºç¬¬${day}å¤©æ·»åŠ ä¸€äº›æ›´æœ‰æŒ‘æˆ˜æ€§å’Œè¶£å‘³æ€§çš„ä½“éªŒï¼ä½ æ›´å–œæ¬¢å“ªç§ç±»å‹çš„å¢å¼ºï¼Ÿ`);
            
            setTimeout(function() {
                var enhancementButtons = `
                    <div style="margin: 15px 0; text-align: center;">
                        <button class="action-btn" onclick="addEnhancement(${day}, 'adventure')" style="margin: 5px; background: linear-gradient(135deg, #ff6b6b, #ee5a52);">
                            ğŸƒâ€â™‚ï¸ å†’é™©è¿åŠ¨
                        </button>
                        <button class="action-btn" onclick="addEnhancement(${day}, 'culture')" style="margin: 5px; background: linear-gradient(135deg, #4ecdc4, #44a08d);">
                            ğŸ¨ æ·±åº¦æ–‡åŒ–
                        </button>
                        <button class="action-btn" onclick="addEnhancement(${day}, 'secret')" style="margin: 5px; background: linear-gradient(135deg, #45b7d1, #3498db);">
                            ğŸ” ç§˜å¯†æ™¯ç‚¹
                        </button>
                        <button class="action-btn" onclick="addEnhancement(${day}, 'nightlife')" style="margin: 5px; background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                            ğŸŒƒ å¤œç”Ÿæ´»ä½“éªŒ
                        </button>
                    </div>
                `;
                
                var messagesContainer = document.getElementById('chatMessages');
                var messageDiv = document.createElement('div');
                messageDiv.className = 'message ai-message';
                messageDiv.innerHTML = enhancementButtons;
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 500);
        }
        
        // æ·»åŠ å¢å¼ºä½“éªŒ
        function addEnhancement(day, type) {
            var enhancements = {
                'adventure': 'ğŸƒâ€â™‚ï¸ å¤ªæ£’äº†ï¼æˆ‘ä¼šä¸ºä½ æ·»åŠ ï¼šæ”€ç™»åœ£å½¼å¾—å¤§æ•™å ‚ç©¹é¡¶ã€å°ä¼¯æ²³çš®åˆ’è‰‡ä½“éªŒã€æˆ–è€…ç½—é©¬åœ°ä¸‹å¢“ç©´æ¢é™©ï¼',
                'culture': 'ğŸ¨ ç»ä½³é€‰æ‹©ï¼æˆ‘ä¼šå®‰æ’ï¼šç§äººåšç‰©é¦†å¤œæ¸¸ã€ä¼ ç»Ÿå·¥è‰ºå·¥åŠä½“éªŒã€æˆ–è€…ä¸å½“åœ°è‰ºæœ¯å®¶çš„æ·±åº¦å¯¹è¯ï¼',
                'secret': 'ğŸ” å¾ˆæœ‰è¶£ï¼æˆ‘æ¥åˆ†äº«ä¸€äº›ç½—é©¬äººæ‰çŸ¥é“çš„ç§˜å¯†ï¼šéšè—èŠ±å›­ã€åœ°ä¸‹é…’å§ã€è¿˜æœ‰åªæœ‰å†…è¡ŒäººçŸ¥é“çš„è§‚æ™¯ç‚¹ï¼',
                'nightlife': 'ğŸŒƒ è®©æˆ‘ä¸ºä½ å®‰æ’ï¼šå±‹é¡¶é…’å§å“é…’ã€ä¼ ç»ŸéŸ³ä¹è¡¨æ¼”ã€æˆ–è€…æ·±å¤œç¾é£Ÿæ¢ç´¢ä¹‹æ—…ï¼'
            };
            
            addAIMessage(enhancements[type] + '<br><br>è¿™äº›ä½“éªŒä¼šè®©ä½ çš„ç¬¬' + day + 'å¤©æ›´åŠ å……å®å’Œéš¾å¿˜ï¼');
        }
        
        // æ˜¾ç¤ºé£æ ¼é€‰é¡¹
        function showStyleOptions(day) {
            addAIMessage(`ğŸ¯ è®©æˆ‘ä»¬é‡æ–°è®¾è®¡ç¬¬${day}å¤©ï¼ä½ å¸Œæœ›è¿™ä¸€å¤©æ˜¯ä»€ä¹ˆé£æ ¼çš„ï¼Ÿ`);
            
            setTimeout(function() {
                var styleButtons = `
                    <div style="margin: 15px 0; text-align: center;">
                        <button class="action-btn" onclick="changeStyle(${day}, 'foodie')" style="margin: 5px; background: linear-gradient(135deg, #fd79a8, #e84393);">
                            ğŸœ ç¾é£Ÿæ¢ç´¢æ—¥
                        </button>
                        <button class="action-btn" onclick="changeStyle(${day}, 'artistic')" style="margin: 5px; background: linear-gradient(135deg, #a29bfe, #6c5ce7);">
                            ğŸ¨ è‰ºæœ¯æ–‡åŒ–æ—¥
                        </button>
                        <button class="action-btn" onclick="changeStyle(${day}, 'relaxed')" style="margin: 5px; background: linear-gradient(135deg, #00b894, #00a085);">
                            ğŸŒ¿ æ‚ é—²æ”¾æ¾æ—¥
                        </button>
                        <button class="action-btn" onclick="changeStyle(${day}, 'shopping')" style="margin: 5px; background: linear-gradient(135deg, #fdcb6e, #e17055);">
                            ğŸ›ï¸ è´­ç‰©ä½“éªŒæ—¥
                        </button>
                    </div>
                `;
                
                var messagesContainer = document.getElementById('chatMessages');
                var messageDiv = document.createElement('div');
                messageDiv.className = 'message ai-message';
                messageDiv.innerHTML = styleButtons;
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 500);
        }
        
        // æ”¹å˜é£æ ¼
        function changeStyle(day, style) {
            var styles = {
                'foodie': 'ğŸœ ç¾é£Ÿæ¢ç´¢æ—¥ï¼šä»å½“åœ°å¸‚åœºå¼€å§‹ï¼Œå­¦ä¹ åˆ¶ä½œä¼ ç»Ÿç½—é©¬èœï¼Œå“å°è¡—å¤´å°é£Ÿï¼Œå‚è§‚å¥¶é…ªå·¥åŠï¼Œæœ€ååœ¨ç±³å…¶æ—é¤å…äº«ç”¨æ™šé¤ï¼',
                'artistic': 'ğŸ¨ è‰ºæœ¯æ–‡åŒ–æ—¥ï¼šå‚è§‚ç§äººç”»å»Šï¼Œä¸å½“åœ°è‰ºæœ¯å®¶äº¤æµï¼Œå­¦ä¹ é©¬èµ›å…‹åˆ¶ä½œï¼Œæ¢è®¿æ–‡è‰ºå¤å…´å·¥ä½œå®¤ï¼Œæ¬£èµè¡—å¤´è‰ºæœ¯ï¼',
                'relaxed': 'ğŸŒ¿ æ‚ é—²æ”¾æ¾æ—¥ï¼šå…¬å›­æ¼«æ­¥ï¼Œå’–å•¡å…é˜…è¯»ï¼ŒSPAæŒ‰æ‘©ï¼Œæ²³è¾¹æ—¥å…‰æµ´ï¼Œæ…¢èŠ‚å¥æ„Ÿå—ç½—é©¬çš„ç”Ÿæ´»æ°”æ¯ï¼',
                'shopping': 'ğŸ›ï¸ è´­ç‰©ä½“éªŒæ—¥ï¼šç²¾å“åº—æ·˜å®ï¼Œå½“åœ°è®¾è®¡å¸ˆå·¥ä½œå®¤ï¼Œä¼ ç»Ÿæ‰‹å·¥è‰ºå“ï¼Œvintageå¤ç€åº—ï¼Œè¿˜æœ‰æ„å¤§åˆ©æ—¶å°šå“ç‰Œï¼'
            };
            
            addAIMessage(styles[style] + '<br><br>è¿™æ ·çš„ç¬¬' + day + 'å¤©å¬èµ·æ¥æ€ä¹ˆæ ·ï¼Ÿ');
        }
        
        // æŸ¥æ‰¾ç‰©å“
        function findItemById(id) {
            for (var category in allData) {
                for (var i = 0; i < allData[category].length; i++) {
                    if (allData[category][i].id === id) {
                        return allData[category][i];
                    }
                }
            }
            return null;
        }
        
        // é«˜äº®åœ°å›¾æ ‡è®°
        function highlightMapMarkers(category) {
            var markers = document.querySelectorAll('.activity-marker-2d');
            for (var i = 0; i < markers.length; i++) {
                markers[i].classList.remove('highlighted');
                if (markers[i].getAttribute('data-category') === category) {
                    markers[i].classList.add('highlighted');
                }
            }
        }
        
        // æ˜¾ç¤ºå¤©æ•°è·¯çº¿
        function showDayRoute(day) {
            var routes = document.querySelectorAll('.day-route');
            var buttons = document.querySelectorAll('.day-control-btn');
            
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            buttons.forEach(function(btn) {
                btn.classList.remove('active');
            });
            
            if (day === 0) {
                // æ˜¾ç¤ºå…¨éƒ¨
                routes.forEach(function(route) {
                    route.classList.add('active');
                });
                buttons[3].classList.add('active');
            } else {
                // æ˜¾ç¤ºç‰¹å®šå¤©æ•°
                routes.forEach(function(route, index) {
                    if (index + 1 === day) {
                        route.classList.add('active');
                    } else {
                        route.classList.remove('active');
                    }
                });
                buttons[day - 1].classList.add('active');
            }
            
            currentDayView = day;
        }
        
        function updateTimeSelection() {
            var daySelect = document.getElementById('daySelector');
            var timeSlotSelect = document.getElementById('timeSlotSelector');
            var confirmBtn = document.getElementById('confirmTimeBtn');
            
            selectedDay = daySelect.value;
            selectedTimeSlot = timeSlotSelect.value;
            
            if (selectedDay && selectedTimeSlot) {
                confirmBtn.style.display = 'block';
                confirmBtn.disabled = false;
            } else {
                confirmBtn.style.display = 'none';
            }
        }
        
        // ç¡®è®¤æ—¶é—´é€‰æ‹©
        function confirmTimeSelection() {
            if (!selectedDay || !selectedTimeSlot) return;
            
            var timeSlotNames = {
                'morning': 'ä¸Šåˆ (9:00-12:00)',
                'afternoon': 'ä¸‹åˆ (14:00-17:00)', 
                'evening': 'å‚æ™š (18:00-21:00)'
            };
            
            var message = 'âœ… ç¬¬' + selectedDay + 'å¤©åˆ°ç¬¬3å¤©å®‰æ’å¾ˆå¥½ï¼ç°åœ¨æˆ‘ä»¬æ¥èŠèŠå…·ä½“æ—¶é—´ã€‚ä½ å¸Œæœ›ï¼š<br><br>' +
                         'ğŸŒ… ä¸Šåˆ (9:00-12:00)<br>' +
                         'â˜€ï¸ ä¸‹åˆ (14:00-17:00)<br>' +
                         'ğŸŒ† å‚æ™š (18:00-21:00)<br><br>' +
                         'ä½ æ›´å€¾å‘å“ªä¸ªæ—¶æ®µï¼Ÿ';
            
            addAIMessage(message);
            
            // æ˜¾ç¤ºæœç´¢ç»“æœ
            showCategoryResults(selectedCategory);
            
            // éšè—æ—¶é—´é€‰æ‹©é¢æ¿
            document.getElementById('timeSelection').style.display = 'none';
        }
        
        function toggleMap() {
            var map3D = document.getElementById('map3D');
            var map2D = document.getElementById('map2D');
            var toggleBtn = document.getElementById('mapToggleBtn');
            
            if (currentMapView === '3D') {
                map3D.style.opacity = '0';
                map2D.style.opacity = '1';
                toggleBtn.textContent = 'ğŸŒ åˆ‡æ¢3Dåœ°å›¾';
                currentMapView = '2D';
            } else {
                map3D.style.opacity = '1';
                map2D.style.opacity = '0';
                toggleBtn.textContent = 'ğŸŒ åˆ‡æ¢2Dåœ°å›¾';
                currentMapView = '3D';
            }
        }
        
        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            var input = document.getElementById('chatInput');
            var message = input.value.trim();
            
            if (message === '') return;
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addUserMessage(message);
            input.value = '';
            
            // æ¨¡æ‹ŸAIå›å¤
            setTimeout(function() {
                var aiResponse = generateAIResponse(message);
                addAIMessage(aiResponse);
            }, 1000);
        }
        
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        function addUserMessage(message) {
            var messagesContainer = document.getElementById('chatMessages');
            var messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';
            messageDiv.textContent = message;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // æ·»åŠ AIæ¶ˆæ¯
        function addAIMessage(message) {
            var messagesContainer = document.getElementById('chatMessages');
            var messageDiv = document.createElement('div');
            messageDiv.className = 'message ai-message';
            messageDiv.innerHTML = message;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // ç”ŸæˆAIå›å¤
        function generateAIResponse(userMessage) {
            var message = userMessage.toLowerCase();
            
            // å¤„ç†æ—¶é—´é€‰æ‹©ç›¸å…³çš„å›å¤
            if (pendingExperience && (message.includes('ä¸Šåˆ') || message.includes('ä¸‹åˆ') || message.includes('å‚æ™š'))) {
                var timeSlot = 'morning';
                var timeText = 'ä¸Šåˆ';
                
                if (message.includes('ä¸‹åˆ')) {
                    timeSlot = 'afternoon';
                    timeText = 'ä¸‹åˆ';
                } else if (message.includes('å‚æ™š')) {
                    timeSlot = 'evening';
                    timeText = 'å‚æ™š';
                }
                
                var experienceName = pendingExperience.name;
                addToItineraryWithTime(pendingExperience.id, timeSlot, selectedDay || 1);
                pendingExperience = null;
                return 'å®Œç¾ï¼å·²ä¸ºä½ å®‰æ’åœ¨' + timeText + 'ä½“éªŒ"' + experienceName + '"ã€‚è¿˜æƒ³æ·»åŠ å…¶ä»–ä½“éªŒå—ï¼Ÿ';
            }
            
            if (message.includes('spa') || message.includes('æŒ‰æ‘©') || message.includes('æ”¾æ¾')) {
                selectCategory('service');
                return 'ğŸ›€ æˆ‘ç†è§£ä½ æƒ³è¦æ”¾æ¾ï¼ç½—é©¬çš„SPAä½“éªŒéå¸¸æ£’ï¼Œç‰¹åˆ«æ¨èå¤å…¸ç½—é©¬å¼æ¸©æ³‰æµ´ã€‚è¯·å…ˆé€‰æ‹©æƒ³è¦ä½“éªŒçš„æ—¶é—´ã€‚';
            } else if (message.includes('ç¾é£Ÿ') || message.includes('é¤å…') || message.includes('åƒ')) {
                return 'ğŸ ç½—é©¬çš„ç¾é£Ÿæ–‡åŒ–å¤ªä¸°å¯Œäº†ï¼é™¤äº†ä¼ ç»Ÿé¤å…ï¼Œæˆ‘ç‰¹åˆ«æ¨èç§å¨ä½“éªŒå’Œçƒ¹é¥ªè¯¾ç¨‹ï¼Œè¿™æ ·ä½ å¯ä»¥å­¦ä¼šåˆ¶ä½œæ­£å®—çš„æ„å¤§åˆ©é¢ã€‚æƒ³è¯•è¯•å“ªç§ï¼Ÿ';
            } else if (message.includes('å¯†å®¤') || message.includes('æ¸¸æˆ') || message.includes('å‰§æœ¬')) {
                selectCategory('script');
                return 'ğŸ­ å¤ªæœ‰è¶£äº†ï¼ç½—é©¬æœ‰ä¸€äº›ç‹¬ç‰¹çš„å†å²ä¸»é¢˜å‰§æœ¬ä½“éªŒï¼Œå¯ä»¥è®©ä½ ç©¿è¶Šå›å¤ç½—é©¬æ—¶ä»£ã€‚è¯·é€‰æ‹©æƒ³è¦ä½“éªŒçš„æ—¶é—´ã€‚';
            } else if (message.includes('è¡Œç¨‹') || message.includes('è§„åˆ’') || message.includes('å®‰æ’')) {
                selectCategory('itinerary');
                return 'ğŸ“‹ è®©æˆ‘ä¸ºä½ åˆ¶å®šä¸€ä¸ªå®Œç¾çš„3å¤©è¡Œç¨‹ï¼æˆ‘ä¼šç»“åˆå†å²æ–‡åŒ–ã€ç¾é£Ÿä½“éªŒå’Œæ”¾æ¾æ—¶å…‰ï¼Œç¡®ä¿æ¯ä¸€å¤©éƒ½å……å®è€Œä¸åŒ†å¿™ã€‚';
            } else {
                return 'ğŸ¤” å¬èµ·æ¥å¾ˆæœ‰è¶£ï¼ä½ å¯ä»¥ä»å³ä¾§é€‰æ‹©ä½“éªŒç±»å‹ï¼Œæˆ–è€…å‘Šè¯‰æˆ‘æ›´å…·ä½“çš„éœ€æ±‚ï¼Œæ¯”å¦‚ï¼šæƒ³è¦æ”¾æ¾ã€ç¾é£Ÿä½“éªŒã€æ–‡åŒ–æ´»åŠ¨ç­‰ã€‚æˆ‘ä¼šä¸ºä½ æ¨èæœ€åˆé€‚çš„é€‰æ‹©ï¼';
            }
        }
        
        // é€‰æ‹©ä½“éªŒæ—¶é—´
        function selectExperienceTime(itemId) {
            // æŸ¥æ‰¾ç‰©å“
            var item = null;
            for (var category in allData) {
                for (var i = 0; i < allData[category].length; i++) {
                    if (allData[category][i].id === itemId) {
                        item = allData[category][i];
                        break;
                    }
                }
                if (item) break;
            }
            
            if (!item) return;
            
            pendingExperience = item;
            
            // æ˜¾ç¤ºæ—¶é—´é€‰æ‹©å¯¹è¯
            var timeOptions = [
                'ğŸŒ… ä¸Šåˆ (9:00-12:00)',
                'â˜€ï¸ ä¸‹åˆ (14:00-17:00)', 
                'ğŸŒ† å‚æ™š (18:00-21:00)'
            ];
            
            var message = 'â° è¯·é€‰æ‹© "' + item.name + '" çš„æ—¶é—´ï¼š<br><br>' +
                         timeOptions.join('<br>') + '<br><br>' +
                         'ä½ æ›´å€¾å‘å“ªä¸ªæ—¶æ®µï¼Ÿ';
            
            addAIMessage(message);
        }
        
        // åŠ å…¥è¡Œç¨‹ï¼ˆå¸¦æ—¶é—´ä¿¡æ¯ï¼‰
        function addToItineraryWithTime(itemId, timeSlot, day) {
            // æŸ¥æ‰¾ç‰©å“
            var item = null;
            for (var category in allData) {
                for (var i = 0; i < allData[category].length; i++) {
                    if (allData[category][i].id === itemId) {
                        item = allData[category][i];
                        break;
                    }
                }
                if (item) break;
            }
            
            if (!item) return;
            
            // æ£€æŸ¥æ˜¯å¦å·²æ·»åŠ 
            for (var i = 0; i < itineraryItems.length; i++) {
                if (itineraryItems[i].id === itemId) {
                    addAIMessage('ğŸ“‹ è¿™ä¸ªé¡¹ç›®å·²ç»åœ¨ä½ çš„è¡Œç¨‹ä¸­äº†ï¼');
                    return;
                }
            }
            
            // æ·»åŠ æ—¶é—´ä¿¡æ¯
            var itemWithTime = Object.assign({}, item);
            itemWithTime.scheduledDay = day || selectedDay || 1;
            itemWithTime.scheduledTimeSlot = timeSlot || selectedTimeSlot || 'morning';
            
            var timeSlotNames = {
                'morning': 'ä¸Šåˆ',
                'afternoon': 'ä¸‹åˆ',
                'evening': 'å‚æ™š'
            };
            
            // æ·»åŠ åˆ°è¡Œç¨‹
            itineraryItems.push(itemWithTime);
            updateItineraryDisplay();
            
            // é«˜äº®åœ°å›¾æ ‡è®°
            var marker = document.querySelector('[data-id="' + itemId + '"]');
            if (marker) {
                marker.classList.add('in-itinerary');
            }
            
            var timeText = timeSlotNames[itemWithTime.scheduledTimeSlot] || 'æœªæŒ‡å®šæ—¶é—´';
            addAIMessage('âœ… å·²å°†"' + item.name + '"å®‰æ’åœ¨ç¬¬' + itemWithTime.scheduledDay + 'å¤©' + timeText + 'ï¼æ€»è®¡è´¹ç”¨ï¼šâ‚¬' + calculateTotalCost());
        }
        
        function addToItinerary(itemId) {
            // æŸ¥æ‰¾ç‰©å“
            var item = null;
            for (var category in allData) {
                for (var i = 0; i < allData[category].length; i++) {
                    if (allData[category][i].id === itemId) {
                        item = allData[category][i];
                        break;
                    }
                }
                if (item) break;
            }
            
            if (!item) return;
            
            // æ£€æŸ¥æ˜¯å¦å·²æ·»åŠ 
            for (var i = 0; i < itineraryItems.length; i++) {
                if (itineraryItems[i].id === itemId) {
                    addAIMessage('ğŸ“‹ è¿™ä¸ªé¡¹ç›®å·²ç»åœ¨ä½ çš„è¡Œç¨‹ä¸­äº†ï¼');
                    return;
                }
            }
            
            // æ·»åŠ åˆ°è¡Œç¨‹
            itineraryItems.push(item);
            updateItineraryDisplay();
            
            // é«˜äº®åœ°å›¾æ ‡è®°
            var marker = document.querySelector('[data-id="' + itemId + '"]');
            if (marker) {
                marker.classList.add('in-itinerary');
            }
            
            addAIMessage('âœ… å·²å°†"' + item.name + '"åŠ å…¥ä½ çš„è¡Œç¨‹ï¼æ€»è®¡è´¹ç”¨ï¼šâ‚¬' + calculateTotalCost());
        }
        
        // æ›´æ–°è¡Œç¨‹æ˜¾ç¤º
        function updateItineraryDisplay() {
            var container = document.getElementById('itineraryItems');
            
            if (itineraryItems.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: rgba(255,255,255,0.5); font-size: 12px; padding: 20px;">
                        æš‚æ— å®‰æ’é¡¹ç›®<br>
                        <small>é€‰æ‹©æœåŠ¡å¹¶ç‚¹å‡»"é€‰æ‹©æ—¶é—´"</small>
                    </div>
                `;
                return;
            }
            
            // æŒ‰å¤©åˆ†ç»„æ˜¾ç¤º
            var groupedByDay = {};
            for (var i = 0; i < itineraryItems.length; i++) {
                var item = itineraryItems[i];
                var day = item.scheduledDay || 1;
                if (!groupedByDay[day]) {
                    groupedByDay[day] = [];
                }
                groupedByDay[day].push(item);
            }
            
            container.innerHTML = '';
            
            // æŒ‰å¤©æ˜¾ç¤º
            for (var day = 1; day <= 3; day++) {
                if (groupedByDay[day] && groupedByDay[day].length > 0) {
                    var dayHeader = document.createElement('div');
                    dayHeader.style.cssText = 'color: #4ecdc4; font-weight: bold; margin: 10px 0 5px 0; font-size: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px;';
                    dayHeader.innerHTML = `ç¬¬${day}å¤© <button onclick="showDayRoute(${day})" style="float: right; background: rgba(255,255,255,0.1); border: none; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; cursor: pointer;">æŸ¥çœ‹åœ°å›¾</button>`;
                    container.appendChild(dayHeader);
                    
                    // æŒ‰æ—¶é—´æ’åº
                    groupedByDay[day].sort(function(a, b) {
                        var timeA = a.scheduledTime || '00:00';
                        var timeB = b.scheduledTime || '00:00';
                        return timeA.localeCompare(timeB);
                    });
                    
                    for (var j = 0; j < groupedByDay[day].length; j++) {
                        var item = groupedByDay[day][j];
                        var itemDiv = document.createElement('div');
                        itemDiv.className = 'itinerary-item';
                        
                        var timeText = item.scheduledTime || '';
                        var timeSlotNames = {
                            'morning': 'ä¸Šåˆ',
                            'afternoon': 'ä¸‹åˆ',
                            'evening': 'å‚æ™š'
                        };
                        
                        if (item.scheduledTimeSlot && !timeText) {
                            timeText = timeSlotNames[item.scheduledTimeSlot];
                        }
                        
                        itemDiv.innerHTML = `
                            <span style="font-size: 10px;">
                                ${timeText ? timeText + ' - ' : ''}${item.emoji} ${item.name} - â‚¬${item.price}
                            </span>
                            <button class="remove-item" onclick="removeFromItinerary('${item.id}')">ç§»é™¤</button>
                        `;
                        container.appendChild(itemDiv);
                    }
                }
            }
        }
        
        // ä»è¡Œç¨‹ä¸­ç§»é™¤
        function removeFromItinerary(itemId) {
            itineraryItems = itineraryItems.filter(function(item) {
                return item.id !== itemId;
            });
            
            updateItineraryDisplay();
            
            // ç§»é™¤åœ°å›¾æ ‡è®°é«˜äº®
            var marker = document.querySelector('[data-id="' + itemId + '"]');
            if (marker) {
                marker.classList.remove('in-itinerary');
            }
            
            addAIMessage('ğŸ—‘ å·²ä»è¡Œç¨‹ä¸­ç§»é™¤è¯¥é¡¹ç›®ã€‚å½“å‰æ€»è´¹ç”¨ï¼šâ‚¬' + calculateTotalCost());
        }
        
        // è®¡ç®—æ€»è´¹ç”¨
        function calculateTotalCost() {
            var total = 0;
            for (var i = 0; i < itineraryItems.length; i++) {
                total += itineraryItems[i].price;
            }
            return total;
        }
        
        // æ˜¾ç¤ºé¡¹ç›®è¯¦æƒ…
        function showItemDetails(itemId, category) {
            var item = null;
            for (var i = 0; i < allData[category].length; i++) {
                if (allData[category][i].id === itemId) {
                    item = allData[category][i];
                    break;
                }
            }
            
            if (item) {
                var details = `
                    ğŸ“ <strong>${item.name}</strong><br>
                    ${item.description}<br><br>
                    ğŸ’° ä»·æ ¼: â‚¬${item.price} | â° æ—¶é•¿: ${item.duration}<br>
                    â­ è¯„åˆ†: ${item.rating}/5.0<br>
                    ğŸ“Œ ä½ç½®: ${item.location}
                `;
                
                if (item.tags) {
                    details += '<br>ğŸ·ï¸ æ ‡ç­¾: ' + item.tags.join(', ');
                }
                
                addAIMessage(details);
            }
        }
        
        // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
        function showWelcome() {
            // æ¬¢è¿æ¶ˆæ¯å·²åœ¨HTMLä¸­å®šä¹‰
        }
        
        // æ·»åŠ å…¨å±€å‡½æ•°åˆ°windowå¯¹è±¡ï¼Œç¡®ä¿HTMLä¸­çš„onclickå¯ä»¥è®¿é—®
        window.selectCategory = selectCategory;
        window.showDayRoute = showDayRoute;
        window.toggleActivity = toggleActivity;
        window.confirmAIItinerary = confirmAIItinerary;
        window.customizeItinerary = customizeItinerary;
        window.showItineraryAdjustment = showItineraryAdjustment;
        window.adjustDay = adjustDay;
        window.respondToTiredness = respondToTiredness;
        window.selectStartLocation = selectStartLocation;
        window.selectRadius = selectRadius;
        window.confirmRelaxedItinerary = confirmRelaxedItinerary;
        window.addEnhancement = addEnhancement;
        window.changeStyle = changeStyle;
        window.selectExperienceTime = selectExperienceTime;
        window.addToItinerary = addToItinerary;
        window.removeFromItinerary = removeFromItinerary;
        window.askUniloco = askUniloco;
        window.showActivityDetails = showActivityDetails;
        window.showDetailPage = showDetailPage;
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            init();
        });
    </script>
</body>
</html>