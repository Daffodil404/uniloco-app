<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web3 Travel Story Platform - 游戏化演示</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #1e40af 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            position: relative;
        }

        /* 登录界面样式 */
        .login-container {
            text-align: center;
            padding: 40px 20px;
        }

        .login-logo {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border-radius: 50%;
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            box-shadow: 0 10px 30px rgba(251, 191, 36, 0.3);
        }

        .login-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .login-subtitle {
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            text-align: left;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #fbbf24;
            background: rgba(255, 255, 255, 0.15);
        }

        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        /* 游戏化按钮样式 */
        .btn-game {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border: none;
            border-radius: 12px;
            padding: 14px 20px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            width: 100%;
        }

        .btn-game:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(251, 191, 36, 0.3);
        }

        .btn-game::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn-game:hover::before {
            left: 100%;
        }

        /* 主应用样式 */
        .main-app {
            display: none;
        }

        .main-app.active {
            display: block;
        }

        /* 顶部状态栏 */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .unc-balance {
            background: linear-gradient(135deg, #10b981, #059669);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        /* 标签栏 */
        .tab-bar {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            position: relative;
        }

        .tab.active {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);
        }

        /* AI聊天界面 */
        .chat-container {
            height: 500px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .message.ai .message-avatar {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .message-content {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 18px;
            max-width: 70%;
            backdrop-filter: blur(10px);
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
        }

        .message.ai .message-content {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        /* 聊天输入区域样式 */
        .chat-input-container {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: #fbbf24;
            background: rgba(255, 255, 255, 0.15);
        }

        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .chat-send-btn {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);
        }

        .chat-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .suggestion-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 8px 16px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .suggestion-btn:hover {
            background: rgba(251, 191, 36, 0.2);
            border-color: #fbbf24;
            transform: translateY(-2px);
        }

        /* 问题表单样式 */
        .question-form {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .question-item {
            margin-bottom: 20px;
        }

        .question-label {
            font-weight: 600;
            margin-bottom: 10px;
            color: #fbbf24;
        }

        .question-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .option-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 14px;
        }

        .option-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .option-btn.selected {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border-color: #fbbf24;
        }

                 /* 游戏化藏宝图样式 - 增强3D效果 */
         .treasure-map {
             background: linear-gradient(135deg, #1e3a8a, #3b82f6);
             border-radius: 12px;
             padding: 15px;
             margin: 15px 0;
             position: relative;
             overflow: hidden;
             border: 2px solid #fbbf24;
             box-shadow: 
                 0 0 30px rgba(251, 191, 36, 0.3),
                 0 8px 25px rgba(0, 0, 0, 0.4),
                 inset 0 1px 0 rgba(255, 255, 255, 0.1);
             transform-style: preserve-3d;
             perspective: 1000px;
             transform: rotateX(5deg) rotateY(2deg);
             transition: transform 0.3s ease;
         }

         .treasure-map:hover {
             transform: rotateX(3deg) rotateY(1deg) scale(1.02);
         }

         .map-container {
             height: 250px;
             background: linear-gradient(135deg, #0f172a, #1e293b);
             border-radius: 8px;
             position: relative;
             display: flex;
             align-items: center;
             justify-content: center;
             border: 1px solid rgba(251, 191, 36, 0.3);
             overflow: hidden;
             transform-style: preserve-3d;
             transform: translateZ(20px);
             box-shadow: 
                 0 10px 30px rgba(0, 0, 0, 0.5),
                 inset 0 1px 0 rgba(255, 255, 255, 0.1);
         }

         .map-container::before {
             content: '';
             position: absolute;
             top: 0;
             left: 0;
             right: 0;
             bottom: 0;
             background-image: 
                 radial-gradient(circle at 20% 30%, rgba(251, 191, 36, 0.1) 2px, transparent 2px),
                 radial-gradient(circle at 80% 70%, rgba(251, 191, 36, 0.1) 2px, transparent 2px),
                 radial-gradient(circle at 40% 80%, rgba(251, 191, 36, 0.1) 2px, transparent 2px),
                 radial-gradient(circle at 70% 20%, rgba(251, 191, 36, 0.1) 2px, transparent 2px);
             background-size: 50px 50px, 60px 60px, 40px 40px, 70px 70px;
             animation: mapFloat 20s ease-in-out infinite;
             transform: translateZ(10px);
         }

         .map-container::after {
             content: '';
             position: absolute;
             top: 10px;
             left: 10px;
             right: 10px;
             bottom: 10px;
             background: linear-gradient(135deg, rgba(251, 191, 36, 0.05), transparent);
             border-radius: 6px;
             transform: translateZ(5px);
             pointer-events: none;
         }

         /* 3D深度指示器 */
         .depth-indicator {
             position: absolute;
             bottom: 10px;
             right: 10px;
             background: rgba(0, 0, 0, 0.6);
             color: #fbbf24;
             padding: 4px 8px;
             border-radius: 4px;
             font-size: 10px;
             transform: translateZ(60px);
             z-index: 30;
             pointer-events: none;
             animation: depthPulse 3s ease-in-out infinite;
         }

         @keyframes depthPulse {
             0%, 100% { opacity: 0.7; }
             50% { opacity: 1; }
         }

         @keyframes mapFloat {
             0%, 100% { 
                 transform: translateY(0px) rotate(0deg) translateZ(10px); 
             }
             25% { 
                 transform: translateY(-5px) rotate(1deg) translateZ(15px); 
             }
             50% { 
                 transform: translateY(0px) rotate(0deg) translateZ(10px); 
             }
             75% { 
                 transform: translateY(5px) rotate(-1deg) translateZ(5px); 
             }
         }

         .poi-point {
             position: absolute;
             width: 20px;
             height: 20px;
             background: linear-gradient(135deg, #fbbf24, #f59e0b);
             border-radius: 50%;
             cursor: pointer;
             animation: poiGlow 2s ease-in-out infinite alternate;
             box-shadow: 
                 0 0 20px rgba(251, 191, 36, 0.6),
                 0 5px 15px rgba(0, 0, 0, 0.3);
             border: 2px solid rgba(255, 255, 255, 0.3);
             transition: all 0.3s ease;
             z-index: 10;
             transform-style: preserve-3d;
             transform: translateZ(30px);
         }

         .poi-point:hover {
             transform: scale(1.2) translateZ(40px);
             box-shadow: 
                 0 0 30px rgba(251, 191, 36, 0.8),
                 0 8px 25px rgba(0, 0, 0, 0.4);
         }

         .poi-point.completed {
             background: linear-gradient(135deg, #10b981, #059669);
             animation: completedPulse 1s ease-in-out infinite;
         }

         .poi-point.completed::after {
             content: '✓';
             position: absolute;
             top: 50%;
             left: 50%;
             transform: translate(-50%, -50%);
             color: white;
             font-weight: bold;
             font-size: 12px;
         }

         @keyframes poiGlow {
             from { 
                 box-shadow: 
                     0 0 20px rgba(251, 191, 36, 0.6),
                     0 5px 15px rgba(0, 0, 0, 0.3);
                 transform: scale(1) translateZ(30px);
             }
             to { 
                 box-shadow: 
                     0 0 30px rgba(251, 191, 36, 0.8),
                     0 8px 25px rgba(0, 0, 0, 0.4);
                 transform: scale(1.1) translateZ(35px);
             }
         }

         @keyframes completedPulse {
             0%, 100% { opacity: 1; }
             50% { opacity: 0.7; }
         }

         .poi-label {
             position: absolute;
             background: rgba(0, 0, 0, 0.8);
             color: white;
             padding: 4px 8px;
             border-radius: 4px;
             font-size: 12px;
             white-space: nowrap;
             opacity: 0;
             transition: opacity 0.3s ease;
             z-index: 20;
             pointer-events: none;
             transform-style: preserve-3d;
             transform: translateZ(50px);
             box-shadow: 
                 0 3px 10px rgba(0, 0, 0, 0.5),
                 inset 0 1px 0 rgba(255, 255, 255, 0.1);
         }

         .poi-point:hover + .poi-label,
         .poi-label:hover {
             opacity: 1;
         }

         .map-controls {
             display: flex;
             gap: 10px;
             margin-top: 15px;
             justify-content: center;
         }

         .map-btn {
             background: rgba(255, 255, 255, 0.1);
             border: 1px solid rgba(255, 255, 255, 0.2);
             border-radius: 8px;
             padding: 8px 12px;
             color: white;
             cursor: pointer;
             transition: all 0.3s ease;
             font-size: 12px;
         }

         .map-btn:hover {
             background: rgba(255, 255, 255, 0.2);
             transform: translateY(-2px);
         }

         .map-btn.active {
             background: linear-gradient(135deg, #fbbf24, #f59e0b);
             border-color: #fbbf24;
         }

         .poi-options {
             display: grid;
             grid-template-columns: repeat(3, 1fr);
             gap: 8px;
             margin-top: 10px;
         }

         .poi-option {
             background: rgba(255, 255, 255, 0.1);
             border: 1px solid rgba(255, 255, 255, 0.2);
             border-radius: 6px;
             padding: 6px;
             color: white;
             cursor: pointer;
             transition: all 0.3s ease;
             text-align: center;
             font-size: 11px;
         }

         .poi-option:hover {
             background: rgba(255, 255, 255, 0.2);
         }

         .poi-option.selected {
             background: linear-gradient(135deg, #fbbf24, #f59e0b);
             border-color: #fbbf24;
         }

         /* 地图编辑模式样式 */
         .map-edit-mode {
             background: rgba(251, 191, 36, 0.1);
             border: 2px solid #fbbf24;
             border-radius: 12px;
             padding: 15px;
             margin: 10px 0;
         }

         .edit-controls {
             display: flex;
             gap: 10px;
             margin-bottom: 15px;
             flex-wrap: wrap;
         }

         .edit-btn {
             background: linear-gradient(135deg, #fbbf24, #f59e0b);
             border: none;
             border-radius: 8px;
             padding: 8px 12px;
             color: white;
             font-size: 12px;
             cursor: pointer;
             transition: all 0.3s ease;
         }

         .edit-btn:hover {
             transform: translateY(-2px);
             box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
         }

         .edit-btn.secondary {
             background: linear-gradient(135deg, #6b7280, #4b5563);
         }

         .edit-btn.danger {
             background: linear-gradient(135deg, #ef4444, #dc2626);
         }

         .poi-editor {
             background: rgba(0, 0, 0, 0.3);
             border-radius: 8px;
             padding: 15px;
             margin: 10px 0;
             display: none;
         }

         .poi-editor.active {
             display: block;
         }

         .poi-editor input,
         .poi-editor textarea {
             width: 100%;
             padding: 8px 12px;
             border: 1px solid rgba(255, 255, 255, 0.2);
             border-radius: 6px;
             background: rgba(255, 255, 255, 0.1);
             color: white;
             margin-bottom: 10px;
             font-size: 14px;
         }

         .poi-editor input:focus,
         .poi-editor textarea:focus {
             outline: none;
             border-color: #fbbf24;
         }

         .poi-editor textarea {
             resize: vertical;
             min-height: 80px;
         }

         /* POI分享弹窗样式 */
         .poi-share-modal {
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background: rgba(0, 0, 0, 0.8);
             display: none;
             align-items: center;
             justify-content: center;
             z-index: 1000;
         }

         .poi-share-modal.active {
             display: flex;
         }

         .share-content {
             background: linear-gradient(135deg, #1e3a8a, #3b82f6);
             border-radius: 16px;
             padding: 25px;
             max-width: 350px;
             width: 90%;
             max-height: 80vh;
             overflow-y: auto;
             position: relative;
             border: 2px solid #fbbf24;
         }

         .share-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 20px;
             padding-bottom: 15px;
             border-bottom: 1px solid rgba(255, 255, 255, 0.2);
         }

         .share-title {
             font-size: 18px;
             font-weight: bold;
             color: #fbbf24;
         }

         .close-share {
             background: none;
             border: none;
             color: white;
             font-size: 24px;
             cursor: pointer;
             padding: 0;
             width: 30px;
             height: 30px;
             display: flex;
             align-items: center;
             justify-content: center;
             border-radius: 50%;
             transition: all 0.3s ease;
         }

         .close-share:hover {
             background: rgba(255, 255, 255, 0.1);
         }

         .share-poi-info {
             background: rgba(255, 255, 255, 0.1);
             border-radius: 12px;
             padding: 15px;
             margin-bottom: 20px;
             text-align: center;
         }

         .share-poi-emoji {
             font-size: 48px;
             margin-bottom: 10px;
         }

         .share-poi-name {
             font-size: 16px;
             font-weight: bold;
             margin-bottom: 5px;
             color: #fbbf24;
         }

         .share-poi-description {
             font-size: 14px;
             color: rgba(255, 255, 255, 0.8);
             margin-bottom: 15px;
         }

         .share-actions {
             display: grid;
             grid-template-columns: 1fr 1fr;
             gap: 10px;
             margin-bottom: 20px;
         }

         .share-action-btn {
             background: linear-gradient(135deg, #fbbf24, #f59e0b);
             border: none;
             border-radius: 8px;
             padding: 12px;
             color: white;
             font-size: 14px;
             cursor: pointer;
             transition: all 0.3s ease;
             display: flex;
             align-items: center;
             justify-content: center;
             gap: 8px;
         }

         .share-action-btn:hover {
             transform: translateY(-2px);
             box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
         }

         .share-action-btn.secondary {
             background: linear-gradient(135deg, #10b981, #059669);
         }

         .share-action-btn.danger {
             background: linear-gradient(135deg, #ef4444, #dc2626);
         }

         .share-content-input {
             width: 100%;
             padding: 12px;
             border: 1px solid rgba(255, 255, 255, 0.2);
             border-radius: 8px;
             background: rgba(255, 255, 255, 0.1);
             color: white;
             font-size: 14px;
             margin-bottom: 15px;
             resize: vertical;
             min-height: 80px;
         }

         /* POI详情和评论样式 */
         .poi-detail-info {
             background: rgba(255, 255, 255, 0.1);
             border-radius: 12px;
             padding: 15px;
             margin-bottom: 20px;
             text-align: center;
         }

         .poi-detail-emoji {
             font-size: 48px;
             margin-bottom: 10px;
         }

         .poi-detail-name {
             font-size: 18px;
             font-weight: bold;
             margin-bottom: 5px;
             color: #fbbf24;
         }

         .poi-detail-description {
             font-size: 14px;
             color: rgba(255, 255, 255, 0.8);
             margin-bottom: 15px;
         }

         .poi-detail-stats {
             display: flex;
             justify-content: space-around;
             gap: 10px;
         }

         .poi-stat {
             font-size: 12px;
             color: rgba(255, 255, 255, 0.7);
             display: flex;
             flex-direction: column;
             align-items: center;
         }

         .poi-stat span {
             font-weight: bold;
             color: #fbbf24;
             font-size: 14px;
         }

         .comments-section {
             margin-top: 20px;
         }

         .comments-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 15px;
             padding-bottom: 10px;
             border-bottom: 1px solid rgba(255, 255, 255, 0.2);
         }

         .comments-header h4 {
             color: #fbbf24;
             font-size: 16px;
             margin: 0;
         }

         .add-comment-btn {
             background: linear-gradient(135deg, #10b981, #059669);
             border: none;
             border-radius: 6px;
             padding: 8px 12px;
             color: white;
             font-size: 12px;
             cursor: pointer;
             transition: all 0.3s ease;
         }

         .add-comment-btn:hover {
             transform: translateY(-1px);
             box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
         }

         .comments-list {
             max-height: 300px;
             overflow-y: auto;
             margin-bottom: 15px;
         }

         .comment-item {
             background: rgba(255, 255, 255, 0.05);
             border-radius: 8px;
             padding: 12px;
             margin-bottom: 10px;
             border: 1px solid rgba(255, 255, 255, 0.1);
         }

         .comment-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 8px;
         }

         .comment-user {
             font-size: 14px;
             font-weight: bold;
             color: #fbbf24;
         }

         .comment-rating-display {
             display: flex;
             gap: 2px;
         }

         .comment-rating-display .star {
             font-size: 12px;
             color: #fbbf24;
         }

         .comment-text {
             font-size: 14px;
             color: rgba(255, 255, 255, 0.9);
             line-height: 1.4;
             margin-bottom: 8px;
         }

         .comment-time {
             font-size: 12px;
             color: rgba(255, 255, 255, 0.5);
         }

         .add-comment-form {
             background: rgba(255, 255, 255, 0.05);
             border-radius: 8px;
             padding: 15px;
             border: 1px solid rgba(255, 255, 255, 0.1);
         }

         .comment-input {
             width: 100%;
             padding: 10px;
             border: 1px solid rgba(255, 255, 255, 0.2);
             border-radius: 6px;
             background: rgba(255, 255, 255, 0.1);
             color: white;
             font-size: 14px;
             margin-bottom: 10px;
             resize: vertical;
             min-height: 60px;
         }

         .comment-rating {
             display: flex;
             align-items: center;
             gap: 10px;
             margin-bottom: 10px;
         }

         .comment-rating span {
             font-size: 14px;
             color: rgba(255, 255, 255, 0.8);
         }

         .rating-stars {
             display: flex;
             gap: 2px;
         }

         .rating-stars .star {
             font-size: 16px;
             color: rgba(255, 255, 255, 0.3);
             cursor: pointer;
             transition: all 0.2s ease;
         }

         .rating-stars .star:hover,
         .rating-stars .star.active {
             color: #fbbf24;
         }

         .comment-actions {
             display: flex;
             gap: 10px;
         }

         .comment-btn {
             flex: 1;
             padding: 8px 12px;
             border: none;
             border-radius: 6px;
             font-size: 14px;
             cursor: pointer;
             transition: all 0.3s ease;
         }

         .comment-btn {
             background: linear-gradient(135deg, #fbbf24, #f59e0b);
             color: white;
         }

         .comment-btn.secondary {
             background: linear-gradient(135deg, #6b7280, #4b5563);
             color: white;
         }

         .comment-btn:hover {
             transform: translateY(-1px);
             box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3);
         }

         .comment-btn.secondary:hover {
             box-shadow: 0 2px 8px rgba(107, 114, 128, 0.3);
         }

         .share-content-input:focus {
             outline: none;
             border-color: #fbbf24;
         }

         .share-stats {
             display: flex;
             justify-content: space-around;
             margin-top: 15px;
             padding-top: 15px;
             border-top: 1px solid rgba(255, 255, 255, 0.2);
         }

         .share-stat {
             text-align: center;
         }

         .share-stat-value {
             font-size: 18px;
             font-weight: bold;
             color: #fbbf24;
         }

         .share-stat-label {
             font-size: 12px;
             color: rgba(255, 255, 255, 0.7);
         }

         /* 添加POI表单样式 */
         .add-poi-form {
             margin-bottom: 20px;
         }

         .add-poi-form .form-group {
             margin-bottom: 15px;
         }

         .add-poi-form .form-label {
             display: block;
             margin-bottom: 8px;
             font-weight: 500;
             color: rgba(255, 255, 255, 0.9);
             font-size: 14px;
         }

         .add-poi-form .form-input {
             width: 100%;
             padding: 10px 12px;
             border: 2px solid rgba(255, 255, 255, 0.2);
             border-radius: 8px;
             background: rgba(255, 255, 255, 0.1);
             color: white;
             font-size: 14px;
             transition: all 0.3s ease;
         }

         .add-poi-form .form-input:focus {
             outline: none;
             border-color: #fbbf24;
             background: rgba(255, 255, 255, 0.15);
         }

         .add-poi-form .form-input::placeholder {
             color: rgba(255, 255, 255, 0.5);
         }

         .coordinate-inputs {
             display: grid;
             grid-template-columns: 1fr 1fr;
             gap: 10px;
         }

         .coordinate-inputs .form-input {
             text-align: center;
             font-weight: bold;
         }

        /* 书架样式 */
        .bookshelf {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .book-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .book-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .book-cover {
            width: 100%;
            height: 120px;
            border-radius: 8px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .book-title {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .book-meta {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: space-between;
        }

        /* 故事详情样式 */
        .story-detail {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .story-detail.active {
            display: block;
        }

        .story-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .story-cover-large {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }

        .story-info h3 {
            margin-bottom: 5px;
            color: #fbbf24;
        }

        .story-info p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        .story-description {
            margin-bottom: 20px;
            line-height: 1.6;
        }

        /* 路线概览样式 */
        .route-overview {
            margin-bottom: 20px;
        }

        .route-info-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .route-info-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .route-info-item:last-child {
            border-bottom: none;
        }

        .route-info-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .route-info-content {
            flex: 1;
        }

        .route-info-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 2px;
        }

        .route-info-value {
            font-size: 14px;
            font-weight: 500;
            color: white;
        }

        .story-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #fbbf24;
        }

        .stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* 路线视图切换 */
        .route-view-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .route-tab {
            flex: 1;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .route-tab:hover {
            border-color: #fbbf24;
            background: rgba(255, 255, 255, 0.15);
        }

        .route-tab.active {
            border-color: #fbbf24;
            background: rgba(251, 191, 36, 0.1);
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.3);
        }

        /* 故事地图样式 */
        .story-treasure-map {
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.8), rgba(59, 130, 246, 0.6));
            border: 2px solid rgba(251, 191, 36, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .story-map-container {
            height: 200px;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1));
            border-radius: 10px;
            position: relative;
            margin-bottom: 15px;
            border: 1px solid rgba(251, 191, 36, 0.2);
        }

        .story-poi-point {
            position: absolute;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);
            animation: poiGlow 2s infinite;
        }

        .story-poi-point:hover {
            transform: scale(1.3);
            box-shadow: 0 6px 20px rgba(251, 191, 36, 0.6);
        }

        .story-poi-point.completed {
            background: linear-gradient(135deg, #10b981, #059669);
            animation: completedPulse 2s infinite;
        }

        .story-poi-point.interactive {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
            animation: interactiveGlow 2s infinite;
        }

        .story-poi-point.interactive:hover {
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.6);
        }

        .interaction-indicator {
            position: absolute;
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            animation: indicatorPulse 1.5s infinite;
            z-index: 10;
        }

        @keyframes interactiveGlow {
            0%, 100% {
                box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
            }
            50% {
                box-shadow: 0 4px 25px rgba(139, 92, 246, 0.8);
            }
        }

        @keyframes indicatorPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.8;
            }
        }

        .story-poi-label {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .story-poi-point:hover + .story-poi-label {
            opacity: 1;
        }

        .story-progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .story-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .story-progress-text {
            text-align: center;
            font-size: 14px;
            color: #fbbf24;
            font-weight: 500;
        }

        /* 文字路线样式 */
        .route-timeline {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
        }

        .timeline-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .timeline-item:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: #fbbf24;
            transform: translateY(-2px);
        }

        .timeline-item.completed {
            background: rgba(16, 185, 129, 0.1);
            border-color: #10b981;
        }

        .timeline-time {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
            color: white;
        }

        .timeline-location {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
        }

        .timeline-description {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.4;
        }

        .interaction-badge {
            display: inline-block;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            margin-top: 8px;
            animation: badgeGlow 2s ease-in-out infinite alternate;
        }

        @keyframes badgeGlow {
            0% {
                box-shadow: 0 0 5px rgba(139, 92, 246, 0.5);
            }
            100% {
                box-shadow: 0 0 15px rgba(139, 92, 246, 0.8);
            }
        }

        /* 创建故事界面样式 */
        .story-creation-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-back {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-back:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .story-basic-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-header h5 {
            color: #fbbf24;
            font-size: 16px;
            font-weight: 600;
        }

        .btn-add {
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .locations-section,
        .surprises-section,
        .collaboration-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .locations-list,
        .surprises-list,
        .collaborators-list {
            min-height: 60px;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
        }

        .location-item,
        .surprise-item,
        .collaborator-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .location-item:hover,
        .surprise-item:hover,
        .collaborator-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .item-title {
            font-weight: 600;
            color: white;
        }

        .item-actions {
            display: flex;
            gap: 8px;
        }

        .btn-edit,
        .btn-delete {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            color: white;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-edit:hover {
            background: rgba(59, 130, 246, 0.3);
        }

        .btn-delete:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .item-details {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.4;
        }

        .item-badge {
            display: inline-block;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 8px;
        }

        /* 模态框样式 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
            border-radius: 16px;
            padding: 0;
            max-width: 90%;
            width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header h4 {
            color: #fbbf24;
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .permissions-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .permission-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            cursor: pointer;
        }

        .permission-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #fbbf24;
        }

        .timeline-emoji {
            font-size: 24px;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .timeline-check {
            color: #10b981;
            font-size: 20px;
            margin-left: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .timeline-item.completed .timeline-check {
            opacity: 1;
        }

        /* 搜索栏 */
        .search-container {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            backdrop-filter: blur(10px);
        }

        .search-input:focus {
            outline: none;
            border-color: #fbbf24;
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        /* 过滤标签 */
        .filter-tags {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-tag {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-tag.active {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
        }

        /* 通知样式 */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .hidden {
            display: none;
        }

        /* 旅行规划表单样式 */
        .travel-form {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .form-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .form-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border-radius: 50%;
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 8px 20px rgba(251, 191, 36, 0.3);
        }

        .form-header h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #fbbf24;
        }

        .form-header p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        .form-section {
            display: grid;
            gap: 16px;
        }

        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .form-group select:focus {
            outline: none;
            border-color: #fbbf24;
            background: rgba(255, 255, 255, 0.15);
        }

        .form-group select option {
            background: #1e3a8a;
            color: white;
        }

        /* 进度条 */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 登录界面 -->
        <div id="loginContainer" class="login-container">
            <div class="login-logo">🚀</div>
            <h1 class="login-title">Web3旅行故事</h1>
            <p class="login-subtitle">开始你的游戏化旅行冒险</p>
            
            <div class="form-group">
                <label class="form-label">用户名</label>
                <input type="text" class="form-input" id="loginUsername" placeholder="输入你的用户名">
            </div>
            
            <div class="form-group">
                <label class="form-label">密码</label>
                <input type="password" class="form-input" id="loginPassword" placeholder="输入密码">
            </div>
            
            <button class="btn-game" onclick="login()">🚀 开始冒险</button>
        </div>

        <!-- 主应用 -->
        <div class="main-app" id="mainApp">
            <!-- 顶部状态栏 -->
            <div class="top-bar">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">🧭</div>
                    <div>
                        <div id="userName">冒险者</div>
                        <div style="font-size: 12px; color: rgba(255,255,255,0.7);">Level 1</div>
                    </div>
                </div>
                <div class="unc-balance" id="uncBalance">1000 UNC</div>
            </div>

            <!-- 标签栏 -->
            <div class="tab-bar">
                <div class="tab active" onclick="switchTab('design')">🎨 设计创建</div>
                <div class="tab" onclick="switchTab('library')">📚 故事库</div>
                <div class="tab" onclick="switchTab('create')">✍️ 创建故事</div>
                <div class="tab" onclick="switchTab('profile')">👤 我的</div>
            </div>

            <!-- 设计创建标签 -->
            <div id="designTab">
                <!-- 旅行规划表单 -->
                <div class="travel-form" id="travelForm">
                    <div class="form-header">
                        <div class="form-avatar">🎯</div>
                        <h3>旅行规划表</h3>
                        <p>填写以下信息，AI助手将为你生成专属藏宝图</p>
                    </div>
                    
                    <div class="form-section">
                        <div class="form-group">
                            <label class="form-label">🎯 目的地</label>
                            <select class="form-input" id="destinationSelect">
                                <option value="">选择目的地</option>
                                <option value="东京">东京</option>
                                <option value="巴黎">巴黎</option>
                                <option value="京都">京都</option>
                                <option value="威尼斯">威尼斯</option>
                                <option value="巴厘岛">巴厘岛</option>
                                <option value="圣托里尼">圣托里尼</option>
                                <option value="纽约">纽约</option>
                                <option value="伦敦">伦敦</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">📅 旅行天数</label>
                            <select class="form-input" id="durationSelect">
                                <option value="">选择天数</option>
                                <option value="1-3天">1-3天</option>
                                <option value="4-7天">4-7天</option>
                                <option value="8-14天">8-14天</option>
                                <option value="15天以上">15天以上</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">🍜 美食偏好</label>
                            <select class="form-input" id="foodSelect">
                                <option value="">选择美食类型</option>
                                <option value="当地特色">当地特色</option>
                                <option value="米其林餐厅">米其林餐厅</option>
                                <option value="街边小吃">街边小吃</option>
                                <option value="素食">素食</option>
                                <option value="海鲜">海鲜</option>
                                <option value="甜点">甜点</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">🎭 旅行氛围</label>
                            <select class="form-input" id="atmosphereSelect">
                                <option value="">选择氛围</option>
                                <option value="浪漫">浪漫</option>
                                <option value="历史">历史</option>
                                <option value="放松">放松</option>
                                <option value="冒险">冒险</option>
                                <option value="文化">文化</option>
                                <option value="购物">购物</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">👥 同行人数</label>
                            <select class="form-input" id="companionSelect">
                                <option value="">选择同行人数</option>
                                <option value="独自旅行">独自旅行</option>
                                <option value="情侣">情侣</option>
                                <option value="朋友">朋友</option>
                                <option value="家庭">家庭</option>
                                <option value="团队">团队</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">💰 预算范围</label>
                            <select class="form-input" id="budgetSelect">
                                <option value="">选择预算</option>
                                <option value="经济型">经济型</option>
                                <option value="中等">中等</option>
                                <option value="高端">高端</option>
                                <option value="奢华">奢华</option>
                            </select>
                        </div>
                    </div>
                    
                    <button class="btn-game" onclick="submitTravelForm()" id="submitFormBtn">🚀 提交给AI助手</button>
                </div>

                <!-- AI聊天界面 -->
                <div class="chat-container" id="chatContainer" style="display: none;">
                    <div class="message ai">
                        <div class="message-avatar">🤖</div>
                        <div class="message-content">
                            <div>🎯 欢迎来到AI旅行助手！我是你的专属旅行规划师。</div>
                            <div style="margin-top: 10px;">我已经收到你的旅行规划表，让我为你分析并生成专属藏宝图！</div>
                        </div>
                    </div>
                    
                    <!-- 聊天输入区域 -->
                    <div class="chat-input-container" id="chatInputContainer" style="display: none;">
                        <div class="chat-input-wrapper">
                            <input type="text" id="chatInput" class="chat-input" placeholder="💬 继续与AI对话，询问更多细节..." onkeypress="handleChatInput(event)">
                            <button class="chat-send-btn" onclick="sendChatMessage()">🚀</button>
                        </div>
                        <div class="chat-suggestions">
                            <button class="suggestion-btn" onclick="sendSuggestion('我想了解更多关于美食的推荐')">🍜 美食推荐</button>
                            <button class="suggestion-btn" onclick="sendSuggestion('有什么特别的景点吗？')">🏛️ 景点推荐</button>
                            <button class="suggestion-btn" onclick="sendSuggestion('帮我调整预算')">💰 预算调整</button>
                            <button class="suggestion-btn" onclick="sendSuggestion('生成藏宝图')">🗺️ 生成藏宝图</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 故事库标签 -->
            <div id="libraryTab" class="hidden">
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="🔍 搜索旅行故事..." id="searchInput">
                </div>
                
                <div class="filter-tags">
                    <div class="filter-tag active" onclick="filterStories('all')">全部</div>
                    <div class="filter-tag" onclick="filterStories('romance')">浪漫</div>
                    <div class="filter-tag" onclick="filterStories('adventure')">冒险</div>
                    <div class="filter-tag" onclick="filterStories('food')">美食</div>
                    <div class="filter-tag" onclick="filterStories('culture')">文化</div>
                    <div class="filter-tag" onclick="filterStories('free')">免费</div>
                </div>

                <!-- 故事详情 -->
                <div class="story-detail" id="storyDetail">
                    <div class="story-header">
                        <div class="story-cover-large" id="storyCoverLarge">🍜</div>
                        <div class="story-info">
                            <h3 id="storyTitle">东京美食之旅</h3>
                            <p id="storyCreator">创作者: 美食达人</p>
                            <p id="storyLocation">📍 东京, 日本</p>
                            <p id="storyDuration">⏱️ 3天2夜</p>
                        </div>
                    </div>
                    
                    <div class="story-description" id="storyDescription">
                        探索东京最地道的美食，从街边小吃到米其林餐厅，体验日本独特的饮食文化。这个旅程将带你穿越东京的大街小巷，发现隐藏的美食宝藏。
                    </div>
                    
                    <!-- 路线概览信息 -->
                    <div class="route-overview" id="routeOverview">
                        <div class="route-info-card">
                            <div class="route-info-item">
                                <div class="route-info-icon">🚀</div>
                                <div class="route-info-content">
                                    <div class="route-info-label">起点</div>
                                    <div class="route-info-value" id="routeStart">筑地市场</div>
                                </div>
                            </div>
                            <div class="route-info-item">
                                <div class="route-info-icon">🎯</div>
                                <div class="route-info-content">
                                    <div class="route-info-label">终点</div>
                                    <div class="route-info-value" id="routeEnd">涩谷十字路口</div>
                                </div>
                            </div>
                            <div class="route-info-item">
                                <div class="route-info-icon">⏱️</div>
                                <div class="route-info-content">
                                    <div class="route-info-label">总时长</div>
                                    <div class="route-info-value" id="routeTotalTime">12小时</div>
                                </div>
                            </div>
                            <div class="route-info-item">
                                <div class="route-info-icon">🎭</div>
                                <div class="route-info-content">
                                    <div class="route-info-label">互动点</div>
                                    <div class="route-info-value" id="routeInteractions">5个NPC互动</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="story-stats">
                        <div class="stat-item">
                            <div class="stat-value">4.8</div>
                            <div class="stat-label">评分</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">128</div>
                            <div class="stat-label">评价</div>
                        </div>
                        <div class="stat-value" id="storyPrice" style="color: #10b981;">免费</div>
                        <div class="stat-label">价格</div>
                    </div>
                    
                    <!-- 路线视图切换 -->
                    <div class="route-view-tabs">
                        <button class="route-tab active" onclick="switchRouteView('map')">🗺️ 地图路线</button>
                        <button class="route-tab" onclick="switchRouteView('list')">📝 文字路线</button>
                    </div>
                    
                    <!-- 地图路线视图 -->
                    <div class="route-map-view" id="routeMapView">
                        <div class="story-treasure-map">
                            <div class="story-map-container" id="storyMapContainer">
                                <!-- 动态生成地图点位 -->
                            </div>
                            <div class="story-progress-bar">
                                <div class="story-progress-fill" id="storyProgressFill"></div>
                            </div>
                            <div class="story-progress-text" id="storyProgressText">0/5 点位已完成</div>
                        </div>
                    </div>
                    
                    <!-- 文字路线视图 -->
                    <div class="route-list-view hidden" id="routeListView">
                        <div class="route-timeline" id="routeTimeline">
                            <!-- 动态生成时间线 -->
                        </div>
                    </div>
                    
                    <button class="btn-game" onclick="joinStory()">📚 加入旅程</button>
                    <button class="btn-game" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); margin-top: 10px;" onclick="closeStoryDetail()">← 返回列表</button>
                </div>

                <div class="bookshelf" id="bookshelf">
                    <div class="book-card" onclick="showStoryDetail('tokyo')">
                        <div class="book-cover">🍜</div>
                        <div class="book-title">东京美食之旅</div>
                        <div class="book-meta">
                            <span>⭐ 4.8</span>
                            <span style="color: #10b981;">免费</span>
                        </div>
                    </div>
                    <div class="book-card" onclick="showStoryDetail('paris')">
                        <div class="book-cover">🗼</div>
                        <div class="book-title">巴黎艺术之旅</div>
                        <div class="book-meta">
                            <span>⭐ 4.9</span>
                            <span style="color: #fbbf24;">50 UNC</span>
                        </div>
                    </div>
                    <div class="book-card" onclick="showStoryDetail('kyoto')">
                        <div class="book-cover">⛩️</div>
                        <div class="book-title">京都古都之旅</div>
                        <div class="book-meta">
                            <span>⭐ 4.7</span>
                            <span style="color: #fbbf24;">30 UNC</span>
                        </div>
                    </div>
                    <div class="book-card" onclick="showStoryDetail('venice')">
                        <div class="book-cover">🛶</div>
                        <div class="book-title">威尼斯浪漫之旅</div>
                        <div class="book-meta">
                            <span>⭐ 4.9</span>
                            <span style="color: #8b5cf6;">100 UNC</span>
                        </div>
                    </div>
                    <div class="book-card" onclick="showStoryDetail('bali')">
                        <div class="book-cover">🌴</div>
                        <div class="book-title">巴厘岛度假之旅</div>
                        <div class="book-meta">
                            <span>⭐ 4.6</span>
                            <span style="color: #10b981;">免费</span>
                        </div>
                    </div>
                    <div class="book-card" onclick="showStoryDetail('santorini')">
                        <div class="book-cover">🏛️</div>
                        <div class="book-title">圣托里尼日落之旅</div>
                        <div class="book-meta">
                            <span>⭐ 4.8</span>
                            <span style="color: #fbbf24;">80 UNC</span>
                        </div>
                    </div>
                    <div class="book-card" onclick="showStoryDetail('luxembourg')">
                        <div class="book-cover">🏰</div>
                        <div class="book-title">卢森堡光明守护者之旅</div>
                        <div class="book-meta">
                            <span>⭐ 5.0</span>
                            <span style="color: #fbbf24;">150 UNC</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 创建故事标签 -->
            <div id="createTab" class="hidden">
                <h3 style="margin-bottom: 20px;">✍️ 创建你的旅行故事</h3>
                
                <!-- 故事创建界面 -->
                <div id="storyCreationInterface" style="display: none;">
                    <div class="story-creation-header">
                        <button class="btn-back" onclick="backToCreateMenu()">← 返回</button>
                        <h4>🎨 创建新故事</h4>
                    </div>
                    
                    <!-- 故事基本信息 -->
                    <div class="story-basic-info">
                        <div class="form-group">
                            <label>故事标题</label>
                            <input type="text" id="storyTitleInput" placeholder="给你的故事起个名字..." class="form-input">
                        </div>
                        <div class="form-group">
                            <label>故事描述</label>
                            <textarea id="storyDescriptionInput" placeholder="描述你的故事主题和特色..." class="form-input" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label>故事类型</label>
                            <select id="storyTypeSelect" class="form-input">
                                <option value="adventure">冒险探索</option>
                                <option value="romance">浪漫之旅</option>
                                <option value="culture">文化体验</option>
                                <option value="food">美食之旅</option>
                                <option value="nature">自然风光</option>
                                <option value="history">历史探索</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 地点管理 -->
                    <div class="locations-section">
                        <div class="section-header">
                            <h5>📍 添加地点</h5>
                            <button class="btn-add" onclick="showAddLocationModal()">+ 添加地点</button>
                        </div>
                        <div class="locations-list" id="locationsList">
                            <!-- 动态生成的地点列表 -->
                        </div>
                    </div>
                    
                    <!-- 惊喜设置 -->
                    <div class="surprises-section">
                        <div class="section-header">
                            <h5>🎭 设置惊喜</h5>
                            <button class="btn-add" onclick="showAddSurpriseModal()">+ 添加惊喜</button>
                        </div>
                        <div class="surprises-list" id="surprisesList">
                            <!-- 动态生成的惊喜列表 -->
                        </div>
                    </div>
                    
                    <!-- 协作邀请 -->
                    <div class="collaboration-section">
                        <div class="section-header">
                            <h5>🤝 邀请共创者</h5>
                            <button class="btn-add" onclick="showInviteModal()">+ 邀请好友</button>
                        </div>
                        <div class="collaborators-list" id="collaboratorsList">
                            <!-- 动态生成的共创者列表 -->
                        </div>
                    </div>
                    
                    <button class="btn-game" onclick="publishStory()">🚀 发布故事</button>
                </div>
                
                <!-- 创建故事主菜单 -->
                <div id="createStoryMenu">
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">🎨</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">AI故事构建器</div>
                            <div style="font-size: 14px; color: rgba(255,255,255,0.7);">基于你的打卡记录自动生成精彩故事</div>
                        </div>
                        <button class="btn-game" onclick="startStoryCreation()">🚀 开始创建故事</button>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px;">
                        <div style="text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 48px; margin-bottom: 10px;">🤝</div>
                            <div style="font-weight: 600; margin-bottom: 5px;">多人共创</div>
                            <div style="font-size: 14px; color: rgba(255,255,255,0.7);">邀请好友一起创作精彩故事</div>
                        </div>
                        <button class="btn-game" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);" onclick="inviteCollaborators()">👥 邀请共创者</button>
                    </div>
                </div>
            </div>

            <!-- 个人资料标签 -->
            <div id="profileTab" class="hidden">
                <h3 style="margin-bottom: 20px;">👤 我的资料</h3>
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <div class="user-avatar" id="profileAvatar">🧭</div>
                        <div>
                            <div style="font-weight: 600; margin-bottom: 5px;" id="profileName">冒险者</div>
                            <div style="font-size: 14px; color: rgba(255,255,255,0.7);">Web3旅行者</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                        <div>
                            <div style="font-size: 20px; font-weight: bold; color: #fbbf24;">5</div>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.7);">已完成旅程</div>
                        </div>
                        <div>
                            <div style="font-size: 20px; font-weight: bold; color: #10b981;">3</div>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.7);">创建故事</div>
                        </div>
                        <div>
                            <div style="font-size: 20px; font-weight: bold; color: #8b5cf6;">12</div>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.7);">获得徽章</div>
                        </div>
                    </div>
                </div>
                <button class="btn-game" style="background: linear-gradient(135deg, #ef4444, #dc2626);" onclick="logout()">🚪 退出登录</button>
            </div>
        </div>
    </div>

    <!-- 通知 -->
    <div class="notification" id="notification">
        <div id="notificationText">操作成功！</div>
    </div>

    <!-- POI分享弹窗 -->
    <div class="poi-share-modal" id="poiShareModal">
        <div class="share-content">
            <div class="share-header">
                <div class="share-title">分享打卡点</div>
                <button class="close-share" onclick="closeShareModal()">×</button>
            </div>
            
            <div class="share-poi-info">
                <div class="share-poi-emoji" id="sharePoiEmoji">🍜</div>
                <div class="share-poi-name" id="sharePoiName">美食街</div>
                <div class="share-poi-description" id="sharePoiDescription">发现当地特色美食</div>
            </div>
            
            <textarea class="share-content-input" id="shareContentInput" placeholder="分享你的打卡体验..."></textarea>
            
            <div class="share-actions">
                <button class="share-action-btn" onclick="shareToSocial('wechat')">
                    💬 微信
                </button>
                <button class="share-action-btn secondary" onclick="shareToSocial('weibo')">
                    📱 微博
                </button>
                <button class="share-action-btn" onclick="shareToSocial('douyin')">
                    🎵 抖音
                </button>
                <button class="share-action-btn secondary" onclick="shareToSocial('xiaohongshu')">
                    📖 小红书
                </button>
            </div>
            
            <div class="share-stats">
                <div class="share-stat">
                    <div class="share-stat-value" id="shareViews">0</div>
                    <div class="share-stat-label">浏览</div>
                </div>
                <div class="share-stat">
                    <div class="share-stat-value" id="shareLikes">0</div>
                    <div class="share-stat-label">点赞</div>
                </div>
                <div class="share-stat">
                    <div class="share-stat-value" id="shareRewards">+5</div>
                    <div class="share-stat-label">UNC奖励</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加POI弹窗 -->
    <div class="poi-share-modal" id="addPoiModal">
        <div class="share-content">
            <div class="share-header">
                <div class="share-title">添加新打卡点</div>
                <button class="close-share" onclick="closeAddPoiModal()">×</button>
            </div>
            
            <div class="add-poi-form">
                <div class="form-group">
                    <label class="form-label">点位类型</label>
                    <select id="newPoiType" class="form-input">
                        <option value="restaurant">🍽️ 餐厅</option>
                        <option value="museum">🏛️ 博物馆</option>
                        <option value="park">🌳 公园</option>
                        <option value="shopping">🛍️ 购物</option>
                        <option value="entertainment">🎮 娱乐</option>
                        <option value="nature">🏔️ 自然</option>
                        <option value="cafe">☕ 咖啡厅</option>
                        <option value="landmark">🗼 地标</option>
                        <option value="hotel">🏨 酒店</option>
                        <option value="viewpoint">🌅 观景点</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">点位名称</label>
                    <input id="newPoiName" class="form-input" placeholder="输入点位名称" maxlength="20">
                </div>
                <div class="form-group">
                    <label class="form-label">点位描述</label>
                    <textarea id="newPoiDescription" class="form-input" placeholder="描述这个打卡点..." rows="3" maxlength="100"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">位置坐标</label>
                    <div class="coordinate-inputs">
                        <input id="newPoiX" class="form-input" type="number" placeholder="X坐标" min="10" max="90" value="50">
                        <input id="newPoiY" class="form-input" type="number" placeholder="Y坐标" min="10" max="90" value="50">
                    </div>
                </div>
            </div>
            
            <div class="share-actions">
                <button class="share-action-btn secondary" onclick="closeAddPoiModal()">取消</button>
                <button class="share-action-btn" onclick="saveNewPOI()">✅ 添加点位</button>
            </div>
        </div>
    </div>

    <!-- POI评论弹窗 -->
    <div class="poi-share-modal" id="poiCommentsModal">
        <div class="share-content">
            <div class="share-header">
                <div class="share-title">打卡点详情</div>
                <button class="close-share" onclick="closeCommentsModal()">×</button>
            </div>
            
            <div class="poi-detail-info">
                <div class="poi-detail-emoji" id="poiDetailEmoji">🍜</div>
                <div class="poi-detail-name" id="poiDetailName">美食街</div>
                <div class="poi-detail-description" id="poiDetailDescription">发现当地特色美食</div>
                <div class="poi-detail-stats">
                    <span class="poi-stat">👥 <span id="poiVisitors">0</span> 访客</span>
                    <span class="poi-stat">⭐ <span id="poiRating">0.0</span> 评分</span>
                    <span class="poi-stat">📝 <span id="poiComments">0</span> 评论</span>
                </div>
            </div>
            
            <div class="comments-section">
                <div class="comments-header">
                    <h4>📝 用户评论</h4>
                    <button class="add-comment-btn" onclick="showAddCommentForm()">+ 添加评论</button>
                </div>
                
                <div class="comments-list" id="commentsList">
                    <!-- 评论列表将在这里动态生成 -->
                </div>
                
                <div class="add-comment-form" id="addCommentForm" style="display: none;">
                    <textarea class="comment-input" id="newCommentInput" placeholder="分享你的体验..." rows="3"></textarea>
                    <div class="comment-rating">
                        <span>评分：</span>
                        <div class="rating-stars">
                            <span class="star" data-rating="1">⭐</span>
                            <span class="star" data-rating="2">⭐</span>
                            <span class="star" data-rating="3">⭐</span>
                            <span class="star" data-rating="4">⭐</span>
                            <span class="star" data-rating="5">⭐</span>
                        </div>
                    </div>
                    <div class="comment-actions">
                        <button class="comment-btn secondary" onclick="hideAddCommentForm()">取消</button>
                        <button class="comment-btn" onclick="submitComment()">发布评论</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check if user has completed onboarding
        if (!localStorage.getItem('onboardingComplete')) {
            window.location.href = 'onboarding-flow.html';
        }

        // Load user data from onboarding
        let userData = {};
        try {
            userData = JSON.parse(localStorage.getItem('userData') || '{}');
        } catch (e) {
            console.log('No user data found');
        }

        let currentStep = 0;
        let uncBalance = 1000;
        let userName = userData.phone || '冒险者';
        let currentStory = null;
        let selectedAnswers = {};
        let travelFormData = {};

        // 故事数据
        const stories = {
            'tokyo': {
                name: '东京美食之旅',
                creator: '美食达人',
                location: '东京, 日本',
                description: '探索东京最地道的美食，从街边小吃到米其林餐厅，体验日本独特的饮食文化。这个旅程将带你穿越东京的大街小巷，发现隐藏的美食宝藏。',
                rating: 4.8,
                reviews: 128,
                price: 0,
                emoji: '🍜',
                duration: '3天2夜',
                route: [
                    { id: 't1', name: '筑地市场', time: '09:00', location: '筑地, 东京', type: 'food', emoji: '🐟', description: '世界最大的鱼市场，品尝最新鲜的寿司', completed: false },
                    { id: 't2', name: '浅草寺', time: '11:00', location: '浅草, 东京', type: 'culture', emoji: '⛩️', description: '东京最古老的寺庙，感受传统日本文化', completed: false },
                    { id: 't3', name: '银座购物', time: '14:00', location: '银座, 东京', type: 'shopping', emoji: '🛍️', description: '高端购物区，体验现代东京的繁华', completed: false },
                    { id: 't4', name: '新宿夜景', time: '19:00', location: '新宿, 东京', type: 'view', emoji: '🌃', description: '登上东京都厅，俯瞰东京夜景', completed: false },
                    { id: 't5', name: '涩谷十字路口', time: '21:00', location: '涩谷, 东京', type: 'culture', emoji: '🚶', description: '世界最繁忙的十字路口，感受东京的活力', completed: false }
                ]
            },
            'paris': {
                name: '巴黎艺术之旅',
                creator: '艺术爱好者',
                location: '巴黎, 法国',
                description: '漫步艺术之都，感受浪漫与艺术的完美结合。从卢浮宫到埃菲尔铁塔，从塞纳河到蒙马特高地，体验巴黎独特的艺术氛围。',
                rating: 4.9,
                reviews: 95,
                price: 50,
                emoji: '🗼',
                duration: '4天3夜',
                route: [
                    { id: 'p1', name: '卢浮宫', time: '09:00', location: '第1区, 巴黎', type: 'museum', emoji: '🏛️', description: '世界最大的艺术博物馆，欣赏蒙娜丽莎', completed: false },
                    { id: 'p2', name: '埃菲尔铁塔', time: '14:00', location: '第7区, 巴黎', type: 'landmark', emoji: '🗼', description: '巴黎的标志性建筑，俯瞰整个城市', completed: false },
                    { id: 'p3', name: '塞纳河游船', time: '16:00', location: '塞纳河, 巴黎', type: 'cruise', emoji: '🚢', description: '乘船游览塞纳河，欣赏两岸风光', completed: false },
                    { id: 'p4', name: '香榭丽舍大街', time: '18:00', location: '第8区, 巴黎', type: 'shopping', emoji: '🛍️', description: '世界最美丽的街道，购物和漫步', completed: false },
                    { id: 'p5', name: '蒙马特高地', time: '20:00', location: '第18区, 巴黎', type: 'culture', emoji: '🎨', description: '艺术家聚集地，欣赏圣心大教堂', completed: false }
                ]
            },
            'kyoto': {
                name: '京都古都之旅',
                creator: '文化探索者',
                location: '京都, 日本',
                description: '体验日本传统文化，感受千年古都的魅力。从金阁寺到清水寺，从岚山竹林到祗园，探索日本最纯粹的文化精髓。',
                rating: 4.7,
                reviews: 156,
                price: 30,
                emoji: '⛩️',
                duration: '3天2夜',
                route: [
                    { id: 'k1', name: '金阁寺', time: '08:00', location: '北区, 京都', type: 'temple', emoji: '🏯', description: '世界文化遗产，金碧辉煌的寺庙', completed: false },
                    { id: 'k2', name: '清水寺', time: '11:00', location: '东山区, 京都', type: 'temple', emoji: '⛩️', description: '京都最古老的寺庙，悬空舞台', completed: false },
                    { id: 'k3', name: '岚山竹林', time: '14:00', location: '右京区, 京都', type: 'nature', emoji: '🎋', description: '漫步竹林小径，感受自然之美', completed: false },
                    { id: 'k4', name: '祗园', time: '16:00', location: '东山区, 京都', type: 'culture', emoji: '🎭', description: '传统艺伎区，体验日本传统文化', completed: false },
                    { id: 'k5', name: '二条城', time: '18:00', location: '中京区, 京都', type: 'castle', emoji: '🏰', description: '德川幕府的京都行宫', completed: false }
                ]
            },
            'venice': {
                name: '威尼斯浪漫之旅',
                creator: '浪漫主义者',
                location: '威尼斯, 意大利',
                description: '在世界上最浪漫的城市中迷失，乘坐贡多拉穿梭于古老的运河之间，感受威尼斯的独特魅力和浪漫氛围。',
                rating: 4.9,
                reviews: 89,
                price: 100,
                emoji: '🛶',
                duration: '3天2夜',
                route: [
                    { id: 'v1', name: '圣马可广场', time: '09:00', location: '圣马可区, 威尼斯', type: 'landmark', emoji: '⛪', description: '威尼斯的心脏，欣赏圣马可大教堂', completed: false },
                    { id: 'v2', name: '贡多拉游船', time: '11:00', location: '大运河, 威尼斯', type: 'cruise', emoji: '🛶', description: '乘坐传统贡多拉，穿梭于运河之间', completed: false },
                    { id: 'v3', name: '里亚托桥', time: '14:00', location: '圣保罗区, 威尼斯', type: 'bridge', emoji: '🌉', description: '威尼斯最古老的桥梁，欣赏运河风光', completed: false },
                    { id: 'v4', name: '穆拉诺岛', time: '16:00', location: '穆拉诺岛, 威尼斯', type: 'island', emoji: '🏝️', description: '玻璃岛，观看传统玻璃制作', completed: false },
                    { id: 'v5', name: '叹息桥', time: '18:00', location: '圣马可区, 威尼斯', type: 'bridge', emoji: '🌉', description: '连接监狱和法院的著名桥梁', completed: false }
                ]
            },
            'bali': {
                name: '巴厘岛度假之旅',
                creator: '度假专家',
                location: '巴厘岛, 印尼',
                description: '在热带天堂中放松身心，享受阳光、沙滩和海浪。从乌布到库塔，体验巴厘岛独特的自然风光和文化。',
                rating: 4.6,
                reviews: 203,
                price: 0,
                emoji: '🌴',
                duration: '5天4夜',
                route: [
                    { id: 'b1', name: '乌布皇宫', time: '09:00', location: '乌布, 巴厘岛', type: 'palace', emoji: '🏰', description: '传统巴厘岛建筑，感受皇室文化', completed: false },
                    { id: 'b2', name: '梯田徒步', time: '11:00', location: '德格拉朗, 巴厘岛', type: 'nature', emoji: '🌾', description: '徒步梯田，欣赏绿色美景', completed: false },
                    { id: 'b3', name: '库塔海滩', time: '14:00', location: '库塔, 巴厘岛', type: 'beach', emoji: '🏖️', description: '享受阳光沙滩，体验冲浪', completed: false },
                    { id: 'b4', name: '海神庙', time: '16:00', location: '塔纳洛特, 巴厘岛', type: 'temple', emoji: '⛩️', description: '建在海边的神圣寺庙', completed: false },
                    { id: 'b5', name: '金巴兰日落', time: '18:00', location: '金巴兰, 巴厘岛', type: 'sunset', emoji: '🌅', description: '欣赏壮观的日落美景', completed: false }
                ]
            },
            'santorini': {
                name: '圣托里尼日落之旅',
                creator: '摄影爱好者',
                location: '圣托里尼, 希腊',
                description: '在爱琴海最美的岛屿上欣赏世界上最壮观的日落，漫步于白色建筑群中，感受希腊的浪漫与神秘。',
                rating: 4.8,
                reviews: 167,
                price: 80,
                emoji: '🏛️',
                duration: '4天3夜',
                route: [
                    { id: 's1', name: '伊亚小镇', time: '09:00', location: '伊亚, 圣托里尼', type: 'village', emoji: '🏘️', description: '蓝顶白墙的美丽小镇', completed: false },
                    { id: 's2', name: '费拉小镇', time: '12:00', location: '费拉, 圣托里尼', type: 'village', emoji: '🏘️', description: '圣托里尼的首府，悬崖上的城市', completed: false },
                    { id: 's3', name: '红沙滩', time: '15:00', location: '阿克洛蒂里, 圣托里尼', type: 'beach', emoji: '🏖️', description: '独特的红色沙滩，火山岩形成', completed: false },
                    { id: 's4', name: '火山岛', time: '17:00', location: '火山岛, 圣托里尼', type: 'volcano', emoji: '🌋', description: '乘船前往火山岛，了解地质历史', completed: false },
                    { id: 's5', name: '伊亚日落', time: '19:00', location: '伊亚, 圣托里尼', type: 'sunset', emoji: '🌅', description: '世界最美的日落，浪漫时刻', completed: false }
                ]
            },
            'luxembourg': {
                name: '卢森堡光明守护者之旅',
                creator: '历史守护者',
                location: '卢森堡, 卢森堡',
                description: '🌟 核心主题："只要有人愿意站出来，光明就不会消失" - 每个时代都有自己的黑暗时刻，但总有人愿意站出来，用微光点燃希望。从玛丽一世的孤独坚守，到二战抵抗者的无畏牺牲，再到现代人的文化守护——这就是卢森堡精神的真正内核。',
                rating: 5.0,
                reviews: 89,
                price: 150,
                emoji: '🏰',
                duration: '1天完成',
                route: [
                    { id: 'l1', name: '卢森堡大公宫', time: '09:00-10:30', location: '大公宫, 卢森堡', type: 'palace', emoji: '🏰', description: '第一幕：孤独女王的站立（1324年）- 玛丽一世生活的地方，体验中世纪宫廷礼仪，参与古代密码破译和政治局势推演', completed: false },
                    { id: 'l2', name: '圣母主教座堂', time: '10:30-11:00', location: '主教座堂, 卢森堡', type: 'church', emoji: '⛪', description: '祷告场景体验 - 学习拉丁语主祷文，了解哥特式教堂的宗教象征意义，感受历史氛围', completed: false },
                    { id: 'l3', name: '军事博物馆地下室', time: '11:00-12:00', location: '军事博物馆, 卢森堡', type: 'museum', emoji: '🛡️', description: '第二幕：地下的微光（1940-1944年）- 二战防空洞遗址，体验密码电报破译，地下印刷厂体验，感受抵抗运动精神', completed: false },
                    { id: 'l4', name: 'Café um Pëtz', time: '12:00-13:00', location: '旧城区, 卢森堡', type: 'cafe', emoji: '☕', description: '历史美食联动体验 - 三时代主题套餐：中世纪套餐、二战时期套餐、现代套餐，感受不同时代的美食文化', completed: false },
                    { id: 'l5', name: '阿道夫桥', time: '14:00-15:00', location: '阿道夫桥, 卢森堡', type: 'bridge', emoji: '🌉', description: '时空交汇场景 - 三时代幻影汇聚，360度历史观察，寻找历史地标，朗读"卢森堡自由誓言"', completed: false },
                    { id: 'l6', name: '佩特吕斯要塞', time: '15:00-16:30', location: '佩特吕斯要塞, 卢森堡', type: 'fortress', emoji: '🏛️', description: '第三幕：光明的传承（2025年现代）- 现代危机场景，三时代幻影的最终汇聚，玩家终极选择，体验卢森堡不屈防御精神', completed: false },
                    { id: 'l7', name: '结局仪式', time: '16:30-17:30', location: '要塞观景台, 卢森堡', type: 'ceremony', emoji: '🕯️', description: '感人至深的最终仪式 - 三支大火炬点亮，全体NPC出现，齐声朗读卢森堡永恒誓言，主题升华总结', completed: false }
                ]
            }
        };

        function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showNotification('请输入用户名和密码');
                return;
            }
            
            userName = username;
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainApp').classList.add('active');
            
            // 更新用户信息
            document.getElementById('userName').textContent = userName;
            document.getElementById('profileName').textContent = userName;
            
            showNotification('欢迎回来，' + userName + '！');
        }

        function logout() {
            if (confirm('确定要退出登录吗？')) {
                // Clear onboarding data
                localStorage.removeItem('onboardingComplete');
                localStorage.removeItem('userData');
                
                // Redirect to onboarding
                window.location.href = 'onboarding-flow.html';
            }
        }

        function switchTab(tab) {
            // 隐藏所有标签内容
            document.querySelectorAll('[id$="Tab"]').forEach(content => {
                content.classList.add('hidden');
            });
            
            // 移除所有标签的active类
            document.querySelectorAll('.tab').forEach(tabEl => {
                tabEl.classList.remove('active');
            });
            
            // 显示选中的标签内容
            document.getElementById(tab + 'Tab').classList.remove('hidden');
            
            // 添加active类到选中的标签
            event.target.classList.add('active');
        }

        function selectOption(question, answer) {
            selectedAnswers[question] = answer;
            
            // 更新按钮状态
            const optionBtns = event.target.parentElement.querySelectorAll('.option-btn');
            optionBtns.forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            
            // 检查是否所有问题都已回答
            const questions = ['destination', 'duration', 'food', 'atmosphere'];
            const allAnswered = questions.every(q => selectedAnswers[q]);
            
            if (allAnswered) {
                document.getElementById('generateBtn').disabled = false;
                showNotification('所有问题已回答，可以生成藏宝图了！');
            }
        }

                 function generateTreasureMap() {
             // 隐藏问题表单
             document.getElementById('questionForm').style.display = 'none';
             
             // 添加用户回答到聊天
             addMessage(`我的旅行偏好：${selectedAnswers.destination} | ${selectedAnswers.duration} | ${selectedAnswers.food} | ${selectedAnswers.atmosphere}`, 'user');
             
             // AI回复
             setTimeout(() => {
                 addMessage("🎉 太棒了！基于你的回答，我正在生成专属藏宝图...", 'ai');
                 
                 setTimeout(() => {
                     addMessage("🗺️ 你的专属藏宝图已生成！点击发光点位进行打卡，完成旅程获得丰厚奖励！", 'ai');
                     
                     // 在聊天中添加游戏化藏宝图
                     const mapMessage = document.createElement('div');
                     mapMessage.className = 'message ai';
                     mapMessage.innerHTML = `
                         <div class="message-avatar">🤖</div>
                         <div class="message-content">
                             <div class="treasure-map">
                                 <div class="map-container">
                                     <div style="position: relative; width: 100%; height: 100%;">
                                         <div class="poi-point" data-poi="poi1" style="top: 20%; left: 30%;" onclick="checkIn('poi1')" title="🍜 美食街"></div>
                                         <div class="poi-label" style="top: 15%; left: 30%;">🍜 美食街</div>
                                         
                                         <div class="poi-point" data-poi="poi2" style="top: 40%; left: 60%;" onclick="checkIn('poi2')" title="🏛️ 历史古迹"></div>
                                         <div class="poi-label" style="top: 35%; left: 60%;">🏛️ 历史古迹</div>
                                         
                                         <div class="poi-point" data-poi="poi3" style="top: 60%; left: 20%;" onclick="checkIn('poi3')" title="🎭 文化体验"></div>
                                         <div class="poi-label" style="top: 55%; left: 20%;">🎭 文化体验</div>
                                         
                                         <div class="poi-point" data-poi="poi4" style="top: 80%; left: 70%;" onclick="checkIn('poi4')" title="🌅 观景点"></div>
                                         <div class="poi-label" style="top: 75%; left: 70%;">🌅 观景点</div>
                                         
                                         <div class="poi-point" data-poi="poi5" style="top: 50%; left: 50%;" onclick="checkIn('poi5')" title="🎪 隐藏宝藏"></div>
                                         <div class="poi-label" style="top: 45%; left: 50%;">🎪 隐藏宝藏</div>
                                     </div>
                                 </div>
                                 
                                 <div class="progress-bar" style="margin: 15px 0;">
                                     <div class="progress-fill" id="mapProgress" style="width: 0%;"></div>
                                 </div>
                                 
                                 <div style="text-align: center; margin-bottom: 15px; font-size: 14px; color: #fbbf24;">
                                     <span id="progressText">0/5 点位已完成</span>
                                 </div>
                                 
                                 <div class="map-controls">
                                     <div class="map-btn active" onclick="switchMapView('all')">🗺️ 全部</div>
                                     <div class="map-btn" onclick="switchMapView('completed')">✅ 已完成</div>
                                     <div class="map-btn" onclick="switchMapView('remaining')">🎯 待完成</div>
                                     <div class="map-btn" onclick="customizePOI()">⚙️ 自定义</div>
                                 </div>
                                 
                                 <div class="poi-options" id="poiOptions" style="display: none;">
                                     <div class="poi-option" onclick="replacePOI('restaurant')">🍽️ 餐厅</div>
                                     <div class="poi-option" onclick="replacePOI('museum')">🏛️ 博物馆</div>
                                     <div class="poi-option" onclick="replacePOI('park')">🌳 公园</div>
                                     <div class="poi-option" onclick="replacePOI('shopping')">🛍️ 购物</div>
                                     <div class="poi-option" onclick="replacePOI('entertainment')">🎮 娱乐</div>
                                     <div class="poi-option" onclick="replacePOI('nature')">🏔️ 自然</div>
                                 </div>
                             </div>
                         </div>
                     `;
                     
                     document.getElementById('chatContainer').appendChild(mapMessage);
                     
                     // 完成奖励
                     uncBalance += 25;
                     updateUncBalance();
                     showNotification('+25 UNC 完成奖励！');
                 }, 2000);
             }, 1000);
         }

        function addMessage(text, sender) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = sender === 'user' ? '👤' : '🤖';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            content.innerHTML = text;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            container.appendChild(messageDiv);
            
            // 滚动到底部
            container.scrollTop = container.scrollHeight;
        }

                 let completedPOIs = new Set();
         let currentMapView = 'all';
         let selectedPOIForReplacement = null;

         function checkIn(poiId) {
             if (completedPOIs.has(poiId)) {
                 showNotification('✅ 这个点位已经打卡过了！');
                 return;
             }
             
             const poiElement = event.target;
             const poiLabel = poiElement.nextElementSibling;
             
             // 标记为已完成
             completedPOIs.add(poiId);
             poiElement.classList.add('completed');
             poiElement.onclick = null; // 移除点击事件
             
             // 更新标签
             if (poiLabel) {
                 poiLabel.style.color = '#10b981';
             }
             
             // 奖励
             const rewards = {
                 'poi1': 15, // 美食街
                 'poi2': 20, // 历史古迹
                 'poi3': 18, // 文化体验
                 'poi4': 25, // 观景点
                 'poi5': 50  // 隐藏宝藏
             };
             
             const reward = rewards[poiId] || 10;
             uncBalance += reward;
             updateUncBalance();
             
             showNotification(`✅ 打卡成功！+${reward} UNC`);
             
             // 更新进度条
             updateMapProgress();
             
             // 检查是否完成所有点位
             if (completedPOIs.size === 5) {
                 setTimeout(() => {
                     showNotification('🎉 恭喜！你已完成所有打卡点，获得额外奖励！');
                     uncBalance += 100;
                     updateUncBalance();
                 }, 1000);
             }
         }

         function switchMapView(view) {
             currentMapView = view;
             
             // 更新按钮状态
             document.querySelectorAll('.map-btn').forEach(btn => {
                 btn.classList.remove('active');
             });
             event.target.classList.add('active');
             
             // 显示/隐藏点位
             const poiPoints = document.querySelectorAll('.poi-point');
             poiPoints.forEach(poi => {
                 const poiId = poi.getAttribute('data-poi');
                 const isCompleted = completedPOIs.has(poiId);
                 
                 switch(view) {
                     case 'all':
                         poi.style.display = 'block';
                         break;
                     case 'completed':
                         poi.style.display = isCompleted ? 'block' : 'none';
                         break;
                     case 'remaining':
                         poi.style.display = isCompleted ? 'none' : 'block';
                         break;
                 }
             });
             
             showNotification(`🗺️ 切换到${view === 'all' ? '全部' : view === 'completed' ? '已完成' : '待完成'}视图`);
         }

         function customizePOI() {
             const poiOptions = document.getElementById('poiOptions');
             if (poiOptions) {
                 poiOptions.style.display = poiOptions.style.display === 'none' ? 'grid' : 'none';
                 showNotification('⚙️ 点击要替换的点位，然后选择新的类型');
             }
         }

         function replacePOI(newType) {
             if (!selectedPOIForReplacement) {
                 showNotification('请先点击要替换的点位');
                 return;
             }
             
             const poiTypes = {
                 'restaurant': { emoji: '🍽️', name: '餐厅' },
                 'museum': { emoji: '🏛️', name: '博物馆' },
                 'park': { emoji: '🌳', name: '公园' },
                 'shopping': { emoji: '🛍️', name: '购物' },
                 'entertainment': { emoji: '🎮', name: '娱乐' },
                 'nature': { emoji: '🏔️', name: '自然' }
             };
             
             const type = poiTypes[newType];
             if (type) {
                 selectedPOIForReplacement.setAttribute('title', `${type.emoji} ${type.name}`);
                 
                 // 更新对应的标签
                 const poiId = selectedPOIForReplacement.getAttribute('data-poi');
                 const label = selectedPOIForReplacement.nextElementSibling;
                 if (label) {
                     label.textContent = `${type.emoji} ${type.name}`;
                 }
                 
                 showNotification(`✅ 点位已替换为${type.name}`);
                 
                 // 重置选择状态
                 selectedPOIForReplacement = null;
                 document.getElementById('poiOptions').style.display = 'none';
             }
         }

         // 添加点位选择功能
         document.addEventListener('click', function(e) {
             if (e.target.classList.contains('poi-point') && document.getElementById('poiOptions').style.display === 'grid') {
                 // 移除之前的选择
                 document.querySelectorAll('.poi-point').forEach(poi => {
                     poi.style.border = '2px solid rgba(255, 255, 255, 0.3)';
                 });
                 
                 // 标记当前选择
                 e.target.style.border = '2px solid #fbbf24';
                 selectedPOIForReplacement = e.target;
                 
                 showNotification('✅ 已选择点位，请选择新的类型');
             }
         });

                 let currentStoryId = null;
         let currentStoryCompletedPOIs = new Set();
         
         // POI评论数据
         let poiCommentsData = {};
         let currentPoiId = null;
         let selectedRating = 0;

        function showStoryDetail(storyId) {
            const story = stories[storyId];
            if (!story) return;
            
            currentStoryId = storyId;
            currentStoryCompletedPOIs = new Set();
            
            // 隐藏书架，显示详情
            document.getElementById('bookshelf').style.display = 'none';
            document.getElementById('storyDetail').classList.add('active');
            
            // 更新详情内容
            document.getElementById('storyCoverLarge').textContent = story.emoji;
            document.getElementById('storyTitle').textContent = story.name;
            document.getElementById('storyCreator').textContent = '创作者: ' + story.creator;
            document.getElementById('storyLocation').textContent = '📍 ' + story.location;
            document.getElementById('storyDuration').textContent = '⏱️ ' + story.duration;
            document.getElementById('storyDescription').textContent = story.description;
            document.getElementById('storyPrice').textContent = story.price === 0 ? '免费' : story.price + ' UNC';
            
            // 更新路线概览信息
            updateRouteOverview(story);
            
            // 生成地图路线
            generateStoryMap(story);
            
            // 生成文字路线
            generateStoryTimeline(story);
            
            // 更新进度
            updateStoryProgress();
            
            currentStory = story;
        }

        function closeStoryDetail() {
            document.getElementById('storyDetail').classList.remove('active');
            document.getElementById('bookshelf').style.display = 'grid';
            currentStoryId = null;
        }

        function updateRouteOverview(story) {
            if (!story.route || story.route.length === 0) return;
            
            const startPOI = story.route[0];
            const endPOI = story.route[story.route.length - 1];
            
            // 计算总时长
            let totalTime = '';
            if (story.duration) {
                totalTime = story.duration;
            } else {
                // 从路线中计算时长
                const firstTime = startPOI.time;
                const lastTime = endPOI.time;
                if (firstTime && lastTime) {
                    totalTime = `${firstTime} - ${lastTime}`;
                }
            }
            
            // 计算互动点数量（包含NPC互动的点位）
            const interactionPOIs = story.route.filter(poi => 
                poi.description && (
                    poi.description.includes('NPC') || 
                    poi.description.includes('互动') || 
                    poi.description.includes('体验') ||
                    poi.description.includes('角色') ||
                    poi.description.includes('演员')
                )
            );
            
            // 更新路线概览信息
            document.getElementById('routeStart').textContent = startPOI.name;
            document.getElementById('routeEnd').textContent = endPOI.name;
            document.getElementById('routeTotalTime').textContent = totalTime;
            document.getElementById('routeInteractions').textContent = `${interactionPOIs.length}个互动点`;
        }

        function generateStoryMap(story) {
            const mapContainer = document.getElementById('storyMapContainer');
            mapContainer.innerHTML = '';
            
            story.route.forEach((poi, index) => {
                // 计算点位位置（在200px高度的容器中分布）
                const x = 20 + (index * 15) + (Math.random() * 10);
                const y = 20 + (index * 20) + (Math.random() * 15);
                
                // 检查是否为互动点
                const isInteractive = poi.description && (
                    poi.description.includes('NPC') || 
                    poi.description.includes('互动') || 
                    poi.description.includes('体验') ||
                    poi.description.includes('角色') ||
                    poi.description.includes('演员')
                );
                
                // 创建POI点
                const poiPoint = document.createElement('div');
                poiPoint.className = 'story-poi-point';
                if (isInteractive) {
                    poiPoint.classList.add('interactive');
                }
                poiPoint.setAttribute('data-poi', poi.id);
                poiPoint.style.left = x + '%';
                poiPoint.style.top = y + '%';
                poiPoint.textContent = poi.emoji;
                poiPoint.onclick = () => checkInStoryPOI(poi.id);
                
                // 创建标签
                const poiLabel = document.createElement('div');
                poiLabel.className = 'story-poi-label';
                poiLabel.textContent = poi.name;
                poiLabel.style.left = x + '%';
                poiLabel.style.top = (y - 30) + '%';
                
                // 如果是互动点，添加特殊标识
                if (isInteractive) {
                    const interactionIndicator = document.createElement('div');
                    interactionIndicator.className = 'interaction-indicator';
                    interactionIndicator.textContent = '🎭';
                    interactionIndicator.style.left = (x + 5) + '%';
                    interactionIndicator.style.top = (y - 15) + '%';
                    mapContainer.appendChild(interactionIndicator);
                }
                
                mapContainer.appendChild(poiPoint);
                mapContainer.appendChild(poiLabel);
            });
        }

        function generateStoryTimeline(story) {
            const timelineContainer = document.getElementById('routeTimeline');
            timelineContainer.innerHTML = '';
            
            story.route.forEach(poi => {
                const timelineItem = document.createElement('div');
                timelineItem.className = 'timeline-item';
                timelineItem.setAttribute('data-poi', poi.id);
                timelineItem.onclick = () => checkInStoryPOI(poi.id);
                
                // 检查是否为互动点
                const isInteractive = poi.description && (
                    poi.description.includes('NPC') || 
                    poi.description.includes('互动') || 
                    poi.description.includes('体验') ||
                    poi.description.includes('角色') ||
                    poi.description.includes('演员')
                );
                
                // 生成互动标签
                let interactionBadge = '';
                if (isInteractive) {
                    interactionBadge = '<div class="interaction-badge">🎭 NPC互动</div>';
                }
                
                timelineItem.innerHTML = `
                    <div class="timeline-emoji">${poi.emoji}</div>
                    <div class="timeline-time">${poi.time}</div>
                    <div class="timeline-content">
                        <div class="timeline-title">${poi.name}</div>
                        <div class="timeline-location">📍 ${poi.location}</div>
                        <div class="timeline-description">${poi.description}</div>
                        ${interactionBadge}
                    </div>
                    <div class="timeline-check">✓</div>
                `;
                
                timelineContainer.appendChild(timelineItem);
            });
        }

        function checkInStoryPOI(poiId) {
            if (currentStoryCompletedPOIs.has(poiId)) {
                // 已完成点位，显示评论详情
                showStoryPOIComments(poiId);
                return;
            }
            
            currentStoryCompletedPOIs.add(poiId);
            
            // 更新地图点位
            const poiPoint = document.querySelector(`.story-poi-point[data-poi="${poiId}"]`);
            if (poiPoint) {
                poiPoint.classList.add('completed');
            }
            
            // 更新时间线项目
            const timelineItem = document.querySelector(`.timeline-item[data-poi="${poiId}"]`);
            if (timelineItem) {
                timelineItem.classList.add('completed');
            }
            
            // 更新进度
            updateStoryProgress();
            
            // 奖励UNC
            uncBalance += 10;
            updateUncBalance();
            
            showNotification(`🎉 打卡成功！获得 10 UNC`);
            
            // 检查是否完成所有点位
            const story = stories[currentStoryId];
            if (currentStoryCompletedPOIs.size === story.route.length) {
                setTimeout(() => {
                    showNotification('🎊 恭喜！你已完成整个旅程！获得额外 50 UNC 奖励！');
                    uncBalance += 50;
                    updateUncBalance();
                }, 1000);
            }
        }

        function updateStoryProgress() {
            if (!currentStoryId) return;
            
            const story = stories[currentStoryId];
            const completedCount = currentStoryCompletedPOIs.size;
            const totalCount = story.route.length;
            const progress = (completedCount / totalCount) * 100;
            
            document.getElementById('storyProgressFill').style.width = progress + '%';
            document.getElementById('storyProgressText').textContent = `${completedCount}/${totalCount} 点位已完成`;
        }

        function switchRouteView(view) {
            // 更新标签状态
            document.querySelectorAll('.route-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 切换视图
            if (view === 'map') {
                document.getElementById('routeMapView').classList.remove('hidden');
                document.getElementById('routeListView').classList.add('hidden');
            } else {
                document.getElementById('routeMapView').classList.add('hidden');
                document.getElementById('routeListView').classList.remove('hidden');
            }
        }

        function joinStory() {
            if (!currentStory) return;
            
            if (currentStory.price > uncBalance) {
                showNotification('❌ UNC余额不足！');
                return;
            }
            
            if (currentStory.price > 0) {
                uncBalance -= currentStory.price;
                updateUncBalance();
            }
            
            showNotification('📚 已加入: ' + currentStory.name);
        }

        function filterStories(category) {
            // 更新过滤标签
            document.querySelectorAll('.filter-tag').forEach(tag => {
                tag.classList.remove('active');
            });
            event.target.classList.add('active');
            
            showNotification('🔍 已过滤: ' + category);
        }

        // 创建故事相关变量
        let currentStoryData = {
            title: '',
            description: '',
            type: '',
            locations: [],
            surprises: [],
            collaborators: []
        };

        function startStoryCreation() {
            document.getElementById('createStoryMenu').style.display = 'none';
            document.getElementById('storyCreationInterface').style.display = 'block';
            showNotification('🎨 开始创建故事...');
        }

        function backToCreateMenu() {
            document.getElementById('storyCreationInterface').style.display = 'none';
            document.getElementById('createStoryMenu').style.display = 'block';
        }

        // 地点管理
        function showAddLocationModal() {
            document.getElementById('addLocationModal').classList.add('active');
        }

        function closeAddLocationModal() {
            document.getElementById('addLocationModal').classList.remove('active');
            // 清空表单
            document.getElementById('locationNameInput').value = '';
            document.getElementById('locationTypeSelect').value = 'restaurant';
            document.getElementById('locationDescriptionInput').value = '';
            document.getElementById('locationTimeInput').value = '';
            document.getElementById('locationCommentInput').value = '';
        }

        function addLocation() {
            const name = document.getElementById('locationNameInput').value;
            const type = document.getElementById('locationTypeSelect').value;
            const description = document.getElementById('locationDescriptionInput').value;
            const time = document.getElementById('locationTimeInput').value;
            const comment = document.getElementById('locationCommentInput').value;

            if (!name || !description) {
                showNotification('❌ 请填写地点名称和描述');
                return;
            }

            const location = {
                id: 'loc_' + Date.now(),
                name,
                type,
                description,
                time,
                comment,
                emoji: getLocationEmoji(type)
            };

            currentStoryData.locations.push(location);
            renderLocationsList();
            closeAddLocationModal();
            showNotification('✅ 地点添加成功！');
        }

        function getLocationEmoji(type) {
            const emojiMap = {
                restaurant: '🍜',
                attraction: '🏛️',
                museum: '🏛️',
                park: '🌳',
                shopping: '🛍️',
                culture: '🎭',
                nature: '🏔️',
                other: '📍'
            };
            return emojiMap[type] || '📍';
        }

        function renderLocationsList() {
            const container = document.getElementById('locationsList');
            if (currentStoryData.locations.length === 0) {
                container.innerHTML = '<div style="color: rgba(255,255,255,0.5);">点击"添加地点"开始创建你的路线</div>';
                return;
            }

            container.innerHTML = currentStoryData.locations.map(location => `
                <div class="location-item">
                    <div class="item-header">
                        <div class="item-title">
                            ${location.emoji} ${location.name}
                            <span class="item-badge">${location.type}</span>
                        </div>
                        <div class="item-actions">
                            <button class="btn-edit" onclick="editLocation('${location.id}')">编辑</button>
                            <button class="btn-delete" onclick="deleteLocation('${location.id}')">删除</button>
                        </div>
                    </div>
                    <div class="item-details">
                        <div>${location.description}</div>
                        ${location.time ? `<div style="margin-top: 5px; color: #fbbf24;">⏱️ ${location.time}</div>` : ''}
                        ${location.comment ? `<div style="margin-top: 5px; font-style: italic;">💬 ${location.comment}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function deleteLocation(id) {
            if (confirm('确定要删除这个地点吗？')) {
                currentStoryData.locations = currentStoryData.locations.filter(loc => loc.id !== id);
                renderLocationsList();
                showNotification('🗑️ 地点已删除');
            }
        }

        // 惊喜管理
        function showAddSurpriseModal() {
            document.getElementById('addSurpriseModal').classList.add('active');
        }

        function closeAddSurpriseModal() {
            document.getElementById('addSurpriseModal').classList.remove('active');
            // 清空表单
            document.getElementById('surpriseTypeSelect').value = 'npc';
            document.getElementById('surpriseDescriptionInput').value = '';
            document.getElementById('surpriseInviteInput').value = '';
            document.getElementById('surpriseRewardInput').value = '20';
            updateSurpriseOptions();
        }

        function updateSurpriseOptions() {
            const type = document.getElementById('surpriseTypeSelect').value;
            const npcOptions = document.getElementById('npcOptions');
            const celebrityOptions = document.getElementById('celebrityOptions');

            if (type === 'celebrity') {
                npcOptions.style.display = 'none';
                celebrityOptions.style.display = 'block';
            } else if (type === 'npc') {
                npcOptions.style.display = 'block';
                celebrityOptions.style.display = 'none';
            } else {
                npcOptions.style.display = 'none';
                celebrityOptions.style.display = 'none';
            }
        }

        function addSurprise() {
            const type = document.getElementById('surpriseTypeSelect').value;
            const description = document.getElementById('surpriseDescriptionInput').value;
            const inviteMessage = document.getElementById('surpriseInviteInput').value;
            const reward = document.getElementById('surpriseRewardInput').value;

            if (!description) {
                showNotification('❌ 请填写惊喜描述');
                return;
            }

            let character = '';
            if (type === 'npc') {
                character = document.getElementById('npcSelect').value;
            } else if (type === 'celebrity') {
                character = document.getElementById('celebritySelect').value;
            }

            const surprise = {
                id: 'surprise_' + Date.now(),
                type,
                character,
                description,
                inviteMessage,
                reward: parseInt(reward),
                emoji: getSurpriseEmoji(type)
            };

            currentStoryData.surprises.push(surprise);
            renderSurprisesList();
            closeAddSurpriseModal();
            showNotification('🎭 惊喜添加成功！');
        }

        function getSurpriseEmoji(type) {
            const emojiMap = {
                npc: '🎭',
                celebrity: '⭐',
                special_event: '🎉',
                hidden_treasure: '💎',
                custom: '🎨'
            };
            return emojiMap[type] || '🎭';
        }

        function renderSurprisesList() {
            const container = document.getElementById('surprisesList');
            if (currentStoryData.surprises.length === 0) {
                container.innerHTML = '<div style="color: rgba(255,255,255,0.5);">点击"添加惊喜"为你的故事增加趣味</div>';
                return;
            }

            container.innerHTML = currentStoryData.surprises.map(surprise => `
                <div class="surprise-item">
                    <div class="item-header">
                        <div class="item-title">
                            ${surprise.emoji} ${getSurpriseTitle(surprise)}
                            <span class="item-badge">${surprise.reward} UNC</span>
                        </div>
                        <div class="item-actions">
                            <button class="btn-edit" onclick="editSurprise('${surprise.id}')">编辑</button>
                            <button class="btn-delete" onclick="deleteSurprise('${surprise.id}')">删除</button>
                        </div>
                    </div>
                    <div class="item-details">
                        <div>${surprise.description}</div>
                        ${surprise.inviteMessage ? `<div style="margin-top: 5px; font-style: italic;">💬 ${surprise.inviteMessage}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function getSurpriseTitle(surprise) {
            if (surprise.type === 'npc') {
                const npcNames = {
                    local_guide: '当地向导',
                    historian: '历史学家',
                    chef: '名厨',
                    artist: '艺术家',
                    musician: '音乐家',
                    custom_npc: '自定义NPC'
                };
                return npcNames[surprise.character] || 'NPC互动';
            } else if (surprise.type === 'celebrity') {
                const celebNames = {
                    jackie_chan: '成龙',
                    zhang_yimou: '张艺谋',
                    liu_yifei: '刘亦菲',
                    wu_jing: '吴京',
                    yang_mi: '杨幂',
                    custom_celeb: '自定义明星'
                };
                return celebNames[surprise.character] || '明星见面';
            }
            return '惊喜互动';
        }

        function deleteSurprise(id) {
            if (confirm('确定要删除这个惊喜吗？')) {
                currentStoryData.surprises = currentStoryData.surprises.filter(surprise => surprise.id !== id);
                renderSurprisesList();
                showNotification('🗑️ 惊喜已删除');
            }
        }

        // 协作管理
        function showInviteModal() {
            document.getElementById('inviteModal').classList.add('active');
        }

        function closeInviteModal() {
            document.getElementById('inviteModal').classList.remove('active');
            // 清空表单
            document.getElementById('friendUsernameInput').value = '';
            document.getElementById('collaboratorRoleSelect').value = 'co_creator';
            document.getElementById('inviteMessageInput').value = '';
        }

        function sendInvite() {
            const username = document.getElementById('friendUsernameInput').value;
            const role = document.getElementById('collaboratorRoleSelect').value;
            const message = document.getElementById('inviteMessageInput').value;

            if (!username) {
                showNotification('❌ 请输入好友用户名');
                return;
            }

            const collaborator = {
                id: 'collab_' + Date.now(),
                username,
                role,
                message,
                status: 'pending',
                permissions: {
                    edit: document.getElementById('permissionEdit').checked,
                    addPOI: document.getElementById('permissionAddPOI').checked,
                    addSurprise: document.getElementById('permissionAddSurprise').checked,
                    publish: document.getElementById('permissionPublish').checked
                }
            };

            currentStoryData.collaborators.push(collaborator);
            renderCollaboratorsList();
            closeInviteModal();
            showNotification('🤝 邀请已发送！');
        }

        function renderCollaboratorsList() {
            const container = document.getElementById('collaboratorsList');
            if (currentStoryData.collaborators.length === 0) {
                container.innerHTML = '<div style="color: rgba(255,255,255,0.5);">点击"邀请好友"开始协作创作</div>';
                return;
            }

            container.innerHTML = currentStoryData.collaborators.map(collaborator => `
                <div class="collaborator-item">
                    <div class="item-header">
                        <div class="item-title">
                            👤 ${collaborator.username}
                            <span class="item-badge">${getRoleName(collaborator.role)}</span>
                        </div>
                        <div class="item-actions">
                            <button class="btn-delete" onclick="removeCollaborator('${collaborator.id}')">移除</button>
                        </div>
                    </div>
                    <div class="item-details">
                        <div>状态: ${collaborator.status === 'pending' ? '⏳ 等待回复' : '✅ 已接受'}</div>
                        ${collaborator.message ? `<div style="margin-top: 5px; font-style: italic;">💬 ${collaborator.message}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function getRoleName(role) {
            const roleNames = {
                co_creator: '共创者',
                contributor: '贡献者',
                assistant: '协助者'
            };
            return roleNames[role] || '未知';
        }

        function removeCollaborator(id) {
            if (confirm('确定要移除这个共创者吗？')) {
                currentStoryData.collaborators = currentStoryData.collaborators.filter(collab => collab.id !== id);
                renderCollaboratorsList();
                showNotification('👋 共创者已移除');
            }
        }

        // 发布故事
        function publishStory() {
            const title = document.getElementById('storyTitleInput').value;
            const description = document.getElementById('storyDescriptionInput').value;
            const type = document.getElementById('storyTypeSelect').value;

            if (!title || !description) {
                showNotification('❌ 请填写故事标题和描述');
                return;
            }

            if (currentStoryData.locations.length === 0) {
                showNotification('❌ 请至少添加一个地点');
                return;
            }

            // 保存故事数据
            currentStoryData.title = title;
            currentStoryData.description = description;
            currentStoryData.type = type;

            // 这里可以添加保存到服务器的逻辑
            showNotification('🚀 故事发布成功！获得 50 UNC');
            uncBalance += 50;
            updateUncBalance();

            // 重置界面
            backToCreateMenu();
            currentStoryData = {
                title: '',
                description: '',
                type: '',
                locations: [],
                surprises: [],
                collaborators: []
            };
        }

        function inviteCollaborators() {
            showNotification('👥 邀请共创者功能开发中...');
        }

        function updateUncBalance() {
            document.getElementById('uncBalance').textContent = uncBalance + ' UNC';
        }

        function showNotification(text) {
            const notification = document.getElementById('notification');
            document.getElementById('notificationText').textContent = text;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // 搜索功能
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            if (searchTerm.length > 0) {
                showNotification('🔍 搜索: ' + searchTerm);
            }
        });

                 function updateMapProgress() {
             const progress = (completedPOIs.size / 5) * 100;
             const progressBar = document.getElementById('mapProgress');
             const progressText = document.getElementById('progressText');
             
             if (progressBar && progressText) {
                 progressBar.style.width = progress + '%';
                 progressText.textContent = `${completedPOIs.size}/5 点位已完成`;
                 
                 // 根据进度改变颜色
                 if (progress === 100) {
                     progressBar.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                 } else if (progress >= 60) {
                     progressBar.style.background = 'linear-gradient(135deg, #fbbf24, #f59e0b)';
                 }
             }
         }

         // 新的旅行表单处理函数
         function submitTravelForm() {
             // 获取表单数据
             const destination = document.getElementById('destinationSelect').value;
             const duration = document.getElementById('durationSelect').value;
             const food = document.getElementById('foodSelect').value;
             const atmosphere = document.getElementById('atmosphereSelect').value;
             const companion = document.getElementById('companionSelect').value;
             const budget = document.getElementById('budgetSelect').value;
             
             // 验证是否所有字段都已填写
             if (!destination || !duration || !food || !atmosphere || !companion || !budget) {
                 showNotification('❌ 请填写所有必填项！');
                 return;
             }
             
             // 保存表单数据
             travelFormData = {
                 destination,
                 duration,
                 food,
                 atmosphere,
                 companion,
                 budget
             };
             
             // 隐藏表单，显示聊天界面
             document.getElementById('travelForm').style.display = 'none';
             document.getElementById('chatContainer').style.display = 'block';
             
             // 开始AI交互
             startAIInteraction();
         }

         function startAIInteraction() {
             // 显示AI欢迎消息
             setTimeout(() => {
                 addMessage("🎯 我已经收到你的旅行规划表！让我为你分析一下：", 'ai');
                 
                 setTimeout(() => {
                     // 显示表单数据总结
                     const summary = `
                         📋 <strong>你的旅行偏好总结：</strong><br>
                         🎯 目的地：${travelFormData.destination}<br>
                         📅 天数：${travelFormData.duration}<br>
                         🍜 美食：${travelFormData.food}<br>
                         🎭 氛围：${travelFormData.atmosphere}<br>
                         👥 同行：${travelFormData.companion}<br>
                         💰 预算：${travelFormData.budget}
                     `;
                     addMessage(summary, 'ai');
                     
                     setTimeout(() => {
                         addMessage("🤔 基于你的偏好，我为你推荐以下特色体验：", 'ai');
                         
                         setTimeout(() => {
                             // 根据目的地和偏好生成推荐
                             const recommendations = generateRecommendations(travelFormData);
                             addMessage(recommendations, 'ai');
                             
                             setTimeout(() => {
                                 addMessage("💬 现在你可以继续与我对话，询问更多细节，或者直接生成藏宝图！", 'ai');
                                 
                                 // 显示聊天输入界面
                                 document.getElementById('chatInputContainer').style.display = 'block';
                                 document.getElementById('chatInput').focus();
                             }, 1500);
                         }, 1500);
                     }, 2000);
                 }, 1500);
             }, 1000);
         }

         function generateRecommendations(formData) {
             const { destination, food, atmosphere, companion } = formData;
             
             let recommendations = "🌟 <strong>个性化推荐：</strong><br>";
             
             // 根据目的地生成推荐
             if (destination === '东京') {
                 recommendations += "🍜 必吃：拉面、寿司、天妇罗<br>";
                 recommendations += "🎭 必玩：浅草寺、秋叶原、涩谷<br>";
                 recommendations += "🛍️ 必逛：银座、新宿、原宿<br>";
             } else if (destination === '巴黎') {
                 recommendations += "🍷 必吃：法式面包、马卡龙、红酒<br>";
                 recommendations += "🎨 必玩：卢浮宫、埃菲尔铁塔、凯旋门<br>";
                 recommendations += "💕 必逛：香榭丽舍大街、蒙马特高地<br>";
             } else if (destination === '京都') {
                 recommendations += "🍵 必吃：抹茶、怀石料理、和果子<br>";
                 recommendations += "⛩️ 必玩：金阁寺、清水寺、岚山竹林<br>";
                 recommendations += "🎎 必逛：祗园、二年坂、三年坂<br>";
             } else {
                 recommendations += "🍽️ 当地特色美食<br>";
                 recommendations += "🏛️ 历史文化景点<br>";
                 recommendations += "🌅 绝美观景点<br>";
             }
             
             // 根据美食偏好添加推荐
             if (food === '米其林餐厅') {
                 recommendations += "⭐ 推荐预订米其林星级餐厅<br>";
             } else if (food === '街边小吃') {
                 recommendations += "🍡 推荐探索当地夜市和小吃街<br>";
             }
             
             // 根据氛围添加推荐
             if (atmosphere === '浪漫') {
                 recommendations += "💕 特别推荐情侣专属体验<br>";
             } else if (atmosphere === '历史') {
                 recommendations += "📚 推荐深度文化体验<br>";
             }
             
             return recommendations;
         }

         // 聊天交互功能
         function handleChatInput(event) {
             if (event.key === 'Enter') {
                 sendChatMessage();
             }
         }

         function sendChatMessage() {
             const input = document.getElementById('chatInput');
             const message = input.value.trim();
             
             if (message === '') return;
             
             // 添加用户消息
             addMessage(message, 'user');
             input.value = '';
             
             // 模拟AI响应
             setTimeout(() => {
                 const aiResponse = generateAIResponse(message);
                 addMessage(aiResponse, 'ai');
             }, 1000);
         }

         function sendSuggestion(suggestion) {
             const input = document.getElementById('chatInput');
             input.value = suggestion;
             sendChatMessage();
         }

         function generateAIResponse(userMessage) {
             const lowerMessage = userMessage.toLowerCase();
             
             // 检查是否要生成藏宝图
             if (lowerMessage.includes('生成藏宝图') || lowerMessage.includes('藏宝图') || lowerMessage.includes('地图')) {
                 setTimeout(() => {
                     addMessage("🎉 太棒了！现在让我为你生成专属藏宝图...", 'ai');
                     
                     setTimeout(() => {
                         addMessage("🗺️ 你的专属藏宝图已生成！点击发光点位进行打卡，完成旅程获得丰厚奖励！", 'ai');
                         generateTreasureMapFromForm();
                         
                         // 隐藏聊天输入界面
                         document.getElementById('chatInputContainer').style.display = 'none';
                     }, 1500);
                 }, 1000);
                 
                 return "🗺️ 正在为你生成专属藏宝图，请稍候...";
             }
             
             // 根据用户消息生成相应回复
             if (lowerMessage.includes('美食') || lowerMessage.includes('吃') || lowerMessage.includes('餐厅')) {
                 return generateFoodRecommendations();
             } else if (lowerMessage.includes('景点') || lowerMessage.includes('玩') || lowerMessage.includes('观光')) {
                 return generateAttractionRecommendations();
             } else if (lowerMessage.includes('预算') || lowerMessage.includes('价格') || lowerMessage.includes('费用')) {
                 return generateBudgetAdvice();
             } else if (lowerMessage.includes('交通') || lowerMessage.includes('地铁') || lowerMessage.includes('公交')) {
                 return generateTransportationAdvice();
             } else if (lowerMessage.includes('住宿') || lowerMessage.includes('酒店') || lowerMessage.includes('住')) {
                 return generateAccommodationAdvice();
             } else {
                 return generateGeneralAdvice();
             }
         }

         function generateFoodRecommendations() {
             const { destination, food } = travelFormData;
             let response = "🍜 <strong>美食推荐：</strong><br>";
             
             if (destination === '东京') {
                 response += "🍣 寿司：推荐筑地市场或银座的高级寿司店<br>";
                 response += "🍜 拉面：一兰拉面、一风堂都是经典选择<br>";
                 response += "🍡 小吃：浅草寺附近的传统小吃街<br>";
                 if (food === '米其林餐厅') {
                     response += "⭐ 米其林推荐：数寄屋桥次郎、龙吟<br>";
                 }
             } else if (destination === '巴黎') {
                 response += "🥐 法式面包：推荐当地面包店<br>";
                 response += "🍷 红酒：波尔多或勃艮第产区<br>";
                 response += "🍰 甜点：马卡龙、可颂、法式塔<br>";
                 if (food === '米其林餐厅') {
                     response += "⭐ 米其林推荐：L'Arpège、Le Meurice<br>";
                 }
             } else {
                 response += "🍽️ 当地特色餐厅<br>";
                 response += "🍡 街边小吃和夜市<br>";
                 response += "☕ 特色咖啡馆<br>";
             }
             
             return response;
         }

         function generateAttractionRecommendations() {
             const { destination, atmosphere } = travelFormData;
             let response = "🏛️ <strong>景点推荐：</strong><br>";
             
             if (destination === '东京') {
                 response += "⛩️ 浅草寺：感受传统日本文化<br>";
                 response += "🎮 秋叶原：动漫和电子产品天堂<br>";
                 response += "🛍️ 涩谷：时尚购物和年轻人聚集地<br>";
                 if (atmosphere === '浪漫') {
                     response += "💕 东京塔：情侣必去的浪漫地标<br>";
                 }
             } else if (destination === '巴黎') {
                 response += "🗼 埃菲尔铁塔：巴黎标志性建筑<br>";
                 response += "🎨 卢浮宫：世界级艺术博物馆<br>";
                 response += "⛪ 圣母院：哥特式建筑杰作<br>";
                 if (atmosphere === '浪漫') {
                     response += "💕 塞纳河游船：浪漫的河畔体验<br>";
                 }
             } else {
                 response += "🏛️ 历史文化景点<br>";
                 response += "🌅 自然风光和观景点<br>";
                 response += "🎭 当地文化体验<br>";
             }
             
             return response;
         }

         function generateBudgetAdvice() {
             const { budget } = travelFormData;
             let response = "💰 <strong>预算建议：</strong><br>";
             
             if (budget === '经济型') {
                 response += "🏠 住宿：选择青年旅社或经济型酒店<br>";
                 response += "🍜 餐饮：街边小吃和当地餐厅<br>";
                 response += "🚇 交通：公共交通和步行<br>";
                 response += "💡 建议：提前预订，避开旺季<br>";
             } else if (budget === '舒适型') {
                 response += "🏨 住宿：中档酒店或精品民宿<br>";
                 response += "🍽️ 餐饮：特色餐厅和当地美食<br>";
                 response += "🚕 交通：地铁为主，偶尔打车<br>";
                 response += "💡 建议：平衡体验和预算<br>";
             } else if (budget === '奢华') {
                 response += "🏰 住宿：豪华酒店或度假村<br>";
                 response += "⭐ 餐饮：米其林餐厅和高级料理<br>";
                 response += "🚁 交通：专车服务和直升机体验<br>";
                 response += "💡 建议：享受顶级服务和体验<br>";
             }
             
             return response;
         }

         function generateTransportationAdvice() {
             const { destination } = travelFormData;
             let response = "🚇 <strong>交通建议：</strong><br>";
             
             if (destination === '东京') {
                 response += "🚇 地铁：东京地铁网络发达，推荐购买一日券<br>";
                 response += "🚄 新干线：连接主要城市<br>";
                 response += "🚌 公交：补充地铁网络<br>";
                 response += "💡 建议：下载东京地铁APP<br>";
             } else if (destination === '巴黎') {
                 response += "🚇 地铁：巴黎地铁覆盖全城<br>";
                 response += "🚌 公交：补充地铁网络<br>";
                 response += "🚲 自行车：探索城市的好方式<br>";
                 response += "💡 建议：购买巴黎交通卡<br>";
             } else {
                 response += "🚇 公共交通：地铁、公交<br>";
                 response += "🚕 出租车：便捷但较贵<br>";
                 response += "🚲 自行车：环保出行<br>";
                 response += "💡 建议：根据距离选择合适交通<br>";
             }
             
             return response;
         }

         function generateAccommodationAdvice() {
             const { budget, atmosphere } = travelFormData;
             let response = "🏨 <strong>住宿建议：</strong><br>";
             
             if (budget === '经济型') {
                 response += "🏠 青年旅社：经济实惠，社交氛围好<br>";
                 response += "🏨 经济型酒店：干净舒适<br>";
                 response += "🏡 民宿：体验当地生活<br>";
             } else if (budget === '舒适型') {
                 response += "🏨 精品酒店：服务好，位置佳<br>";
                 response += "🏰 度假村：设施完善<br>";
                 response += "🏡 高端民宿：私密性好<br>";
             } else if (budget === '奢华') {
                 response += "🏰 豪华酒店：顶级服务和设施<br>";
                 response += "🏖️ 度假村：全包式体验<br>";
                 response += "🏡 私人别墅：专属服务<br>";
             }
             
             if (atmosphere === '浪漫') {
                 response += "💕 推荐：选择有浪漫氛围的住宿<br>";
             }
             
             return response;
         }

         function generateGeneralAdvice() {
             const { destination, duration } = travelFormData;
             let response = "💡 <strong>旅行建议：</strong><br>";
             
             response += `📅 你的${duration}天行程建议：<br>`;
             response += "📱 下载当地地图和翻译APP<br>";
             response += "💳 准备多种支付方式<br>";
             response += "📸 带上相机记录美好时光<br>";
             response += "🎒 轻装出行，舒适为主<br>";
             
             if (destination === '东京') {
                 response += "🇯🇵 学习几句简单的日语<br>";
             } else if (destination === '巴黎') {
                 response += "🇫🇷 学习几句简单的法语<br>";
             }
             
             return response;
         }

         function generateTreasureMapFromForm() {
             // 在聊天中添加游戏化藏宝图
             const mapMessage = document.createElement('div');
             mapMessage.className = 'message ai';
             mapMessage.innerHTML = `
                 <div class="message-avatar">🤖</div>
                 <div class="message-content">
                     <div class="treasure-map">
                         <div class="map-container">
                             <div style="position: relative; width: 100%; height: 100%;">
                                 <div class="poi-point" data-poi="poi1" style="top: 20%; left: 30%;" onclick="handlePOIClick('poi1')" title="🍜 美食街"></div>
                                 <div class="poi-label" style="top: 15%; left: 30%;">🍜 美食街</div>
                                 
                                 <div class="poi-point" data-poi="poi2" style="top: 40%; left: 60%;" onclick="handlePOIClick('poi2')" title="🏛️ 历史古迹"></div>
                                 <div class="poi-label" style="top: 35%; left: 60%;">🏛️ 历史古迹</div>
                                 
                                 <div class="poi-point" data-poi="poi3" style="top: 60%; left: 20%;" onclick="handlePOIClick('poi3')" title="🎭 文化体验"></div>
                                 <div class="poi-label" style="top: 55%; left: 20%;">🎭 文化体验</div>
                                 
                                 <div class="poi-point" data-poi="poi4" style="top: 80%; left: 70%;" onclick="handlePOIClick('poi4')" title="🌅 观景点"></div>
                                 <div class="poi-label" style="top: 75%; left: 70%;">🌅 观景点</div>
                                 
                                 <div class="poi-point" data-poi="poi5" style="top: 50%; left: 50%;" onclick="handlePOIClick('poi5')" title="🎪 隐藏宝藏"></div>
                                 <div class="poi-label" style="top: 45%; left: 50%;">🎪 隐藏宝藏</div>
                                 
                                 <div class="depth-indicator">🎮 3D地图</div>
                             </div>
                         </div>
                         
                         <div class="progress-bar" style="margin: 15px 0;">
                             <div class="progress-fill" id="mapProgress" style="width: 0%;"></div>
                         </div>
                         
                         <div style="text-align: center; margin-bottom: 15px; font-size: 14px; color: #fbbf24;">
                             <span id="progressText">0/5 点位已完成</span>
                         </div>
                         
                         <div class="map-controls">
                             <div class="map-btn active" onclick="switchMapView('all')">🗺️ 全部</div>
                             <div class="map-btn" onclick="switchMapView('completed')">✅ 已完成</div>
                             <div class="map-btn" onclick="switchMapView('remaining')">🎯 待完成</div>
                             <div class="map-btn" onclick="customizePOI()">⚙️ 自定义</div>
                             <div class="map-btn" onclick="toggleEditMode()">✏️ 编辑</div>
                         </div>
                         
                         <div class="poi-options" id="poiOptions" style="display: none;">
                             <div class="poi-option" onclick="replacePOI('restaurant')">🍽️ 餐厅</div>
                             <div class="poi-option" onclick="replacePOI('museum')">🏛️ 博物馆</div>
                             <div class="poi-option" onclick="replacePOI('park')">🌳 公园</div>
                             <div class="poi-option" onclick="replacePOI('shopping')">🛍️ 购物</div>
                             <div class="poi-option" onclick="replacePOI('entertainment')">🎮 娱乐</div>
                             <div class="poi-option" onclick="replacePOI('nature')">🏔️ 自然</div>
                         </div>
                         
                         <!-- 地图编辑模式 -->
                         <div class="map-edit-mode" id="mapEditMode" style="display: none;">
                             <div class="edit-controls">
                                 <button class="edit-btn" onclick="editPOI()">✏️ 编辑点位</button>
                                 <button class="edit-btn secondary" onclick="addNewPOI()">➕ 添加点位</button>
                                 <button class="edit-btn danger" onclick="deletePOI()">🗑️ 删除点位</button>
                                 <button class="edit-btn" onclick="saveMapChanges()">💾 保存更改</button>
                             </div>
                             
                             <div class="poi-editor" id="poiEditor">
                                 <input type="text" id="poiNameInput" placeholder="点位名称" />
                                 <textarea id="poiDescriptionInput" placeholder="点位描述"></textarea>
                                 <div style="display: flex; gap: 10px;">
                                     <button class="edit-btn" onclick="savePOIEdit()">保存</button>
                                     <button class="edit-btn secondary" onclick="cancelPOIEdit()">取消</button>
                                 </div>
                             </div>
                         </div>
                     </div>
                 </div>
             `;
             
             document.getElementById('chatContainer').appendChild(mapMessage);
             
             // 完成奖励
             uncBalance += 25;
             updateUncBalance();
             showNotification('+25 UNC 完成奖励！');
         }

         // 全局变量
         let isEditMode = false;
         let selectedPOIForEdit = null;
         let poiData = {
             'poi1': { emoji: '🍜', name: '美食街', description: '发现当地特色美食' },
             'poi2': { emoji: '🏛️', name: '历史古迹', description: '探索历史文化遗迹' },
             'poi3': { emoji: '🎭', name: '文化体验', description: '体验当地文化活动' },
             'poi4': { emoji: '🌅', name: '观景点', description: '欣赏绝美风景' },
             'poi5': { emoji: '🎪', name: '隐藏宝藏', description: '发现神秘宝藏' }
         };

         // POI点击处理函数
         function handlePOIClick(poiId) {
             if (isEditMode) {
                 // 编辑模式下，选择点位进行编辑
                 selectPOIForEdit(poiId);
             } else if (completedPOIs.has(poiId)) {
                 // 已完成点位，显示评论详情
                 showCommentsModal(poiId);
             } else {
                 // 正常打卡
                 checkIn(poiId);
             }
         }

         // 切换编辑模式
         function toggleEditMode() {
             isEditMode = !isEditMode;
             const editMode = document.getElementById('mapEditMode');
             const editBtn = event.target;
             const mapContainer = document.querySelector('.map-container');
             
             if (isEditMode) {
                 editMode.style.display = 'block';
                 editBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                 editBtn.textContent = '💾 保存';
                 
                 // 添加编辑模式视觉指示
                 if (mapContainer) {
                     mapContainer.style.border = '2px solid #fbbf24';
                     mapContainer.style.boxShadow = '0 0 20px rgba(251, 191, 36, 0.5)';
                 }
                 
                 showNotification('✏️ 已进入编辑模式，点击点位进行编辑或添加新点位');
             } else {
                 editMode.style.display = 'none';
                 editBtn.style.background = 'linear-gradient(135deg, #fbbf24, #f59e0b)';
                 editBtn.textContent = '✏️ 编辑';
                 
                 // 移除编辑模式视觉指示
                 if (mapContainer) {
                     mapContainer.style.border = '2px solid rgba(255, 255, 255, 0.2)';
                     mapContainer.style.boxShadow = '0 8px 32px rgba(0, 0, 0, 0.3)';
                 }
                 
                 // 隐藏编辑器
                 document.getElementById('poiEditor').classList.remove('active');
                 selectedPOIForEdit = null;
                 
                 showNotification('✅ 已退出编辑模式');
             }
         }

         // 选择点位进行编辑
         function selectPOIForEdit(poiId) {
             selectedPOIForEdit = poiId;
             const poi = poiData[poiId];
             
             // 移除之前的选择高亮
             document.querySelectorAll('.poi-point').forEach(point => {
                 point.style.border = '2px solid rgba(255, 255, 255, 0.3)';
                 point.style.transform = 'scale(1) translateZ(30px)';
             });
             
             // 高亮当前选择的点位
             const selectedPoint = document.querySelector(`[data-poi="${poiId}"]`);
             if (selectedPoint) {
                 selectedPoint.style.border = '3px solid #fbbf24';
                 selectedPoint.style.transform = 'scale(1.1) translateZ(35px)';
                 selectedPoint.style.boxShadow = '0 0 15px rgba(251, 191, 36, 0.8)';
             }
             
             // 填充编辑器
             document.getElementById('poiNameInput').value = poi.name;
             document.getElementById('poiDescriptionInput').value = poi.description;
             
             // 显示编辑器
             document.getElementById('poiEditor').classList.add('active');
             
             showNotification(`✏️ 正在编辑: ${poi.name}`);
         }

         // 保存POI编辑
         function savePOIEdit() {
             if (!selectedPOIForEdit) return;
             
             const name = document.getElementById('poiNameInput').value;
             const description = document.getElementById('poiDescriptionInput').value;
             
             if (!name.trim()) {
                 showNotification('❌ 请输入点位名称');
                 return;
             }
             
             // 更新数据
             poiData[selectedPOIForEdit].name = name;
             poiData[selectedPOIForEdit].description = description;
             
             // 更新UI
             const poiPoint = document.querySelector(`[data-poi="${selectedPOIForEdit}"]`);
             const poiLabel = poiPoint.nextElementSibling;
             
             poiPoint.setAttribute('title', `${poiData[selectedPOIForEdit].emoji} ${name}`);
             poiLabel.textContent = `${poiData[selectedPOIForEdit].emoji} ${name}`;
             
             // 重置视觉高亮
             poiPoint.style.border = '2px solid rgba(255, 255, 255, 0.3)';
             poiPoint.style.transform = 'scale(1) translateZ(30px)';
             poiPoint.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.3)';
             
             // 隐藏编辑器
             document.getElementById('poiEditor').classList.remove('active');
             selectedPOIForEdit = null;
             
             showNotification('✅ 点位信息已更新');
         }

         // 取消POI编辑
         function cancelPOIEdit() {
             // 重置视觉高亮
             if (selectedPOIForEdit) {
                 const poiPoint = document.querySelector(`[data-poi="${selectedPOIForEdit}"]`);
                 if (poiPoint) {
                     poiPoint.style.border = '2px solid rgba(255, 255, 255, 0.3)';
                     poiPoint.style.transform = 'scale(1) translateZ(30px)';
                     poiPoint.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.3)';
                 }
             }
             
             document.getElementById('poiEditor').classList.remove('active');
             selectedPOIForEdit = null;
             showNotification('❌ 已取消编辑');
         }

         // 添加新点位
         function addNewPOI() {
             // 显示添加点位的弹窗
             const addModal = document.getElementById('addPoiModal');
             if (addModal) {
                 addModal.classList.add('active');
                 // 清空输入框
                 document.getElementById('newPoiName').value = '';
                 document.getElementById('newPoiDescription').value = '';
                 document.getElementById('newPoiType').value = 'restaurant';
             } else {
                 showNotification('❌ 添加点位功能暂不可用');
             }
         }

         // 删除点位
         function deletePOI() {
             if (!selectedPOIForEdit) {
                 showNotification('❌ 请先选择要删除的点位');
                 return;
             }
             
             const poiName = poiData[selectedPOIForEdit].name;
             if (confirm(`确定要删除 "${poiName}" 吗？此操作不可撤销。`)) {
                 const poiPoint = document.querySelector(`[data-poi="${selectedPOIForEdit}"]`);
                 if (poiPoint) {
                     const poiLabel = poiPoint.nextElementSibling;
                     
                     poiPoint.remove();
                     if (poiLabel && poiLabel.classList.contains('poi-label')) {
                         poiLabel.remove();
                     }
                     
                     delete poiData[selectedPOIForEdit];
                     selectedPOIForEdit = null;
                     
                     // 隐藏编辑器
                     document.getElementById('poiEditor').classList.remove('active');
                     
                     showNotification(`🗑️ 点位 "${poiName}" 已删除`);
                     
                     // 奖励UNC
                     uncBalance += 5;
                     updateUncBalance();
                 } else {
                     showNotification('❌ 点位元素未找到');
                 }
             }
         }

         // 保存地图更改
         function saveMapChanges() {
             showNotification('💾 地图更改已保存');
             toggleEditMode();
         }

         // 显示分享弹窗
         function showShareModal(poiId) {
             const poi = poiData[poiId];
             if (!poi) return;
             
             // 更新弹窗内容
             document.getElementById('sharePoiEmoji').textContent = poi.emoji;
             document.getElementById('sharePoiName').textContent = poi.name;
             document.getElementById('sharePoiDescription').textContent = poi.description;
             
             // 清空输入框
             document.getElementById('shareContentInput').value = '';
             
             // 显示弹窗
             document.getElementById('poiShareModal').classList.add('active');
         }

         // 关闭分享弹窗
         function closeShareModal() {
             document.getElementById('poiShareModal').classList.remove('active');
         }

         // 关闭添加POI弹窗
         function closeAddPoiModal() {
             document.getElementById('addPoiModal').classList.remove('active');
         }

         // 保存新POI
         function saveNewPOI() {
             const type = document.getElementById('newPoiType').value;
             const name = document.getElementById('newPoiName').value.trim();
             const description = document.getElementById('newPoiDescription').value.trim();
             const x = parseInt(document.getElementById('newPoiX').value);
             const y = parseInt(document.getElementById('newPoiY').value);

             if (!name) {
                 showNotification('❌ 请输入点位名称');
                 return;
             }

             if (!description) {
                 showNotification('❌ 请输入点位描述');
                 return;
             }

             // POI类型映射
             const poiTypes = {
                 'restaurant': { emoji: '🍽️', name: '餐厅' },
                 'museum': { emoji: '🏛️', name: '博物馆' },
                 'park': { emoji: '🌳', name: '公园' },
                 'shopping': { emoji: '🛍️', name: '购物' },
                 'entertainment': { emoji: '🎮', name: '娱乐' },
                 'nature': { emoji: '🏔️', name: '自然' },
                 'cafe': { emoji: '☕', name: '咖啡厅' },
                 'landmark': { emoji: '🗼', name: '地标' },
                 'hotel': { emoji: '🏨', name: '酒店' },
                 'viewpoint': { emoji: '🌅', name: '观景点' }
             };

             const typeInfo = poiTypes[type];
             const newPoiId = 'poi_' + Date.now();

             // 创建新的POI元素
             const mapContainer = document.querySelector('.map-container');
             if (!mapContainer) {
                 showNotification('❌ 地图容器未找到');
                 return;
             }

             // 创建POI点
             const poiPoint = document.createElement('div');
             poiPoint.className = 'poi-point';
             poiPoint.setAttribute('data-poi', newPoiId);
             poiPoint.setAttribute('title', `${typeInfo.emoji} ${name}`);
             poiPoint.style.left = x + '%';
             poiPoint.style.top = y + '%';
             poiPoint.onclick = () => handlePOIClick(newPoiId);

             // 创建POI标签
             const poiLabel = document.createElement('div');
             poiLabel.className = 'poi-label';
             poiLabel.textContent = `${typeInfo.emoji} ${name}`;
             poiLabel.style.left = x + '%';
             poiLabel.style.top = (y - 30) + '%';

             // 添加到地图
             mapContainer.appendChild(poiPoint);
             mapContainer.appendChild(poiLabel);

             // 保存POI数据
             poiData[newPoiId] = {
                 emoji: typeInfo.emoji,
                 name: name,
                 description: description,
                 type: type,
                 x: x,
                 y: y
             };

             // 关闭弹窗并显示成功消息
             closeAddPoiModal();
             showNotification(`✅ 已添加新点位: ${name}`);
             
             // 奖励UNC
             uncBalance += 10;
             updateUncBalance();
         }

         // 分享到社交平台
         function shareToSocial(platform) {
             const content = document.getElementById('shareContentInput').value;
             const poiName = document.getElementById('sharePoiName').textContent;
             
             if (!content.trim()) {
                 showNotification('❌ 请输入分享内容');
                 return;
             }
             
             // 模拟分享
             const shareText = `我在${poiName}打卡了！${content}`;
             
             switch(platform) {
                 case 'wechat':
                     showNotification('💬 已分享到微信');
                     break;
                 case 'weibo':
                     showNotification('📱 已分享到微博');
                     break;
                 case 'douyin':
                     showNotification('🎵 已分享到抖音');
                     break;
                 case 'xiaohongshu':
                     showNotification('📖 已分享到小红书');
                     break;
             }
             
             // 奖励UNC
             uncBalance += 5;
             updateUncBalance();
             
             // 更新分享统计
             const views = parseInt(document.getElementById('shareViews').textContent) + Math.floor(Math.random() * 10) + 1;
             const likes = parseInt(document.getElementById('shareLikes').textContent) + Math.floor(Math.random() * 5) + 1;
             
             document.getElementById('shareViews').textContent = views;
             document.getElementById('shareLikes').textContent = likes;
             
             // 关闭弹窗
             closeShareModal();
         }

         // 显示POI评论弹窗
         function showCommentsModal(poiId) {
             const poi = poiData[poiId];
             if (!poi) return;
             
             currentPoiId = poiId;
             
             // 更新弹窗内容
             document.getElementById('poiDetailEmoji').textContent = poi.emoji;
             document.getElementById('poiDetailName').textContent = poi.name;
             document.getElementById('poiDetailDescription').textContent = poi.description;
             
             // 初始化评论数据（如果不存在）
             if (!poiCommentsData[poiId]) {
                 poiCommentsData[poiId] = {
                     comments: [],
                     visitors: Math.floor(Math.random() * 50) + 10,
                     rating: 0,
                     totalRating: 0,
                     ratingCount: 0
                 };
             }
             
             // 更新统计信息
             updatePoiStats(poiId);
             
             // 加载评论列表
             loadComments(poiId);
             
             // 显示弹窗
             document.getElementById('poiCommentsModal').classList.add('active');
         }

         // 关闭评论弹窗
         function closeCommentsModal() {
             document.getElementById('poiCommentsModal').classList.remove('active');
             currentPoiId = null;
             selectedRating = 0;
             
             // 重置评分星星
             document.querySelectorAll('.rating-stars .star').forEach(star => {
                 star.classList.remove('active');
             });
         }

         // 更新POI统计信息
         function updatePoiStats(poiId) {
             const data = poiCommentsData[poiId];
             if (!data) return;
             
             document.getElementById('poiVisitors').textContent = data.visitors;
             document.getElementById('poiRating').textContent = data.ratingCount > 0 ? (data.totalRating / data.ratingCount).toFixed(1) : '0.0';
             document.getElementById('poiComments').textContent = data.comments.length;
         }

         // 加载评论列表
         function loadComments(poiId) {
             const data = poiCommentsData[poiId];
             const commentsList = document.getElementById('commentsList');
             
             if (!data || data.comments.length === 0) {
                 commentsList.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">暂无评论，快来发表第一条评论吧！</div>';
                 return;
             }
             
             commentsList.innerHTML = data.comments.map(comment => `
                 <div class="comment-item">
                     <div class="comment-header">
                         <div class="comment-user">${comment.user}</div>
                         <div class="comment-rating-display">
                             ${'⭐'.repeat(comment.rating)}
                         </div>
                     </div>
                     <div class="comment-text">${comment.text}</div>
                     <div class="comment-time">${comment.time}</div>
                 </div>
             `).join('');
         }

         // 显示添加评论表单
         function showAddCommentForm() {
             document.getElementById('addCommentForm').style.display = 'block';
             document.getElementById('newCommentInput').focus();
         }

         // 隐藏添加评论表单
         function hideAddCommentForm() {
             document.getElementById('addCommentForm').style.display = 'none';
             document.getElementById('newCommentInput').value = '';
             selectedRating = 0;
             
             // 重置评分星星
             document.querySelectorAll('.rating-stars .star').forEach(star => {
                 star.classList.remove('active');
             });
         }

         // 提交评论
         function submitComment() {
             const commentText = document.getElementById('newCommentInput').value.trim();
             
             if (!commentText) {
                 showNotification('❌ 请输入评论内容');
                 return;
             }
             
             if (selectedRating === 0) {
                 showNotification('❌ 请选择评分');
                 return;
             }
             
             if (!currentPoiId || !poiCommentsData[currentPoiId]) {
                 showNotification('❌ 评论提交失败');
                 return;
             }
             
             // 创建新评论
             const newComment = {
                 user: userName,
                 text: commentText,
                 rating: selectedRating,
                 time: new Date().toLocaleString('zh-CN')
             };
             
             // 添加到评论数据
             poiCommentsData[currentPoiId].comments.unshift(newComment);
             poiCommentsData[currentPoiId].totalRating += selectedRating;
             poiCommentsData[currentPoiId].ratingCount += 1;
             poiCommentsData[currentPoiId].visitors += 1;
             
             // 更新UI
             updatePoiStats(currentPoiId);
             loadComments(currentPoiId);
             
             // 隐藏表单
             hideAddCommentForm();
             
             // 奖励UNC
             uncBalance += 3;
             updateUncBalance();
             
             showNotification('✅ 评论发布成功！获得 3 UNC');
         }

         // 初始化评分星星点击事件
         document.addEventListener('DOMContentLoaded', function() {
             // 评分星星点击事件
             document.addEventListener('click', function(e) {
                 if (e.target.classList.contains('star')) {
                     const rating = parseInt(e.target.dataset.rating);
                     selectedRating = rating;
                     
                     // 更新星星显示
                     document.querySelectorAll('.rating-stars .star').forEach((star, index) => {
                         if (index < rating) {
                             star.classList.add('active');
                         } else {
                             star.classList.remove('active');
                         }
                     });
                 }
             });
         });

         // 显示故事POI评论弹窗
         function showStoryPOIComments(poiId) {
             if (!currentStoryId) return;
             
             const story = stories[currentStoryId];
             const poi = story.route.find(p => p.id === poiId);
             if (!poi) return;
             
             currentPoiId = `story_${currentStoryId}_${poiId}`;
             
             // 更新弹窗内容
             document.getElementById('poiDetailEmoji').textContent = poi.emoji;
             document.getElementById('poiDetailName').textContent = poi.name;
             document.getElementById('poiDetailDescription').textContent = poi.description;
             
             // 初始化评论数据（如果不存在）
             if (!poiCommentsData[currentPoiId]) {
                 poiCommentsData[currentPoiId] = {
                     comments: [],
                     visitors: Math.floor(Math.random() * 30) + 5,
                     rating: 0,
                     totalRating: 0,
                     ratingCount: 0
                 };
             }
             
             // 更新统计信息
             updatePoiStats(currentPoiId);
             
             // 加载评论列表
             loadComments(currentPoiId);
             
             // 显示弹窗
             document.getElementById('poiCommentsModal').classList.add('active');
         }

         // 初始化
         updateUncBalance();
    </script>

    <!-- 添加地点模态框 -->
    <div class="modal" id="addLocationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h4>📍 添加地点</h4>
                <button class="close-modal" onclick="closeAddLocationModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>地点名称</label>
                    <input type="text" id="locationNameInput" placeholder="输入地点名称..." class="form-input">
                </div>
                <div class="form-group">
                    <label>地点类型</label>
                    <select id="locationTypeSelect" class="form-input">
                        <option value="restaurant">餐厅</option>
                        <option value="attraction">景点</option>
                        <option value="museum">博物馆</option>
                        <option value="park">公园</option>
                        <option value="shopping">购物</option>
                        <option value="culture">文化场所</option>
                        <option value="nature">自然景观</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>地点描述</label>
                    <textarea id="locationDescriptionInput" placeholder="描述这个地点的特色..." class="form-input" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>预计时间</label>
                    <input type="text" id="locationTimeInput" placeholder="例如：2小时" class="form-input">
                </div>
                <div class="form-group">
                    <label>地点评论</label>
                    <textarea id="locationCommentInput" placeholder="分享你对这个地点的感受..." class="form-input" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeAddLocationModal()">取消</button>
                <button class="btn-game" onclick="addLocation()">添加地点</button>
            </div>
        </div>
    </div>

    <!-- 添加惊喜模态框 -->
    <div class="modal" id="addSurpriseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h4>🎭 添加惊喜</h4>
                <button class="close-modal" onclick="closeAddSurpriseModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>惊喜类型</label>
                    <select id="surpriseTypeSelect" class="form-input" onchange="updateSurpriseOptions()">
                        <option value="npc">NPC互动</option>
                        <option value="celebrity">明星见面</option>
                        <option value="special_event">特别活动</option>
                        <option value="hidden_treasure">隐藏宝藏</option>
                        <option value="custom">自定义惊喜</option>
                    </select>
                </div>
                <div class="form-group" id="npcOptions">
                    <label>NPC角色</label>
                    <select id="npcSelect" class="form-input">
                        <option value="local_guide">当地向导</option>
                        <option value="historian">历史学家</option>
                        <option value="chef">名厨</option>
                        <option value="artist">艺术家</option>
                        <option value="musician">音乐家</option>
                        <option value="custom_npc">自定义NPC</option>
                    </select>
                </div>
                <div class="form-group" id="celebrityOptions" style="display: none;">
                    <label>明星选择</label>
                    <select id="celebritySelect" class="form-input">
                        <option value="jackie_chan">成龙</option>
                        <option value="zhang_yimou">张艺谋</option>
                        <option value="liu_yifei">刘亦菲</option>
                        <option value="wu_jing">吴京</option>
                        <option value="yang_mi">杨幂</option>
                        <option value="custom_celeb">自定义明星</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>惊喜描述</label>
                    <textarea id="surpriseDescriptionInput" placeholder="描述这个惊喜的内容..." class="form-input" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>邀请消息</label>
                    <textarea id="surpriseInviteInput" placeholder="邀请好友参与这个惊喜的消息..." class="form-input" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>奖励UNC</label>
                    <input type="number" id="surpriseRewardInput" placeholder="参与奖励" class="form-input" min="5" max="100" value="20">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeAddSurpriseModal()">取消</button>
                <button class="btn-game" onclick="addSurprise()">添加惊喜</button>
            </div>
        </div>
    </div>

    <!-- 邀请共创者模态框 -->
    <div class="modal" id="inviteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h4>🤝 邀请共创者</h4>
                <button class="close-modal" onclick="closeInviteModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>好友用户名</label>
                    <input type="text" id="friendUsernameInput" placeholder="输入好友用户名..." class="form-input">
                </div>
                <div class="form-group">
                    <label>协作角色</label>
                    <select id="collaboratorRoleSelect" class="form-input">
                        <option value="co_creator">共创者 (50%收益)</option>
                        <option value="contributor">贡献者 (25%收益)</option>
                        <option value="assistant">协助者 (10%收益)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>邀请消息</label>
                    <textarea id="inviteMessageInput" placeholder="给好友的邀请消息..." class="form-input" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>协作权限</label>
                    <div class="permissions-list">
                        <label class="permission-item">
                            <input type="checkbox" id="permissionEdit" checked> 编辑故事内容
                        </label>
                        <label class="permission-item">
                            <input type="checkbox" id="permissionAddPOI" checked> 添加地点
                        </label>
                        <label class="permission-item">
                            <input type="checkbox" id="permissionAddSurprise" checked> 添加惊喜
                        </label>
                        <label class="permission-item">
                            <input type="checkbox" id="permissionPublish"> 发布故事
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeInviteModal()">取消</button>
                <button class="btn-game" onclick="sendInvite()">发送邀请</button>
            </div>
        </div>
    </div>

</body>
</html> 